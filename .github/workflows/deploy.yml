# =============================================================================
# ğŸš€ VOC è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥ä½œæµ
# =============================================================================
# 
# è§¦å‘æ¡ä»¶ï¼š
# - push åˆ° main åˆ†æ”¯
# - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# éƒ¨ç½²æµç¨‹ï¼š
# 1. æ‹‰å–æœ€æ–°ä»£ç 
# 2. é€šè¿‡ SSH åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
# 3. åœ¨æœåŠ¡å™¨ä¸Šæ„å»ºå¹¶é‡å¯æœåŠ¡
#
# å¿…éœ€çš„ GitHub Secretsï¼š
# - SSH_PRIVATE_KEY: SSH ç§é’¥å†…å®¹
# - SERVER_A_IP: ä¸»æœåŠ¡å™¨ IP (115.191.30.209)
# - SERVER_B_IP: Worker æœåŠ¡å™¨ IP (115.190.185.29)
# - SERVER_USER: SSH ç”¨æˆ·å (root)
# - QWEN_API_KEY: é€šä¹‰åƒé—® API å¯†é’¥
# =============================================================================

name: ğŸš€ Deploy to Production

on:
  push:
    branches: 
      - main
    paths-ignore:
      - '.playwright-mcp/**'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'éƒ¨ç½²ç›®æ ‡'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - server-a
          - server-b

env:
  SERVER_A_PROJECT_DIR: /opt/voc
  SERVER_B_PROJECT_DIR: /opt/voc-worker

jobs:
  # ===========================================================================
  # ğŸ” ä»£ç æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
  # ===========================================================================
  lint:
    name: ğŸ” Code Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Python syntax
        run: |
          cd backend
          python -m py_compile app/main.py app/worker.py || echo "Python syntax check completed"

  # ===========================================================================
  # ğŸ–¥ï¸ éƒ¨ç½²åˆ°æœåŠ¡å™¨ A (ä¸»æœåŠ¡å™¨)
  # ===========================================================================
  deploy-server-a:
    name: ğŸ–¥ï¸ Deploy to Server A (Master)
    runs-on: ubuntu-latest
    needs: lint
    if: |
      github.event_name == 'push' || 
      github.event.inputs.deploy_target == 'all' || 
      github.event.inputs.deploy_target == 'server-a'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_A_IP }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Sync code to Server A
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env*' \
            --exclude 'postgres_data' \
            --exclude 'redis_data' \
            --exclude '.playwright-mcp' \
            --exclude '*.zip' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_A_IP }}:${{ env.SERVER_A_PROJECT_DIR }}/

      - name: ğŸ”§ Create .env file on Server A
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_A_IP }} << 'EOF'
          cat > ${{ env.SERVER_A_PROJECT_DIR }}/.env << 'ENVFILE'
          POSTGRES_USER=vocmaster
          POSTGRES_PASSWORD=vocmaster123
          POSTGRES_DB=vocmaster
          QWEN_API_KEY=${{ secrets.QWEN_API_KEY }}
          QWEN_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1
          ENVFILE
          EOF

      - name: ğŸ—ï¸ Build and restart services on Server A
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_A_IP }} << 'EOF'
          cd ${{ env.SERVER_A_PROJECT_DIR }}
          
          echo "ğŸ“¦ Building Docker images..."
          docker-compose -f docker-compose-master.yml build --parallel
          
          echo "ğŸ”„ Restarting services (graceful)..."
          # å…ˆé‡å¯åç«¯å’Œ Workerï¼Œä¿æŒæ•°æ®åº“è¿è¡Œ
          docker-compose -f docker-compose-master.yml up -d --force-recreate --no-deps app-backend worker-base worker-vip worker-trans
          
          # é‡å¯å‰ç«¯å’Œ Nginx
          docker-compose -f docker-compose-master.yml up -d --force-recreate --no-deps app-frontend nginx
          
          echo "âœ… Server A deployment completed!"
          docker-compose -f docker-compose-master.yml ps
          EOF

      - name: â¤ï¸ Health check Server A
        run: |
          echo "Waiting for services to start..."
          sleep 30
          
          echo "Checking Backend API..."
          curl -sf http://${{ secrets.SERVER_A_IP }}:8000/health || echo "Backend starting..."
          
          echo "Checking Frontend..."
          curl -sf http://${{ secrets.SERVER_A_IP }}:3000 -o /dev/null && echo "Frontend OK" || echo "Frontend starting..."

  # ===========================================================================
  # ğŸ”§ éƒ¨ç½²åˆ°æœåŠ¡å™¨ B (Worker èŠ‚ç‚¹)
  # ===========================================================================
  deploy-server-b:
    name: ğŸ”§ Deploy to Server B (Worker)
    runs-on: ubuntu-latest
    needs: deploy-server-a
    if: |
      github.event_name == 'push' || 
      github.event.inputs.deploy_target == 'all' || 
      github.event.inputs.deploy_target == 'server-b'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_B_IP }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Sync code to Server B
        run: |
          # Server B åªéœ€è¦ backend ä»£ç å’Œç›¸å…³é…ç½®
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env*' \
            --exclude '.playwright-mcp' \
            --exclude 'frontend' \
            --exclude 'extension' \
            --exclude 'nginx' \
            --exclude 'docs' \
            --exclude '*.zip' \
            --exclude '*.md' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_B_IP }}:${{ env.SERVER_B_PROJECT_DIR }}/

      - name: ğŸ”§ Create .env file on Server B
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_B_IP }} << 'EOF'
          cat > ${{ env.SERVER_B_PROJECT_DIR }}/.env << 'ENVFILE'
          MASTER_IP=${{ secrets.SERVER_A_IP }}
          POSTGRES_USER=vocmaster
          POSTGRES_PASSWORD=vocmaster123
          POSTGRES_DB=vocmaster
          QWEN_API_KEY=${{ secrets.QWEN_API_KEY }}
          QWEN_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1
          ENVFILE
          EOF

      - name: ğŸ—ï¸ Build and restart services on Server B
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_B_IP }} << 'EOF'
          cd ${{ env.SERVER_B_PROJECT_DIR }}
          
          echo "ğŸ“¦ Building Docker images..."
          docker-compose -f docker-compose-worker.yml build --parallel
          
          echo "ğŸ”„ Restarting all workers..."
          docker-compose -f docker-compose-worker.yml up -d --force-recreate
          
          echo "âœ… Server B deployment completed!"
          docker-compose -f docker-compose-worker.yml ps
          EOF

      - name: â¤ï¸ Verify workers registered
        run: |
          echo "Waiting for workers to register..."
          sleep 45
          
          echo "Checking Flower for worker registration..."
          WORKERS=$(curl -sf http://${{ secrets.SERVER_A_IP }}:5555/api/workers 2>/dev/null | grep -o '"[^"]*@[^"]*"' | wc -l || echo "0")
          echo "Registered workers: $WORKERS"

  # ===========================================================================
  # ğŸ“‹ éƒ¨ç½²å®Œæˆé€šçŸ¥
  # ===========================================================================
  notify:
    name: ğŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-server-a, deploy-server-b]
    if: always()
    
    steps:
      - name: ğŸ“Š Summary
        run: |
          echo "=============================================="
          echo "ğŸ‰ Deployment Summary"
          echo "=============================================="
          echo ""
          echo "ğŸŒ Frontend: http://${{ secrets.SERVER_A_IP }}:3000"
          echo "ğŸ”Œ API: http://${{ secrets.SERVER_A_IP }}:8000"
          echo "ğŸŒ¸ Flower: http://${{ secrets.SERVER_A_IP }}:5555"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
