# =============================================================================
# ğŸ–¥ï¸ æœåŠ¡å™¨ B (4æ ¸8G) - Worker èŠ‚ç‚¹é…ç½®
# =============================================================================
# 
# èŒè´£ï¼š
# - æ´å¯Ÿæå–ä¸“å‘˜ï¼ˆé«˜ PARALLEL_SIZEï¼‰
# - ä¸»é¢˜æå–ä¸“å‘˜ï¼ˆé«˜ PARALLEL_SIZEï¼‰
# - ç¿»è¯‘å¤‡ä»½ï¼ˆåˆ†æ‹…ä¸»æœåŠ¡å™¨å‹åŠ›ï¼‰
# - å…¨èƒ½å¤‡ä»½ï¼ˆåº”æ€¥æ”¯æ´ï¼‰
#
# éƒ¨ç½²å‰éœ€è¦ä¿®æ”¹ï¼š
# 1. MASTER_IPï¼šæœåŠ¡å™¨ A çš„ IP åœ°å€
# 2. ç¡®ä¿æœåŠ¡å™¨ A çš„ Redis å’Œ PostgreSQL ç«¯å£å¼€æ”¾
#
# éƒ¨ç½²ï¼šdocker-compose -f docker-compose-worker.yml up -d
# =============================================================================

# âš ï¸ é‡è¦ï¼šæœåŠ¡å™¨ A çš„ IP åœ°å€ï¼ˆä» .env æ–‡ä»¶è¯»å–ï¼‰
x-master-config: &master-config
  # MASTER_IP ä»ç¯å¢ƒå˜é‡è¯»å–
  MASTER_IP: &master-ip "${MASTER_IP:-115.191.30.209}"

services:
  # ==========================================================================
  # Worker 1: æ´å¯Ÿä¸“å‘˜ (Insight Extraction Worker)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼šinsight_extractionï¼ˆä¸“å±ï¼‰
  # æ¨¡å¼ï¼šGevent, 20 åç¨‹ (40K RPM ä¼˜åŒ–ï¼š10â†’20)
  # PARALLEL_SIZEï¼š120ï¼ˆé«˜å†…éƒ¨å¹¶è¡Œï¼Œ40K RPM ä¼˜åŒ–ï¼‰
  # èŒè´£ï¼šä¸“æ”»æ´å¯Ÿæå–ï¼Œç‰©ç†éš”ç¦»ç¿»è¯‘å¹²æ‰°
  worker-insight:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-insight
    restart: unless-stopped
    # ğŸ” [40K RPM] æ´å¯Ÿä¸“å‘˜ï¼šæå‡ Celery å¹¶å‘ + é«˜ PARALLEL_SIZE
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=20 -Q insight_extraction -n insight@%h
    environment:
      # âš ï¸ ä¿®æ”¹ä¸ºæœåŠ¡å™¨ A çš„å®é™… IP
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@${MASTER_IP:-192.168.1.100}:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://${MASTER_IP:-192.168.1.100}:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      # ğŸ”§ [40K RPM] æ´å¯Ÿä¸“ç”¨é…ç½® - æå‡å¹¶è¡Œåº¦
      - INSIGHT_PARALLEL_SIZE=120
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1.5G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d insight@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-worker-network

  # ==========================================================================
  # Worker 2: ä¸»é¢˜ä¸“å‘˜ (Theme Extraction Worker)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼štheme_extractionï¼ˆä¸“å±ï¼‰
  # æ¨¡å¼ï¼šGevent, 20 åç¨‹ (40K RPM ä¼˜åŒ–ï¼š10â†’20)
  # PARALLEL_SIZEï¼š150ï¼ˆé«˜å†…éƒ¨å¹¶è¡Œï¼Œ40K RPM ä¼˜åŒ–ï¼‰
  # èŒè´£ï¼šä¸“æ”»ä¸»é¢˜æå–ï¼ŒAPI å“åº”æ›´å¿«å¯æ›´é«˜å¹¶å‘
  worker-theme:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-theme
    restart: unless-stopped
    # ğŸ·ï¸ [40K RPM] ä¸»é¢˜ä¸“å‘˜ï¼šæå‡ Celery å¹¶å‘ + é«˜ PARALLEL_SIZE
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=20 -Q theme_extraction -n theme@%h
    environment:
      # âš ï¸ ä¿®æ”¹ä¸ºæœåŠ¡å™¨ A çš„å®é™… IP
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@${MASTER_IP:-192.168.1.100}:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://${MASTER_IP:-192.168.1.100}:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      # ğŸ”§ [40K RPM] ä¸»é¢˜ä¸“ç”¨é…ç½® - æå‡å¹¶è¡Œåº¦
      - THEME_PARALLEL_SIZE=150
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1.5G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d theme@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-worker-network

  # ==========================================================================
  # Worker 3: ç¿»è¯‘å¤‡ä»½ (Translation Worker 2)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼štranslationï¼ˆä¸æœåŠ¡å™¨ A å…±äº«ï¼‰
  # æ¨¡å¼ï¼šGevent, 80 åç¨‹ (40K RPM ä¼˜åŒ–ï¼š40â†’80)
  # èŒè´£ï¼šåˆ†æ‹…ç¿»è¯‘å‹åŠ›ï¼Œä¸ä¸»æœåŠ¡å™¨ååŒå¤„ç†
  worker-trans-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-trans-2
    restart: unless-stopped
    # ğŸ”„ [40K RPM] ç¿»è¯‘å¤‡ä»½ï¼šåˆ†æ‹…ä¸»æœåŠ¡å™¨å‹åŠ›
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=80 -Q translation -n trans2@%h
    environment:
      # âš ï¸ ä¿®æ”¹ä¸ºæœåŠ¡å™¨ A çš„å®é™… IP
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@${MASTER_IP:-192.168.1.100}:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://${MASTER_IP:-192.168.1.100}:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1.5G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d trans2@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-worker-network

  # ==========================================================================
  # Worker 4: å…¨èƒ½å¤‡ä»½ (Backup Worker)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼šlearning, insight_extraction, theme_extraction
  # æ¨¡å¼ï¼šGevent, 20 åç¨‹
  # èŒè´£ï¼šåº”æ€¥æ”¯æ´ï¼Œå¤„ç†æº¢å‡ºä»»åŠ¡
  worker-backup:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-backup
    restart: unless-stopped
    # ğŸ›¡ï¸ å…¨èƒ½å¤‡ä»½ï¼šæ”¯æ´æ‰€æœ‰ AI ä»»åŠ¡
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=20 -Q learning,insight_extraction,theme_extraction -n backup@%h
    environment:
      # âš ï¸ ä¿®æ”¹ä¸ºæœåŠ¡å™¨ A çš„å®é™… IP
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@${MASTER_IP:-192.168.1.100}:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://${MASTER_IP:-192.168.1.100}:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1.5G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d backup@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-worker-network

networks:
  voc-worker-network:
    driver: bridge
