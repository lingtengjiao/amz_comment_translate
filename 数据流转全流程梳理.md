# VOC-Master 数据流转全流程梳理

> **项目简介**: VOC-Master 是一个针对亚马逊商品评论(VOC - Voice of Customer)的深度分析系统,从爬取数据到最终生成智能报告的完整解决方案。

---

## 📊 整体架构概览

```
┌─────────────────┐
│  Chrome 插件    │ ← 用户在亚马逊商品页点击采集
└────────┬────────┘
         │ POST /api/v1/reviews/ingest
         ↓
┌─────────────────────────────────────────┐
│       FastAPI 后端 (app-backend)        │
│  ┌──────────────────────────────────┐  │
│  │ 1. 接收数据 (reviews.py)         │  │
│  │ 2. 存入 PostgreSQL               │  │
│  │ 3. 创建异步任务                  │  │
│  └──────────────┬───────────────────┘  │
└─────────────────┼───────────────────────┘
                  │
                  │ Celery Task Queue (Redis)
                  ↓
┌─────────────────────────────────────────┐
│      Celery Worker (app-worker)         │
│  ┌──────────────────────────────────┐  │
│  │ Task 1: 翻译五点和标题            │  │
│  │ Task 2: 翻译评论内容              │  │
│  │ Task 3: 提取洞察 (Insights)       │  │
│  │ Task 4: 提取5W主题 (Themes)       │  │
│  └──────────────┬───────────────────┘  │
└─────────────────┼───────────────────────┘
                  │ 调用 Qwen AI API
                  ↓
┌─────────────────────────────────────────┐
│    数据分析 & 报告生成模块               │
│  ┌──────────────────────────────────┐  │
│  │ 1. 聚合统计数据                   │  │
│  │ 2. 生成多角色报告 (CEO/CMO/...)  │  │
│  │ 3. 对比分析 (竞品对比)            │  │
│  └──────────────┬───────────────────┘  │
└─────────────────┼───────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│         React 前端控制台                 │
│  - 双语评论阅读                          │
│  - 数据可视化 (ECharts)                  │
│  - 报告下载 (Excel/PDF)                  │
└─────────────────────────────────────────┘
```

---

## 🔄 详细数据流转过程

### **阶段 1: 数据采集 (Chrome 插件)**

#### 1.1 用户操作
- 用户访问亚马逊商品页面 (如 `amazon.com/dp/B08ABC123`)
- 点击浏览器工具栏的 VOC-Master 图标
- 在弹出窗口中配置采集参数:
  - 选择星级 (1-5星 或 全部星级)
  - 设置采集数量 (默认50条)
- 点击"开始采集"按钮

#### 1.2 采集过程 (content.js)
**关键文件**: `extension/src/content/content.js`

**步骤**:
1. **检测产品信息**
   - 从页面 DOM 中提取产品信息:
     - ASIN (产品唯一标识符)
     - 标题 (`#productTitle`)
     - 图片 URL (`#landingImage`)
     - 平均评分 (`#acrPopover`)
     - 价格 (`#priceblock_ourprice`)
     - 五点卖点 (`#feature-bullets`)

2. **智能翻页采集评论**
   - 逐页加载评论列表 (模拟人类滚动)
   - 从每条评论 DOM 中提取:
     ```javascript
     {
       review_id: "R123ABC...",    // 评论唯一ID
       rating: 5,                   // 1-5星
       title: "Great product!",     // 标题
       body: "This is amazing...",  // 正文
       author: "John Doe",          // 作者名
       review_date: "2024-01-15",   // 评论日期
       verified_purchase: true,     // 是否认证购买
       helpful_votes: 12,           // 有用票数
       review_url: "https://..."    // 评论链接
     }
     ```

3. **防反爬机制**
   - 随机延迟 2-5秒 模拟人类行为
   - 检测验证码 (`#captchacharacters`)
   - 自动暂停/恢复采集

4. **实时进度反馈**
   - 在页面上显示浮层进度条
   - 实时更新: "已采集 45/50 (3星: 10, 4星: 20, 5星: 15)"

#### 1.3 数据提交
**API 端点**: `POST /api/v1/reviews/ingest`

**请求体**:
```json
{
  "asin": "B08ABC123",
  "title": "Wireless Headphones",
  "image_url": "https://m.media-amazon.com/...",
  "marketplace": "amazon.com",
  "average_rating": 4.3,
  "price": "$59.99",
  "bullet_points": [
    "Active Noise Cancellation",
    "40-hour battery life",
    "...5条卖点..."
  ],
  "reviews": [
    {
      "review_id": "R123ABC...",
      "rating": 5,
      "title": "Great product!",
      "body": "This is amazing...",
      "author": "John Doe",
      "review_date": "2024-01-15",
      "verified_purchase": true,
      "helpful_votes": 12,
      "review_url": "https://..."
    },
    // ...更多评论...
  ]
}
```

---

### **阶段 2: 数据接收与存储 (FastAPI 后端)**

#### 2.1 接收数据
**关键文件**: `backend/app/api/reviews.py` → `ingest_reviews()`

**步骤**:
1. **验证数据完整性**
   - 检查 `reviews` 数组是否为空
   - 如果为空 → 返回错误提示 (可能未登录亚马逊)

2. **创建/更新产品记录**
   ```python
   product = await service.get_or_create_product(
       asin=request.asin,
       title=request.title,
       image_url=request.image_url,
       marketplace=request.marketplace,
       average_rating=request.average_rating,
       price=request.price,
       bullet_points=json.dumps(request.bullet_points)  # 存储为JSON
   )
   ```
   - **表**: `products`
   - **字段**: `id`, `asin`, `title`, `image_url`, `marketplace`, `average_rating`, `price`, `bullet_points`, `created_at`

3. **批量插入评论**
   ```python
   inserted, skipped = await service.bulk_insert_reviews(
       product_id=product.id,
       reviews_data=reviews_data
   )
   ```
   - **表**: `reviews`
   - **去重逻辑**: 通过 `(product_id, review_id)` 唯一索引自动跳过重复评论
   - **字段**: `id`, `product_id`, `review_id`, `rating`, `title_original`, `body_original`, `author`, `review_date`, `verified_purchase`, `helpful_votes`, `review_url`, `translation_status` (初始为 `pending`)

4. **返回响应**
   ```json
   {
     "success": true,
     "message": "Received 50 reviews, 45 new, 5 duplicates skipped",
     "product_id": "550e8400-e29b-41d4-a716-446655440000",
     "task_id": null,
     "reviews_received": 45,
     "dashboard_url": "http://localhost:3000/products/B08ABC123"
   }
   ```

---

### **阶段 3: 异步翻译处理 (Celery Worker)**

> **触发方式**: 用户在前端控制台手动点击"开始翻译"按钮

#### 3.1 任务队列架构
- **消息队列**: Redis (作为 Celery Broker)
- **任务类型**: 4个独立任务 (按顺序执行)
- **关键文件**: `backend/app/worker.py`

#### 3.2 Task 1: 翻译产品五点和标题
**任务名称**: `task_translate_bullet_points`

**触发条件**: 
- 产品标题未翻译 (`title_translated` 为空)
- 或五点卖点未翻译 (`bullet_points_translated` 为空)

**处理流程**:
1. 调用 Qwen API 翻译标题:
   ```python
   translated_title = translation_service.translate_product_title(product.title)
   # 输入: "Wireless Bluetooth Headphones"
   # 输出: "无线蓝牙耳机"
   ```

2. 调用 Qwen API 翻译五点:
   ```python
   translated_bullets = translation_service.translate_bullet_points(bullet_points)
   # 输入: ["Active Noise Cancellation", "40-hour battery life"]
   # 输出: ["主动降噪功能", "40小时续航"]
   ```

3. 更新产品表:
   ```sql
   UPDATE products
   SET title_translated = '无线蓝牙耳机',
       bullet_points_translated = '["主动降噪功能", "40小时续航"]'
   WHERE id = 'product_uuid';
   ```

#### 3.3 Task 2: 翻译评论内容
**任务名称**: `task_process_reviews`

**处理流程**:
1. **查询待翻译评论**
   ```sql
   SELECT * FROM reviews
   WHERE product_id = 'product_uuid'
     AND translation_status IN ('pending', 'processing', 'failed')
   ORDER BY review_date DESC;
   ```

2. **逐条调用 Qwen API 翻译**
   ```python
   for review in reviews:
       # 标记为处理中
       review.translation_status = 'processing'
       
       # 调用AI翻译 (带情感分析)
       title_translated, body_translated, sentiment, _ = translation_service.translate_review(
           title=review.title_original,
           body=review.body_original,
           extract_insights=False  # 仅翻译,不提取洞察
       )
       
       # Qwen 返回示例:
       # title_translated: "很棒的产品!"
       # body_translated: "这款耳机音质超赞,降噪效果一流..."
       # sentiment: "positive" / "neutral" / "negative"
       
       # 更新数据库
       review.title_translated = title_translated
       review.body_translated = body_translated
       review.sentiment = sentiment
       review.translation_status = 'completed'
       
       # 更新任务进度
       task.processed_items += 1
       
       # 限速: 每条评论间隔 0.2秒
       time.sleep(0.2)
   ```

3. **错误处理**
   - 如果翻译失败 → 标记 `translation_status = 'failed'`
   - 记录错误信息到 `tasks` 表
   - 支持手动重试

4. **数据库字段更新**
   - `reviews` 表:
     - `title_translated`: 翻译后的标题
     - `body_translated`: 翻译后的正文
     - `sentiment`: `positive` / `neutral` / `negative`
     - `translation_status`: `completed`

#### 3.4 Task 3: 提取维度洞察 (Insights)
**任务名称**: `task_extract_insights`

**触发方式**: 用户在前端点击"提取洞察"按钮 → `POST /api/v1/products/{asin}/extract-insights`

**处理流程**:
1. **查询已翻译的评论** (不含洞察的评论)
   ```sql
   SELECT r.* FROM reviews r
   LEFT JOIN review_insights i ON r.id = i.review_id
   WHERE r.product_id = 'product_uuid'
     AND r.translation_status = 'completed'
     AND i.id IS NULL  -- 没有洞察
   ORDER BY r.review_date DESC;
   ```

2. **逐条调用 AI 提取洞察**
   ```python
   for review in reviews:
       # 调用 AI 提取洞察
       insights = translation_service.extract_insights(
           original_text=review.body_original,
           translated_text=review.body_translated,
           dimension_schema=dimension_schema  # 可选:产品维度定义
       )
       
       # AI 返回格式 (JSON数组):
       [
         {
           "type": "strength",           # 洞察类型 (5类)
           "dimension": "音质",          # 维度名称
           "quote": "sound quality is amazing",         # 原文引用
           "quote_translated": "音质超赞",              # 中文引用
           "analysis": "用户对音质表现非常满意"         # AI分析
         },
         {
           "type": "weakness",
           "dimension": "续航",
           "quote": "battery drains fast",
           "quote_translated": "电池耗电快",
           "analysis": "用户反馈续航不足"
         },
         {
           "type": "suggestion",
           "dimension": "颜色",
           "quote": "wish it came in more colors",
           "quote_translated": "希望有更多颜色",
           "analysis": "用户建议增加配色选择"
         }
       ]
   ```

3. **存入数据库** (`review_insights` 表)
   ```sql
   INSERT INTO review_insights (
     review_id, 
     insight_type,      -- strength/weakness/suggestion/scenario/emotion
     dimension,         -- 音质/续航/外观/...
     quote,             -- 原文引用
     quote_translated,  -- 中文引用
     analysis           -- AI分析
   ) VALUES (...);
   ```

**5类洞察类型说明**:
- `strength`: 产品优势/卖点 (用于 Listing 五点描述和广告文案)
- `weakness`: 改进空间/痛点 (用于产品改进和客服 QA)
- `suggestion`: 用户建议 (产品经理的 Feature Request 池)
- `scenario`: 具体使用场景 (发现边缘场景/营销素材)
- `emotion`: 强烈情感洞察 (客服和公关关注点)

#### 3.4 Task 3.5: 学习产品维度 (可选)
**任务名称**: 手动触发 (非 Celery 任务)

**触发方式**: 用户在前端点击"学习产品维度"按钮 → `POST /api/v1/products/{asin}/dimensions/generate`

> **注意**: 这是一个**可选步骤**,用于定义产品的核心评价维度。如果不执行此步骤,Task 3 的洞察提取会使用通用维度自动判断。

**处理流程**:
1. **采样评论数据 (优先已翻译)**
   ```python
   # 获取最近50条评论
   reviews = await db.execute(
       select(Review.body_original, Review.body_translated)
       .where(Review.product_id == product_id)
       .order_by(Review.created_at.desc())
       .limit(50)
   )
   
   # 准备样本文本 (优先使用翻译文本)
   sample_texts = []
   for row in reviews:
       text = row.body_translated or row.body_original
       sample_texts.append(text.strip())
   ```

2. **获取产品官方信息**
   ```python
   # 产品标题
   product_title = "Wireless Bluetooth Headphones"
   
   # 五点卖点
   bullet_points = [
       "Active Noise Cancellation",
       "40-hour battery life",
       "Comfortable over-ear design",
       "Bluetooth 5.0 connectivity",
       "Foldable and portable"
   ]
   ```

3. **调用 AI 学习维度**
   ```python
   learned_dims = translation_service.learn_dimensions(
       reviews_text=sample_texts,      # 50条评论样本
       product_title=product_title,    # 产品标题 (提供上下文)
       bullet_points=bullet_points     # 五点卖点 (补充产品特性)
   )
   ```

4. **AI 学习过程 (Qwen API Prompt)**
   ```
   你是一位资深的产品经理和用户研究专家。请基于以下产品官方信息和用户评论样本,
   构建该产品的核心评价维度模型。
   
   # 产品官方信息
   - 产品标题: Wireless Bluetooth Headphones
   - 核心卖点 (Bullet Points):
     1. Active Noise Cancellation
     2. 40-hour battery life
     3. Comfortable over-ear design
     4. Bluetooth 5.0 connectivity
     5. Foldable and portable
   
   # 用户评论样本 (50条)
   "音质超赞,降噪效果一流..."
   "电池续航不如宣传的那么久..."
   "佩戴很舒服,长时间使用不累..."
   ... (共50条)
   
   # 任务: 提炼出 5-8 个核心评价维度
   
   # 要求
   1. 结合官方定义与用户视角 (维度名称应尽量使用官方术语)
   2. 维度名称: 使用简练的中文 (如: 音质表现、续航能力、佩戴舒适度)
   3. 维度定义: 用一句话描述该维度包含的具体内容
   4. 互斥性: 维度之间不要重叠
   5. 覆盖率: 必须覆盖评论中的主要痛点和爽点
   
   # 输出格式 (JSON Only)
   {
     "dimensions": [
       {"name": "音质表现", "description": "包括音质清晰度、低音效果等听觉体验"},
       ...
     ]
   }
   ```

5. **AI 返回示例**
   ```json
   {
     "dimensions": [
       {
         "name": "音质表现",
         "description": "包括音质清晰度、低音效果、高音表现等听觉体验相关评价"
       },
       {
         "name": "降噪效果",
         "description": "主动降噪(ANC)的强度、环境音隔离能力等降噪功能表现"
       },
       {
         "name": "续航能力",
         "description": "电池使用时长、充电速度、待机时间等电池相关表现"
       },
       {
         "name": "佩戴舒适度",
         "description": "耳罩材质、头梁压力、长时间佩戴的舒适性等人体工学评价"
       },
       {
         "name": "连接稳定性",
         "description": "蓝牙连接距离、信号稳定性、配对便利性等连接体验"
       },
       {
         "name": "外观设计",
         "description": "产品外观、配色、材质质感、折叠便携性等视觉和触觉评价"
       },
       {
         "name": "性价比",
         "description": "价格合理性、与竞品对比的性价比、物有所值的感受"
       }
     ]
   }
   ```

6. **存入数据库** (`product_dimensions` 表)
   ```sql
   INSERT INTO product_dimensions (
     product_id,
     name,
     description,
     is_ai_generated
   ) VALUES
   ('product_uuid', '音质表现', '包括音质清晰度、低音效果...', true),
   ('product_uuid', '降噪效果', '主动降噪(ANC)的强度...', true),
   ('product_uuid', '续航能力', '电池使用时长、充电速度...', true),
   ('product_uuid', '佩戴舒适度', '耳罩材质、头梁压力...', true),
   ('product_uuid', '连接稳定性', '蓝牙连接距离、信号稳定性...', true),
   ('product_uuid', '外观设计', '产品外观、配色、材质质感...', true),
   ('product_uuid', '性价比', '价格合理性、与竞品对比...', true);
   ```

**维度的作用**:
- 当执行 Task 3 (提取洞察) 时,AI 会**强制归类**到这些维度
- 如果没有定义维度,AI 会自动判断并归类为通用维度 (如 "整体满意度"、"其他")
- 维度支持手动添加/编辑/删除

**示例对比 (有无维度 Schema)**:

| 评论内容 | 无维度 Schema (自动判断) | 有维度 Schema (强制归类) |
|---------|------------------------|------------------------|
| "音质超赞" | dimension: "整体满意度" | dimension: "音质表现" ✅ |
| "电池不耐用" | dimension: "产品质量" | dimension: "续航能力" ✅ |
| "太重了" | dimension: "其他" | dimension: "外观设计" ✅ |
| "戴久了耳朵疼" | dimension: "使用体验" | dimension: "佩戴舒适度" ✅ |

**前端操作流程**:
```
产品详情页 → 点击 "学习产品维度" 按钮
↓
后端调用 AI 学习 (30秒)
↓
返回维度列表 (可编辑)
↓
用户可手动调整维度名称和定义
↓
保存后,提取洞察时会使用这些维度
```

---

#### 3.5 Task 4: 提取5W主题高亮 (Themes)
**任务名称**: `task_extract_themes`

**触发方式**: 用户在前端点击"提取主题"按钮 → `POST /api/v1/products/{asin}/extract-themes`

**处理流程**:
1. **自动学习标签库 (Definition 阶段)**
   - **检查**: 产品是否已有5W标签库
   - **如果没有** → 自动生成:
     ```python
     # 采样50条已翻译评论
     sample_reviews = get_sample_reviews(product_id, limit=50)
     
     # 调用 AI 学习5W标签
     learned_labels = translation_service.learn_context_labels(
         reviews_text=sample_reviews,
         product_title=product.title,
         bullet_points=bullet_points
     )
     
     # AI 返回示例:
     {
       "who": [
         {"name": "老人", "description": "老年用户"},
         {"name": "儿童", "description": "儿童用户"},
         {"name": "运动爱好者", "description": "健身运动人群"}
       ],
       "where": [
         {"name": "家中", "description": "家庭使用"},
         {"name": "健身房", "description": "运动场景"},
         {"name": "办公室", "description": "办公场景"}
       ],
       "when": [
         {"name": "工作时", "description": "工作期间使用"},
         {"name": "睡前", "description": "睡觉前使用"}
       ],
       "why": [
         {"name": "降噪", "description": "需要降噪功能"},
         {"name": "音质", "description": "追求音质"}
       ],
       "what": [
         {"name": "听音乐", "description": "主要用于音乐"},
         {"name": "看视频", "description": "视频娱乐"}
       ]
     }
     ```
   - 存入 `product_context_labels` 表

2. **强制归类提取主题 (Execution 阶段)**
   ```python
   # 查询未提取主题的评论
   reviews = get_reviews_without_themes(product_id)
   
   for review in reviews:
       # 调用 AI 提取5W主题 (强制匹配到标签库)
       themes = translation_service.extract_themes(
           original_text=review.body_original,
           translated_text=review.body_translated,
           context_schema=context_schema  # 注入5W标签库
       )
       
       # AI 返回格式:
       {
         "who": [
           {
             "content": "老人",
             "quote": "my elderly father loves it",
             "quote_translated": "我的老父亲很喜欢",
             "explanation": "评论提到老年父亲是使用者"
           }
         ],
         "where": [
           {
             "content": "健身房",
             "quote": "use them at the gym",
             "quote_translated": "在健身房使用",
             "explanation": "明确提到健身房场景"
           }
         ],
         "when": [...],
         "why": [...],
         "what": [...]
       }
   ```

3. **存入数据库** (`review_theme_highlights` 表)
   ```sql
   INSERT INTO review_theme_highlights (
     review_id,
     theme_type,        -- who/where/when/why/what
     label_name,        -- 标签名称 (如"老人")
     quote,             -- 原文证据
     quote_translated,  -- 中文证据
     explanation,       -- 归类理由
     context_label_id   -- 关联标签库ID
   ) VALUES (...);
   ```

**5W 框架说明**:
- `who`: 使用者是谁 (用户画像)
- `where`: 在哪里用 (使用场景)
- `when`: 何时使用 (使用时机)
- `why`: 购买动机 (核心需求)
- `what`: 具体用途 (Jobs-to-be-Done)

---

### **阶段 3.6: 维度 (Dimensions) vs 5W标签 (Context Labels) 的区别**

> **重要说明**: 很多人会混淆这两个概念,让我们明确它们的区别和关系

#### 📊 对比表格

| 特性 | product_dimensions (产品维度) | product_context_labels (5W标签库) |
|------|------------------------------|--------------------------------|
| **用途** | 用于**评价产品功能和属性** | 用于**描述用户和使用情境** |
| **关联任务** | Task 3: 提取洞察 (Insights) | Task 4: 提取5W主题 (Themes) |
| **维度数量** | 5-8个核心维度 | 每个5W类型3-8个标签 (共15-40个) |
| **示例** | 音质表现、续航能力、佩戴舒适度、连接稳定性 | Who: 老人/儿童/运动爱好者<br>Where: 家中/健身房/办公室<br>When: 工作时/睡前 |
| **AI分类方式** | 将洞察(优势/痛点/建议)归类到维度 | 将评论中的5W要素归类到标签 |
| **存储表** | `product_dimensions` | `product_context_labels` |
| **分类结果表** | `review_insights` | `review_theme_highlights` |

#### 🔍 具体示例

**评论**: "我是一名健身爱好者,在健身房用这款耳机听音乐,音质很棒但是电池续航不够用,希望能增加快充功能。"

**维度提取 (Dimensions - 评价产品)**:
```json
// 存入 review_insights 表
[
  {
    "type": "strength",
    "dimension": "音质表现",  ← 使用 product_dimensions
    "quote": "音质很棒"
  },
  {
    "type": "weakness",
    "dimension": "续航能力",  ← 使用 product_dimensions
    "quote": "电池续航不够用"
  },
  {
    "type": "suggestion",
    "dimension": "续航能力",  ← 使用 product_dimensions
    "quote": "希望能增加快充功能"
  }
]
```

**5W提取 (Context Labels - 描述用户和情境)**:
```json
// 存入 review_theme_highlights 表
{
  "who": [{
    "label_name": "运动爱好者",  ← 使用 product_context_labels
    "quote": "我是一名健身爱好者"
  }],
  "where": [{
    "label_name": "健身房",      ← 使用 product_context_labels
    "quote": "在健身房用"
  }],
  "what": [{
    "label_name": "听音乐",      ← 使用 product_context_labels
    "quote": "听音乐"
  }]
}
```

#### 💡 核心理解

**Dimensions (产品维度)** 回答:
- ❓ 这个产品**哪些方面**表现好/不好?
- 📊 用于分析**产品属性**的优劣
- 🎯 目标: 改进产品设计和功能

**5W Labels (用户情境标签)** 回答:
- ❓ **谁**在**何时何地**因为**什么原因**用它做**什么**?
- 👥 用于理解**用户画像和使用情境**
- 🎯 目标: 精准营销和场景化运营

#### 🔄 工作流程

```
用户采集评论
    ↓
翻译评论 (Task 2)
    ↓
┌─────────────────────┬──────────────────────┐
│                     │                      │
│  [可选] 学习维度     │  [可选] 学习5W标签    │
│  (product_dimensions)│  (context_labels)    │
│                     │                      │
│  ↓                  │  ↓                   │
│  提取洞察 (Task 3)   │  提取5W主题 (Task 4)  │
│  - 音质表现 (优势)   │  - Who: 运动爱好者    │
│  - 续航能力 (痛点)   │  - Where: 健身房     │
│  - 性价比 (建议)     │  - When: 工作时      │
│                     │  - Why: 降噪需求     │
│  ↓                  │  - What: 听音乐      │
│  review_insights    │  review_theme_hl...  │
└─────────────────────┴──────────────────────┘
              ↓
        聚合统计
              ↓
        生成报告
```

#### ❌ 常见错误理解

**错误 1**: "维度和5W不是一回事吗?"
- ❌ 不是! 维度是评价产品,5W是描述用户
- ✅ 维度 = 产品视角, 5W = 用户视角

**错误 2**: "可以不学习维度和5W标签吗?"
- ✅ 可以! 都是可选步骤
- ⚠️ 但不学习会导致:
  - 维度: AI自动判断,可能不准确 (如 "其他"、"整体满意度")
  - 5W: AI自由提取,标签名称不统一,难以聚合统计

**错误 3**: "先学习维度还是先学习5W标签?"
- ✅ **任意顺序**,互不影响
- 💡 建议: 翻译完成后,先学习维度 → 提取洞察 → 学习5W → 提取主题

#### 📈 数据聚合时的应用

**报告生成时**:
```python
# 聚合维度数据 (用于评价产品)
insight_stats = {
  "strength": {  # 优势
    "音质表现": {"count": 30, "percent": 37.5},
    "降噪效果": {"count": 20, "percent": 25.0}
  },
  "weakness": {  # 痛点
    "续航能力": {"count": 15, "percent": 18.8},
    "连接稳定性": {"count": 10, "percent": 12.5}
  }
}

# 聚合5W数据 (用于理解用户)
context_stats = {
  "who": {
    "运动爱好者": {"count": 25, "percent": 30.0},
    "老人": {"count": 20, "percent": 24.0}
  },
  "where": {
    "健身房": {"count": 18, "percent": 21.6},
    "家中": {"count": 35, "percent": 42.2}
  }
}
```

**AI 报告生成时会交叉分析**:
- 如果 `who=运动爱好者` 且 `weakness=续航能力` → 建议: "运动人群使用时长较长,需优先提升续航"
- 如果 `where=健身房` 且 `strength=降噪效果` → 卖点: "在嘈杂的健身房环境中依然享受纯净音质"

---

### **阶段 4: 数据聚合与统计分析**

#### 4.1 统计数据结构

**关键文件**: `backend/app/services/summary_service.py`

系统会将提取的洞察和主题数据聚合成可视化图表数据:

**5W Context 统计**:
```json
{
  "who": {
    "total_count": 150,
    "items": [
      {
        "name": "老人",
        "value": 45,
        "percent": 30.0,
        "evidence": [
          {
            "review_id": "uuid-1",
            "quote": "我的老父亲很喜欢",
            "rating": 5,
            "date": "2024-01-15"
          }
        ]
      },
      {"name": "儿童", "value": 30, "percent": 20.0}
    ]
  },
  "where": {...},
  "when": {...},
  "why": {...},
  "what": {...}
}
```

**5类 Insight 统计**:
```json
{
  "strength": {
    "total_count": 80,
    "items": [
      {
        "name": "音质",
        "value": 30,
        "percent": 37.5,
        "evidence": [
          {
            "review_id": "uuid-1",
            "quote": "音质超赞",
            "analysis": "用户称赞音质",
            "rating": 5
          }
        ]
      }
    ]
  },
  "weakness": {...},
  "suggestion": {...},
  "scenario": {...},
  "emotion": {...}
}
```

---

### **阶段 5: 智能报告生成**

#### 5.1 报告类型 (四位一体决策中台)

**触发方式**: `POST /api/v1/products/{asin}/report/generate?report_type=comprehensive`

系统支持4种角色化报告:

| 报告类型 | 目标受众 | 核心内容 |
|---------|---------|---------|
| `comprehensive` | CEO/企业高管 | SWOT分析、市场定位、部门指令、风险等级 |
| `operations` | CMO/运营市场 | 卖点挖掘、广告定位、差评话术、Listing优化 |
| `product` | CPO/产品研发 | 质量评分、缺陷分析、迭代建议、易用性问题 |
| `supply_chain` | 供应链/质检 | 材质问题、包装优化、QC清单、退货原因 |

#### 5.2 报告生成流程

**关键文件**: `backend/app/services/summary_service.py` → `generate_report()`

**步骤**:
1. **验证数据量**
   ```python
   total_reviews = await _count_translated_reviews(product_id)
   if total_reviews < 10:
       return {"success": False, "error": "数据量不足"}
   ```

2. **聚合原始数据**
   ```python
   # 聚合5W Context数据
   context_stats = await _aggregate_5w_stats(product_id)
   
   # 聚合5类Insight数据
   insight_stats = await _aggregate_insight_stats(product_id)
   ```

3. **格式化数据喂给 AI**
   ```python
   stats_text = f"""
   === 📊 基础信息 ===
   - 分析样本: {total_reviews} 条已翻译评论
   
   === 📊 PART 1: 5W Context (宏观画像) ===
   - Who (核心人群): 老人(45次, 30%), 儿童(30次, 20%)
   - Where (使用地点): 家中(37次, 24.7%), 健身房(17次, 11.3%)
   - When (使用时机): 工作时(18次, 12%), 睡前(11次, 7.3%)
   - Why (购买动机): 降噪(23次, 15.3%), 音质(15次, 10%)
   - What (用户任务): 听音乐(38次, 25.3%), 看视频(19次, 12.7%)
   
   === 📉 PART 2: Deep Insights (微观洞察 - 5类) ===
   1. [Strength - 卖点库]: 音质(30次, 37.5%), 降噪(20次, 25%)
   2. [Weakness - 痛点库]: 续航(15次, 18.8%), 连接不稳(10次, 12.5%)
   3. [Suggestion - 用户心声]: 增加配色(8次, 10%), 改进包装(5次, 6.3%)
   4. [Scenario - 行为故事]: 长途飞行(12次, 15%), 健身房(7次, 8.8%)
   5. [Emotion - 情绪预警]: 惊喜好评(15次, 18.8%), 失望吐槽(6次, 7.5%)
   """
   ```

4. **选择对应角色 Prompt 模板**
   ```python
   # 例如: CEO综合版
   prompt = f"""
   你是一位企业CEO兼战略顾问。请基于"用户画像(5W)"和"口碑洞察(Dimensions)"数据,
   生成一份全局战略分析报告 (JSON)。
   
   # 输入数据
   {stats_text}
   
   # 必填字段 (JSON Key)
   1. "user_profile": 用户画像深度分析
   2. "strategic_verdict": 3句话的战略定调
   3. "core_swot": SWOT分析 (每项需带source_tag用于溯源)
   4. "department_directives": 给各部门的一句话指令
   5. "priority_actions": Top 3 优先行动项
   6. "risk_level": 风险等级 (low/medium/high/critical)
   
   要求: 只输出纯JSON,简体中文。
   """
   ```

5. **调用 Qwen AI 生成报告**
   ```python
   response = translation_service.client.chat.completions.create(
       model="qwen-plus",
       messages=[
           {"role": "system", "content": "You are a data analyst. Output JSON only."},
           {"role": "user", "content": prompt}
       ],
       temperature=0.4,
       max_tokens=3500,
       response_format={"type": "json_object"}  # 强制JSON输出
   )
   
   content_json = response.choices[0].message.content
   ```

6. **AI 返回示例 (CEO综合版)**
   ```json
   {
     "user_profile": {
       "core_users": "中老年人和家庭主妇为主要用户群体",
       "user_characteristics": ["注重实用性", "价格敏感", "追求性价比"],
       "usage_scenarios": "主要在家庭环境使用,包括客厅和卧室",
       "purchase_motivation": "降噪需求为核心,音质为次要考量",
       "jobs_to_be_done": "听音乐、看视频、工作专注",
       "persona_insight": "典型用户为追求安静环境的居家人群"
     },
     "strategic_verdict": "产品在音质和降噪功能上表现强劲,但续航和连接稳定性严重拖后腿,建议优先整改质量问题再扩大市场投入。",
     "market_fit_analysis": "产品准确抓住了居家场景的降噪需求,但在健身房等移动场景下表现不佳,存在场景错位。",
     "core_swot": {
       "strengths": [
         {"point": "音质表现优秀", "source_tag": "音质"},
         {"point": "降噪效果显著", "source_tag": "降噪"}
       ],
       "weaknesses": [
         {"point": "续航时间不足", "source_tag": "续航"},
         {"point": "蓝牙连接不稳定", "source_tag": "连接不稳"}
       ],
       "opportunities": [
         "扩展配色选择可吸引年轻用户",
         "优化包装可降低破损率"
       ],
       "threats": [
         "竞品在同价位提供更长续航",
         "用户对连接问题容忍度低"
       ]
     },
     "department_directives": {
       "to_marketing": "主打降噪卖点,避免提及续航,重点攻克居家场景",
       "to_product": "立即解决蓝牙芯片问题,下一代必须提升续航至40小时",
       "to_supply_chain": "更换电池供应商,加强包装测试"
     },
     "priority_actions": [
       {
         "action": "召回质量团队分析续航问题根因",
         "owner": "CTO",
         "deadline": "本周内",
         "source_tag": "续航"
       },
       {
         "action": "暂停所有广告投放,避免扩大差评影响",
         "owner": "CMO",
         "deadline": "立即",
         "source_tag": "连接不稳"
       },
       {
         "action": "启动用户召回计划,免费更换问题批次",
         "owner": "客服总监",
         "deadline": "本月内",
         "source_tag": "质量投诉"
       }
     ],
     "risk_level": "high"
   }
   ```

7. **持久化存储**
   ```python
   # 存入 product_reports 表
   report = ProductReport(
       product_id=product_id,
       title="全维度战略分析报告 - 2024-01-20 15:30",
       content=content_json,        # AI的观点 (JSON)
       report_type="comprehensive",
       analysis_data={               # 原始统计数据 (给前端画图)
           "total_reviews": 150,
           "context": context_stats,
           "insight": insight_stats,
           "meta": {...}
       },
       status="completed"
   )
   ```

---

### **阶段 6: 竞品对比分析**

#### 6.1 对比分析架构

**触发方式**: 
1. 用户在前端选择2-5个产品
2. 创建对比项目: `POST /api/v1/analysis/projects`
3. 系统自动触发分析

**关键文件**: `backend/app/services/analysis_service.py`

#### 6.2 对比分析流程

**步骤**:
1. **收集产品数据**
   ```python
   for product in products:
       # 聚合每个产品的5W和5类Insight数据
       context_stats = await _aggregate_5w_stats(product.id)
       insight_stats = await _aggregate_insight_stats(product.id)
       
       # 精简为Top 20标签 (减少Token消耗)
       product_data = {
           "name": "产品A (耳机)",
           "asin": "B08ABC123",
           "data": {
               "user_context": simplify_stats(context_stats),
               "key_insights": simplify_stats(insight_stats)
           }
       }
   ```

2. **并行调用 AI 分析每个产品**
   ```python
   # 为每个产品生成独立的画像
   for product_data in products:
       profile = await analyze_single_product(product_data)
   
   # AI返回示例:
   {
     "product_name": "产品A (耳机)",
     "asin": "B08ABC123",
     "five_w": {
       "who": [{"label": "老人", "desc": "主要使用者", "count": 42}],
       "when": [{"label": "工作时", "desc": "使用频率最高", "count": 18}],
       ...
     },
     "dimensions": {
       "pros": [{"label": "音质", "desc": "音质超赞", "count": 31}],
       "cons": [{"label": "续航", "desc": "电池不耐用", "count": 15}],
       ...
     }
   }
   ```

3. **生成维度洞察 (10个维度)**
   ```python
   # 将所有产品的画像汇总,生成对比洞察
   dimension_insights = await generate_dimension_insights(product_profiles)
   
   # AI返回示例:
   {
     "dimension_insights": {
       "who": {
         "name": "用户是谁",
         "commonality": "五款产品均定位于减压解压赛道",
         "differences": [
           {"product": 1, "text": "全年龄覆盖,大众市场"},
           {"product": 2, "text": "深耕特殊儿童市场"}
         ],
         "positioning": [
           {"product": 1, "text": "大众减压工具,追求市场覆盖最大化"},
           {"product": 2, "text": "医疗康复赛道,建立专业护城河"}
         ]
       },
       "pros": {...},
       "cons": {...},
       ...
     }
   }
   ```

4. **生成策略总结**
   ```python
   strategy_summary = await generate_strategy_summary(product_profiles)
   
   # AI返回示例:
   {
     "market_summary": "市场呈现差异化竞争格局,产品1占据大众市场,产品2主攻细分领域",
     "strategy_summary": {
       "market_positioning": {
         "title": "市场定位策略",
         "emoji": "🎯",
         "content": "产品1应强化性价比优势,产品2应深化专业医疗认证..."
       },
       "scenario_deep_dive": {...},
       "growth_opportunities": {...}
     }
   }
   ```

5. **存入数据库** (`analysis_projects` 表)
   ```json
   {
     "product_profiles": [...],          // 每个产品的详细画像
     "dimension_insights": {...},        // 10个维度的对比洞察
     "market_summary": "...",            // 市场总结
     "strategy_summary": {...}           // 策略建议
   }
   ```

---

### **阶段 7: 前端展示与交互**

#### 7.1 产品列表页
**URL**: `http://localhost:3000/`

**展示内容**:
- 所有已采集的产品卡片
- 每个产品的统计信息:
  - 总评论数 (已翻译/总数)
  - 平均评分
  - 采集时间
- 操作按钮:
  - 查看详情
  - 开始翻译
  - 删除产品

#### 7.2 产品详情页
**URL**: `http://localhost:3000/products/{asin}`

**布局**:
```
┌─────────────────────────────────────────────┐
│  产品信息卡片                                │
│  - 标题 (中英双语)                           │
│  - 图片                                      │
│  - 五点卖点 (中英双语)                       │
│  - 平均评分                                  │
│  - 操作按钮: 开始翻译 / 提取洞察 / 提取主题  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  数据概览 (统计卡片)                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │总评论数 │ │已翻译数 │ │洞察数量 │       │
│  └─────────┘ └─────────┘ └─────────┘       │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  评论列表 (双语卡片)                         │
│  ┌───────────────────────────────────────┐  │
│  │ ⭐⭐⭐⭐⭐ (5星)  John Doe  2024-01-15 │  │
│  │ 标题: Great product! | 很棒的产品!    │  │
│  │ 正文: This is amazing... | 这款太棒了..│  │
│  │ 洞察: 🟢音质 🟢降噪                   │  │
│  │ 主题: 👤老人 📍家中 🎯降噪             │  │
│  └───────────────────────────────────────┘  │
│  [加载更多]                                  │
└─────────────────────────────────────────────┘
```

#### 7.3 报告页面
**URL**: `http://localhost:3000/products/{asin}/report?type=comprehensive`

**展示内容**:
- **选择报告类型**: CEO综合版 / 运营版 / 产品版 / 供应链版
- **生成按钮**: 点击后调用 `/api/v1/products/{asin}/report/generate`
- **报告内容** (动态渲染JSON):
  - 用户画像卡片
  - SWOT分析表格
  - 部门指令列表
  - 优先行动项时间线
  - 原始数据图表 (ECharts):
    - 5W饼图
    - 洞察条形图
    - 情感分布图
- **导出功能**:
  - 导出为 PDF
  - 导出为 Excel
  - 分享报告链接

#### 7.4 对比分析页面
**URL**: `http://localhost:3000/analysis/projects/{project_id}`

**展示内容**:
- **产品对比表格**: 横向对比5W和5类Insight
- **维度洞察卡片**: 10个维度的共性/差异/定位分析
- **策略建议**: 市场定位/场景深耕/增长机会
- **数据图表**:
  - 雷达图 (多产品对比)
  - 热力图 (标签重叠度)
  - 气泡图 (用户群体分布)

---

## 🗄️ 数据库表结构

### 核心表

#### 1. `products` (产品表)
```sql
id                      UUID PRIMARY KEY
asin                    VARCHAR(10) UNIQUE
title                   TEXT
title_translated        TEXT
image_url               TEXT
marketplace             VARCHAR(50)
average_rating          FLOAT
price                   VARCHAR(50)
bullet_points           JSONB                    -- 原文五点
bullet_points_translated JSONB                   -- 中文五点
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

#### 2. `reviews` (评论表)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
review_id               VARCHAR(255)
rating                  INTEGER
title_original          TEXT
title_translated        TEXT
body_original           TEXT
body_translated         TEXT
author                  VARCHAR(255)
review_date             TIMESTAMP
verified_purchase       BOOLEAN
helpful_votes           INTEGER
review_url              TEXT
sentiment               VARCHAR(20)              -- positive/neutral/negative
translation_status      VARCHAR(20)              -- pending/processing/completed/failed
is_pinned               BOOLEAN DEFAULT FALSE
is_hidden               BOOLEAN DEFAULT FALSE
is_deleted              BOOLEAN DEFAULT FALSE
created_at              TIMESTAMP
updated_at              TIMESTAMP

UNIQUE (product_id, review_id)
```

#### 3. `review_insights` (洞察表)
```sql
id                      UUID PRIMARY KEY
review_id               UUID REFERENCES reviews(id)
insight_type            VARCHAR(50)              -- strength/weakness/suggestion/scenario/emotion
dimension               VARCHAR(100)             -- 音质/续航/外观/...
quote                   TEXT                     -- 原文引用
quote_translated        TEXT                     -- 中文引用
analysis                TEXT                     -- AI分析
created_at              TIMESTAMP
```

#### 4. `review_theme_highlights` (5W主题表)
```sql
id                      UUID PRIMARY KEY
review_id               UUID REFERENCES reviews(id)
theme_type              VARCHAR(50)              -- who/where/when/why/what
label_name              VARCHAR(100)             -- 标签名称
quote                   TEXT                     -- 原文证据
quote_translated        TEXT                     -- 中文证据
explanation             TEXT                     -- 归类理由
context_label_id        UUID                     -- 关联标签库ID
items                   JSONB                    -- 兼容旧数据
created_at              TIMESTAMP
```

#### 5. `product_context_labels` (5W标签库)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
type                    VARCHAR(50)              -- who/where/when/why/what
name                    VARCHAR(100)             -- 标签名称
description             TEXT                     -- 标签描述
count                   INTEGER DEFAULT 0        -- 使用次数
is_ai_generated         BOOLEAN DEFAULT FALSE
created_at              TIMESTAMP
```

#### 6. `product_dimensions` (产品维度表)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
name                    VARCHAR(100)             -- 维度名称
description             TEXT                     -- 维度描述
is_ai_generated         BOOLEAN DEFAULT FALSE
created_at              TIMESTAMP
```

#### 7. `product_reports` (报告表)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
title                   VARCHAR(255)
content                 JSONB                    -- AI生成的报告内容
analysis_data           JSONB                    -- 原始统计数据
report_type             VARCHAR(50)              -- comprehensive/operations/product/supply_chain
status                  VARCHAR(20)              -- pending/completed/failed
error_message           TEXT
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

#### 8. `tasks` (任务表)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
task_type               VARCHAR(50)              -- translation/insights/themes
status                  VARCHAR(20)              -- pending/processing/completed/failed/stopped/timeout
total_items             INTEGER
processed_items         INTEGER
progress_percentage     INTEGER
last_heartbeat          TIMESTAMP                -- 心跳时间
celery_task_id          VARCHAR(255)
error_message           TEXT
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

#### 9. `analysis_projects` (对比分析项目表)
```sql
id                      UUID PRIMARY KEY
title                   VARCHAR(255)
description             TEXT
analysis_type           VARCHAR(50)              -- comparison
status                  VARCHAR(20)              -- pending/processing/completed/failed
result_content          JSONB                    -- 分析结果
raw_data_snapshot       JSONB                    -- 原始数据快照
error_message           TEXT
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

#### 10. `analysis_project_items` (对比项目明细表)
```sql
id                      UUID PRIMARY KEY
project_id              UUID REFERENCES analysis_projects(id)
product_id              UUID REFERENCES products(id)
role_label              VARCHAR(50)              -- target/competitor/gen1/gen2
display_order           INTEGER
created_at              TIMESTAMP
```

---

## 🔧 技术栈总览

### 前端
- **框架**: React 18 + TypeScript
- **路由**: React Router v6
- **UI 组件**: Tailwind CSS + shadcn/ui
- **图表**: ECharts / Recharts
- **状态管理**: React Query (TanStack Query)
- **HTTP 客户端**: Axios
- **打包工具**: Vite

### 后端
- **框架**: FastAPI 0.104+
- **ORM**: SQLAlchemy 2.0 (异步)
- **数据库**: PostgreSQL 15
- **任务队列**: Celery + Redis
- **AI 服务**: 阿里云通义千问 (Qwen API)
- **数据导出**: pandas + openpyxl

### 基础设施
- **反向代理**: Nginx
- **容器化**: Docker + Docker Compose
- **日志**: Python logging

### 浏览器插件
- **标准**: Chrome Manifest V3
- **语言**: Vanilla JavaScript (ES6+)
- **通信**: Chrome Extensions API

---

## 📈 数据流转时序图

```
用户           插件            后端API         Celery Worker      AI服务          数据库
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                          【阶段1: 数据采集】                                   │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──点击采集───→│               │                │                │              │
 │              │──爬取评论─────→│                │                │              │
 │              │               │                │                │              │
 │              │               │──存入产品表────┼────────────────┼─────────────→│
 │              │               │  (products)    │                │              │
 │              │               │──存入评论表────┼────────────────┼─────────────→│
 │              │               │  (reviews)     │                │              │
 │              │←──返回成功────│                │                │              │
 │              │               │                │                │              │
 │←─跳转控制台──│               │                │                │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                          【阶段2: 翻译处理】                                   │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──点击翻译────────────────────→│                │                │              │
 │              │               │──创建任务表────┼────────────────┼─────────────→│
 │              │               │  (tasks)       │                │              │
 │              │               │──发送翻译任务──┼───────────────→│              │
 │              │               │  到Redis队列   │                │              │
 │              │               │                │                │              │
 │              │               │                │──Task1:翻译五点─→│             │
 │              │               │                │                │──翻译标题+卖点│
 │              │               │                │←───返回译文────│              │
 │              │               │                │──更新产品表────┼─────────────→│
 │              │               │                │                │              │
 │              │               │                │──Task2:翻译评论─→│             │
 │              │               │                │                │──逐条翻译────→│
 │              │               │                │←───返回译文────│              │
 │              │               │                │──更新评论表────┼─────────────→│
 │              │               │                │──更新任务进度──┼─────────────→│
 │              │               │                │                │              │
 │──轮询进度────────────────────→│──查询任务状态──┼────────────────┼─────────────→│
 │←──返回80%────────────────────│                │                │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                    【阶段3.1: 学习产品维度 (可选)】                            │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──学习维度────────────────────→│──查询评论样本──┼────────────────┼─────────────→│
 │              │               │──查询产品信息──┼────────────────┼─────────────→│
 │              │               │                │                │              │
 │              │               │──调用AI学习────┼────────────────→│              │
 │              │               │  (产品标题+    │                │              │
 │              │               │   五点+评论)   │                │──AI分析────→│
 │              │               │                │                │  生成维度    │
 │              │               │                │←───返回维度────│              │
 │              │               │──存入维度表────┼────────────────┼─────────────→│
 │              │               │  (product_     │                │              │
 │              │               │   dimensions)  │                │              │
 │              │               │                │                │              │
 │←──返回维度列表───────────────│                │                │              │
 │  (可编辑)     │               │                │                │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                       【阶段3.2: 提取洞察 (Insights)】                         │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──点击洞察────────────────────→│──查询维度Schema┼────────────────┼─────────────→│
 │              │               │  (如果已定义)  │                │              │
 │              │               │──发送洞察任务──┼───────────────→│              │
 │              │               │                │                │              │
 │              │               │                │──Task3:提取洞察─→│             │
 │              │               │                │  (带维度Schema)│              │
 │              │               │                │                │──AI提取5类──→│
 │              │               │                │                │  洞察(优势/  │
 │              │               │                │                │  痛点/建议/  │
 │              │               │                │                │  场景/情绪)  │
 │              │               │                │←───返回洞察────│              │
 │              │               │                │──存入洞察表────┼─────────────→│
 │              │               │                │  (review_      │              │
 │              │               │                │   insights)    │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                    【阶段3.3: 学习5W标签库 + 提取主题】                         │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──点击主题────────────────────→│──发送主题任务──┼───────────────→│              │
 │              │               │                │                │              │
 │              │               │                │──Task4:提取主题─→│             │
 │              │               │                │                │              │
 │              │               │                │─检查标签库是否存在─────────────→│
 │              │               │                │←─不存在,需学习─┼─────────────→│
 │              │               │                │                │              │
 │              │               │                │──Step1:学习5W──→│             │
 │              │               │                │  标签库        │              │
 │              │               │                │  (产品标题+    │              │
 │              │               │                │   五点+评论样本)│              │
 │              │               │                │                │──AI学习────→│
 │              │               │                │                │  生成Who/   │
 │              │               │                │                │  Where/When/│
 │              │               │                │                │  Why/What标签│
 │              │               │                │←───返回标签库──│              │
 │              │               │                │──存入标签库────┼─────────────→│
 │              │               │                │  (product_     │              │
 │              │               │                │   context_     │              │
 │              │               │                │   labels)      │              │
 │              │               │                │                │              │
 │              │               │                │──Step2:提取5W──→│             │
 │              │               │                │  主题(强制归类)│              │
 │              │               │                │                │──AI提取────→│
 │              │               │                │                │  5W要素并   │
 │              │               │                │                │  匹配标签   │
 │              │               │                │←───返回主题────│              │
 │              │               │                │──存入主题表────┼─────────────→│
 │              │               │                │  (review_theme_│              │
 │              │               │                │   highlights)  │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                          【阶段4: 报告生成】                                   │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──生成报告────────────────────→│──聚合5W数据────┼────────────────┼─────────────→│
 │  (选择类型)  │               │──聚合洞察数据──┼────────────────┼─────────────→│
 │              │               │──格式化Prompt──│                │              │
 │              │               │                │                │              │
 │              │               │──调用AI生成────┼────────────────→│              │
 │              │               │  (CEO/CMO/CPO/ │                │              │
 │              │               │   供应链版本)  │                │──AI撰写报告→│
 │              │               │                │                │  (SWOT/卖点/ │
 │              │               │                │                │   痛点/建议) │
 │              │               │                │←───返回报告JSON│              │
 │              │               │──存入报告表────┼────────────────┼─────────────→│
 │              │               │  (product_     │                │              │
 │              │               │   reports)     │                │              │
 │              │               │                │                │              │
 │←───展示报告──────────────────│                │                │              │
 │  (可导出PDF/Excel)            │                │                │              │
```

**时序图说明**:
- 🔵 **阶段1**: 数据采集 (Chrome插件 → 后端存储)
- 🟢 **阶段2**: 翻译处理 (Task1: 五点翻译 → Task2: 评论翻译)
- 🟡 **阶段3.1**: 学习产品维度 (可选,用于洞察分类)
- 🟠 **阶段3.2**: 提取洞察 (5类: 优势/痛点/建议/场景/情绪)
- 🔴 **阶段3.3**: 学习5W标签库 + 提取5W主题 (Who/Where/When/Why/What)
- 🟣 **阶段4**: 报告生成 (4种角色化报告)

**关键点**:
1. **维度学习** 和 **5W标签学习** 都是可选步骤
2. 如果不学习,AI 会自动判断维度/标签 (但不够精准)
3. **Task4 (提取主题)** 会自动检测标签库是否存在,如不存在则先学习后提取

---

## 🎯 关键设计亮点

### 1. **智能去重机制**
- 评论表使用 `(product_id, review_id)` 唯一索引
- 自动跳过重复评论,避免数据冗余
- 支持增量采集 (采集50条 → 再采集50条 = 自动合并)

### 2. **人性化采集**
- 随机延迟 (2-5秒) 模拟人类行为
- 验证码检测 & 自动暂停
- 进度实时反馈 (浮层显示)

### 3. **异步处理架构**
- Celery 分布式任务队列
- 4个独立任务 (翻译/洞察/主题/报告)
- 心跳监控 + 超时恢复
- 支持手动停止/重试

### 4. **AI-Native 数据架构**
- **先学习标准,后强制归类** (5W标签库)
- **5类洞察框架** (strength/weakness/suggestion/scenario/emotion)
- **带证据溯源** (每个标签都可追溯到原始评论)

### 5. **角色化报告系统**
- 4种报告类型 (CEO/CMO/CPO/供应链)
- 每种报告使用不同的 AI Prompt
- JSON 格式输出,前端动态渲染
- 支持历史报告回溯

### 6. **可追溯性设计**
- 每个统计项都带 `evidence` 数组
- 点击标签 → 展示相关评论
- 报告中的建议都带 `source_tag` → 可跳转到原始洞察

### 7. **N-Way 对比分析**
- 支持2-5个产品同时对比
- 10个维度交叉分析 (5W + 5类Insight)
- 共性/差异/定位洞察
- 策略建议 (市场定位/场景深耕/增长机会)

---

## 🚀 部署与运行

### Docker Compose 一键启动
```bash
# 1. 克隆项目
git clone <your-repo-url>
cd voc-master

# 2. 配置环境变量
cp .env.example .env
nano .env  # 填入 QWEN_API_KEY

# 3. 启动所有服务
docker-compose up -d

# 4. 查看日志
docker-compose logs -f

# 5. 访问服务
# - 前端: http://localhost:3000
# - 后端: http://localhost:8000
# - API文档: http://localhost:8000/docs
```

### 服务列表
| 服务 | 端口 | 说明 |
|------|------|------|
| `db-postgres` | 5432 | PostgreSQL 15 数据库 |
| `db-redis` | 6379 | Redis 7 消息队列 |
| `app-backend` | 8000 | FastAPI 后端 API |
| `app-worker` | - | Celery 翻译 Worker |
| `app-frontend` | 3000 | React 前端 (Nginx) |

---

## 📚 API 接口汇总

### 评论相关
- `POST /api/v1/reviews/ingest` - 接收插件采集的评论
- `GET /api/v1/reviews/{asin}` - 获取商品评论列表
- `GET /api/v1/reviews/{asin}/export` - 导出 Excel

### 产品相关
- `GET /api/v1/products` - 商品列表
- `GET /api/v1/products/{asin}/stats` - 商品统计
- `POST /api/v1/products/{asin}/translate` - 触发翻译
- `POST /api/v1/products/{asin}/extract-insights` - 提取洞察
- `POST /api/v1/products/{asin}/extract-themes` - 提取5W主题
- `POST /api/v1/products/{asin}/stop-analysis` - 停止分析

### 维度管理
- `GET /api/v1/products/{asin}/dimensions` - 获取产品维度
- `POST /api/v1/products/{asin}/dimensions/generate` - AI生成维度
- `POST /api/v1/products/{asin}/dimensions` - 手动添加维度
- `PUT /api/v1/products/dimensions/{id}` - 更新维度
- `DELETE /api/v1/products/dimensions/{id}` - 删除维度

### 5W标签管理
- `GET /api/v1/products/{asin}/context-labels` - 获取5W标签库
- `POST /api/v1/products/{asin}/context-labels/generate` - AI学习标签
- `GET /api/v1/products/{asin}/context-labels/schema` - 获取标签Schema
- `POST /api/v1/products/{asin}/context-labels` - 添加标签
- `PUT /api/v1/products/context-labels/{id}` - 更新标签
- `DELETE /api/v1/products/context-labels/{id}` - 删除标签

### 报告相关
- `GET /api/v1/products/report-types` - 获取所有报告类型
- `POST /api/v1/products/{asin}/report/generate?report_type=comprehensive` - 生成报告
- `GET /api/v1/products/{asin}/report/preview` - 报告预览
- `GET /api/v1/products/{asin}/reports` - 历史报告列表
- `GET /api/v1/products/{asin}/reports/latest` - 最新报告
- `GET /api/v1/products/{asin}/reports/{report_id}` - 获取指定报告
- `DELETE /api/v1/products/{asin}/reports/{report_id}` - 删除报告

### 对比分析
- `POST /api/v1/analysis/projects` - 创建对比项目
- `GET /api/v1/analysis/projects` - 项目列表
- `GET /api/v1/analysis/projects/{project_id}` - 项目详情
- `POST /api/v1/analysis/projects/{project_id}/run` - 触发分析
- `DELETE /api/v1/analysis/projects/{project_id}` - 删除项目
- `POST /api/v1/analysis/preview` - 对比预览
- `GET /api/v1/analysis/products/{asin}/reviews-by-label` - 根据标签获取评论

### 任务管理
- `GET /api/v1/tasks/{task_id}` - 任务状态查询
- `GET /api/v1/products/{asin}/tasks/health` - 任务健康检查

---

## 🔍 故障排查

### 常见问题

#### 1. 翻译任务卡住不动
**症状**: 进度条停在某个百分比,长时间不更新

**排查步骤**:
```bash
# 1. 检查 Worker 是否运行
docker-compose logs app-worker

# 2. 检查任务心跳
curl http://localhost:8000/api/v1/products/{asin}/tasks/health

# 3. 如果发现超时任务,手动恢复
curl -X POST http://localhost:8000/api/v1/products/{asin}/tasks/health?auto_recover=true

# 4. 或者手动重启 Worker
docker-compose restart app-worker
```

#### 2. AI 服务调用失败
**症状**: 翻译/洞察/主题提取失败,错误日志显示 API 错误

**排查步骤**:
```bash
# 1. 检查 Qwen API Key 是否配置
docker-compose exec app-backend env | grep QWEN

# 2. 测试 API 连通性
curl https://dashscope.aliyuncs.com/compatible-mode/v1/models \
  -H "Authorization: Bearer YOUR_API_KEY"

# 3. 如果 API Key 失效,更新环境变量
docker-compose down
nano .env  # 更新 QWEN_API_KEY
docker-compose up -d
```

#### 3. 数据采集失败
**症状**: 插件提示"采集失败"或"请确保已登录亚马逊"

**排查步骤**:
1. 确认已登录亚马逊账号
2. 刷新商品页面,重新尝试
3. 检查是否触发验证码 → 手动完成验证码后继续
4. 如果是站点不支持 → 确认是否为 amazon.com/amazon.co.uk 等主流站点

#### 4. 报告生成失败
**症状**: 点击"生成报告"后返回错误

**排查步骤**:
```bash
# 1. 检查数据量是否充足
curl http://localhost:8000/api/v1/products/{asin}/report/preview

# 确保:
# - total_reviews >= 10
# - 已完成翻译 (translation_status = completed)

# 2. 如果数据不足
# - 继续采集更多评论
# - 或手动触发翻译
```

---

## 📊 性能指标

### 采集速度
- **单条评论**: 2-5秒 (含人类模拟延迟)
- **50条评论**: 约 3-5 分钟
- **翻页次数**: 取决于每页评论数 (通常10条/页)

### 翻译速度
- **单条评论翻译**: 1-2秒 (Qwen API)
- **100条评论**: 约 3-5 分钟
- **限流**: 每条评论间隔 0.2秒

### 洞察提取速度
- **单条评论洞察**: 2-3秒 (Qwen API)
- **100条评论**: 约 5-8 分钟

### 5W主题提取速度
- **学习标签库**: 10-15秒 (基于50条样本)
- **单条评论主题**: 2-3秒 (Qwen API)
- **100条评论**: 约 5-8 分钟

### 报告生成速度
- **单份报告**: 30-60秒 (AI撰写)
- **对比分析**: 2-5分钟 (2-5个产品)

---

## 🎉 总结

VOC-Master 通过以下流程实现了从数据采集到智能分析的全链路自动化:

1. **采集**: Chrome插件无感爬取评论
2. **存储**: PostgreSQL持久化 + 智能去重
3. **翻译**: Celery异步队列 + Qwen AI高精度翻译
4. **提取**: AI提取5W主题 + 5类洞察 + 证据溯源
5. **聚合**: 统计分析 + 数据可视化
6. **生成**: 4种角色化报告 + N-Way对比分析
7. **展示**: React前端 + 双语阅读 + 图表展示

整个系统的核心设计理念是:
- **AI-Native**: 深度依赖 AI 进行数据理解和生成
- **可追溯性**: 每个数据点都可以追溯到原始评论
- **角色化**: 不同角色看到不同视角的报告
- **自动化**: 最小化人工干预,最大化效率

---

**文档生成时间**: 2025-01-09  
**项目版本**: v1.0.0  
**作者**: VOC-Master Team
