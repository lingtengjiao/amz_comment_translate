# VOC-Master 数据流转全流程梳理

> **项目简介**: VOC-Master 是一个针对亚马逊商品评论(VOC - Voice of Customer)的深度分析系统,从爬取数据到最终生成智能报告的完整解决方案。
>
> **最后更新**: 2026-01-25

---

## 📊 整体架构概览

### 流式并行架构 (v2.0)

```
┌─────────────────┐
│  Chrome 插件    │ ← 用户在亚马逊商品页点击采集
└────────┬────────┘
         │ POST /api/v1/reviews/ingest (流式上传)
         ↓
┌─────────────────────────────────────────────────────────────────┐
│                  FastAPI 后端 (app-backend)                     │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ 1. 接收数据 → Redis Queue (高并发写入)                      ││
│  │ 2. Celery 消费队列 → 存入 PostgreSQL (批量入库)             ││
│  │ 3. ⚡ 入库成功 → 立即触发翻译任务 (流式处理)                  ││
│  │ 4. 采集完成 → 触发全自动分析任务 (task_full_auto_analysis)  ││
│  └────────────────────────────────────────────────────────────┘│
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ Celery Task Queue (Redis)
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│                  Celery Worker (app-worker)                     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 🔥 流式并行处理流水线                                        ││
│  │                                                              ││
│  │    [采集时触发]           [采集完成后触发]                    ││
│  │         │                       │                            ││
│  │         ↓                       ↓                            ││
│  │  ┌──────────────┐     ┌──────────────────────┐               ││
│  │  │ 翻译任务      │     │ 全自动分析任务       │               ││
│  │  │ (边采边译)    │     │ (task_full_auto_     │               ││
│  │  │              │     │  analysis)           │               ││
│  │  └──────────────┘     └──────────┬───────────┘               ││
│  │                                  │                            ││
│  │                    ┌─────────────┼─────────────┐              ││
│  │                    ↓             ↓             ↓              ││
│  │             ┌───────────┐ ┌───────────┐ ┌───────────┐         ││
│  │             │ 维度学习   │ │ 5W标签学习 │ │ 报告等待   │         ││
│  │             │(英文原文) │ │(英文原文) │ │           │         ││
│  │             └─────┬─────┘ └─────┬─────┘ │           │         ││
│  │                   │             │       │           │         ││
│  │                   ↓             ↓       │           │         ││
│  │             ┌───────────┐ ┌───────────┐ │           │         ││
│  │             │ 洞察提取   │ │ 主题提取   │ │           │         ││
│  │             │(英文原文,  │ │(英文原文,  │ │           │         ││
│  │             │ 使用维度)  │ │ 使用标签)  │ │           │         ││
│  │             └─────┬─────┘ └─────┬─────┘ │           │         ││
│  │                   │             │       │           │         ││
│  │                   └─────────────┼───────┘           │         ││
│  │                                 ↓                   ↓         ││
│  │                       [90%完成度达成] ──────→ [生成报告]       ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────┬───────────────────────────────────────┘
                          │ 调用 Qwen AI API
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│                  数据分析 & 报告生成模块                         │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ 1. 聚合统计数据 (5W + 5类洞察)                              ││
│  │ 2. 生成多角色报告 (CEO/CMO/CPO/供应链)                      ││
│  │ 3. N-Way 对比分析 (2-5个产品)                               ││
│  └────────────────────────────────────────────────────────────┘│
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│                      React 前端控制台                            │
│  - 双语评论阅读 (原文 + 翻译)                                    │
│  - 数据可视化 (ECharts)                                          │
│  - 报告下载 (Excel/PDF)                                          │
│  - 竞品对比分析                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🚀 核心任务触发时序（v2.0 更新）

### 完整触发链路图

```
用户点击采集
    ↓
[Chrome 插件采集评论] ──────────────────────────────────────────────────┐
    ↓                                                                   │
    ├─ 第1批评论 POST → Redis队列 → 入库 → ⚡ 立即触发翻译任务 ─────────┤
    ├─ 第2批评论 POST → Redis队列 → 入库 → ⚡ 立即触发翻译任务 ─────────┤
    ├─ ...                                                             │
    └─ 第N批评论 POST → Redis队列 → 入库 → ⚡ 立即触发翻译任务 ─────────┤
                                                                       │
                                                    (翻译持续进行中...)  │
                                                                       ↓
[采集完成信号] ──→ task_full_auto_analysis ───────────────────────────┐
                          │                                           │
                          ↓                                           │
                ┌─────────────────────┐                               │
                │ Step 1: 科学学习     │                               │
                │ (基于英文原文,       │ ← 不等待翻译!                 │
                │  不依赖翻译)         │                               │
                └──────────┬──────────┘                               │
                          │                                           │
          ┌───────────────┼───────────────┐                           │
          ↓               ↓               ↓                           │
   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                   │
   │ 学习维度    │ │ 学习5W标签   │ │ (翻译继续)   │                   │
   │(5-8个)      │ │(15-40个)    │ │              │                   │
   └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                   │
          │               │               │                           │
          ↓               ↓               ↓                           │
┌─────────────────────────────────────────────────────────────────┐  │
│ Step 2: 触发洞察+主题提取 (并行，必须在Step1完成后触发)            │  │
│         ↓                                                        │  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │  │
│  │task_extract_│ │task_extract_│ │ (翻译任务)   │                │  │
│  │  insights   │ │   themes    │ │ 持续进行    │                │  │
│  │(英文原文,   │ │(英文原文,   │ │              │                │  │
│  │ 使用维度)   │ │ 使用标签)   │ │              │                │  │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                │  │
│         │               │               │                        │  │
│         └───────────────┼───────────────┘                        │  │
│                         ↓                                        │  │
│ Step 3: 等待并行完成 (翻译+洞察+主题，最多30分钟)                 │  │
│         • 每15秒检查进度                                         │  │
│         • 90%完成度即可继续                                      │  │
│         • 超时但>80%完成度仍继续                                  │  │
└──────────────────────────┬──────────────────────────────────────┘  │
                           ↓                                          │
                ┌─────────────────────┐                               │
                │ Step 4: 生成报告     │                               │
                │ (综合战略版)         │                               │
                └──────────┬──────────┘                               │
                           ↓                                          │
                        ✅ 完成                                        │
```

### 任务类型与触发方式对照表

| 任务名称 | 触发方式 | 触发时机 | 依赖条件 | 备注 |
|---------|---------|---------|---------|------|
| `task_process_ingestion_queue` | 定时触发 (5秒) | 有数据入队时 | Redis队列有数据 | 批量消费入库 |
| `task_ingest_translation_only` | 入库后立即触发 | 每批评论入库后 | 无 | 流式翻译,不等待采集完成 |
| `task_check_pending_translations` | 定时触发 (15秒) | Celery Beat | 有待翻译评论 | 补漏机制 |
| `task_full_auto_analysis` | 采集完成触发 | 插件发送完成信号 | 采集完成 | 全自动分析流水线 |
| `task_scientific_learning` | 手动或自动 | 全自动分析Step1 | ≥10条原文 | 学习维度+5W标签 |
| `task_extract_insights` | 自动/手动 | 全自动分析Step2 | **维度学习完成** | 跨语言模式：使用英文原文，使用维度约束 |
| `task_extract_themes` | 自动/手动 | 全自动分析Step2 | **5W标签学习完成** | 跨语言模式：使用英文原文，使用5W标签约束 |
| `task_generate_dimension_summaries` | 🆕 用户手动触发 | 分享页面点击"生成AI分析" | **洞察+主题提取完成** | 生成中观层AI总结（5W主题/维度/情感/场景/消费者原型/整体总结） |
| `task_translate_bullet_points` | 入库时自动 | 产品五点为空时 | 产品已创建 | 翻译五点卖点 |

### 🔥 流式处理优化说明

**v2.0 架构优势：**

1. **边采边译**：评论入库后立即触发翻译,不等待采集完成
2. **跨语言学习**：维度/5W标签学习基于英文原文,不依赖翻译
3. **跨语言分析**：洞察/主题提取直接使用英文原文，输出中文结果，与翻译完全解耦
4. **三任务并行**：翻译、洞察、主题同时进行（洞察/主题不再等待翻译完成）
5. **智能等待**：90%完成度即可生成报告,不死等100%
6. **补漏机制**：定时任务每15秒检查,防止任务遗漏

**时间优化效果：**
```
旧架构: 采集完成 → 翻译 → 学习 → 洞察 → 主题 → 报告 (串行,慢)
新架构: 采集同时翻译 → 学习(并行) → 洞察+主题(并行) → 报告 (并行,快50%+)
```

---

## 🎯 两种处理模式对比

### 模式A：全自动分析流水线 (推荐)

**触发条件**：采集完成后自动触发 `task_full_auto_analysis`

```
用户采集评论 → 自动完成所有分析 → 自动生成报告
```

**特点**：
- ✅ 零操作：用户无需手动点击任何按钮
- ✅ 最优时序：科学学习基于英文原文,不等翻译
- ✅ 并行处理：翻译+洞察+主题同时进行
- ✅ 智能报告：90%完成度自动生成报告

**适用场景**：
- 新产品首次采集
- 批量采集多个产品
- 追求"一键完成"的用户体验

**任务执行顺序**：
```
1. 采集时 → 立即触发流式翻译 (task_ingest_translation_only)
2. 采集完成 → 触发全自动分析 (task_full_auto_analysis)
   ├── Step 1: 科学学习 (维度 + 5W标签) - 基于英文原文，同步执行
   ├── Step 2: 触发洞察+主题提取 - 必须在 Step 1 完成后触发
   │           ├─ 洞察提取：使用英文原文，依赖 Step 1 的维度
   │           └─ 主题提取：使用英文原文，依赖 Step 1 的5W标签
   ├── Step 3: 等待并行完成 (翻译+洞察+主题，90%阈值)
   └── Step 4: 自动生成报告
```

---

### 模式B：只翻译 → 后洞察 (两步模式)

**触发条件**：用户选择 `translate_only` 模式进行采集

```
用户采集(只翻译) → 翻译完成 → 用户点击"开始分析" → 全自动分析流水线
```

**特点**：
- ✅ 灵活控制：可以先查看翻译结果，再决定是否进行深度分析
- ✅ 可编辑维度：翻译完成后，用户可以手动设置/调整维度再触发分析
- ✅ 一键分析：点击后自动执行完整的分析流程（与模式A相同）
- ✅ 包含报告：一键分析包含科学学习、洞察提取、主题提取和报告生成

**适用场景**：
- 用户只想看翻译结果，暂不需要洞察分析
- 需要先手动设置/调整评价维度后再分析
- 想要分批次处理数据

**任务执行顺序**：
```
Step 1 - 采集阶段：
   采集数据 → 流式翻译 (边采集边翻译)
   
Step 2 - 分析阶段 (用户点击"开始分析"触发)：
   POST /api/v1/products/{asin}/start-analysis
   → task_full_auto_analysis
       ├── 科学学习 (维度+5W标签)
       ├── 洞察+主题提取 (并行，基于英文原文)
       ├── 等待90%完成
       └── 自动生成报告
```

---

### 模式对比表格

| 对比项 | 全自动模式 (A) | 只翻译后洞察 (B) |
|-------|--------------|-----------------|
| **用户操作** | 仅点击"采集" | 点击"采集" + 点击"开始分析" |
| **等待时间** | 并行处理,快50%+ | 翻译后可等待，分析时并行 |
| **维度可编辑** | 自动生成,不可编辑 | 翻译完成后可手动调整再分析 |
| **适用场景** | 新产品/批量采集 | 先看译文/需调整维度 |
| **任务触发** | 采集完成自动触发 | 用户手动点击"开始分析" |
| **报告生成** | 90%完成自动生成 | 一键分析后自动生成 |
| **分析内容** | 完整流水线 | 与模式A相同的完整流水线 |

---

### 两种模式的任务链对比图

```
【模式A - 全自动】
采集数据
    │
    ├──→ 流式翻译 (立即开始,不等采集完成)
    │
    └── 采集完成 → task_full_auto_analysis
                        │
                        ├── Step 1: 科学学习 (维度+5W标签) ──┐
                        │                                    ↓
                        ├── Step 2: 洞察提取 (英文原文) ────┼── 并行执行
                        │  (必须在Step1完成后)                ↓
                        └── Step 2: 主题提取 (英文原文) ────┘
                        │  (必须在Step1完成后)
                        │
                        ├── Step 3: 等待90%完成
                        │
                        └── Step 4: 自动报告 → ✅ 完成


【模式B - 只翻译，后洞察】
采集数据
    │
    └──→ 流式翻译 (立即开始,不等采集完成)
           ↓
       翻译完成 (状态：待分析)
           │
           └── 用户可选：仅查看译文，暂不分析
           │
           └── 需要洞察时，点击 "开始分析" → /{asin}/start-analysis
                        │
                        └── task_full_auto_analysis (与模式A相同的完整流水线)
                                    │
                                    ├── Step 1: 科学学习 (维度+5W标签)
                                    │
                                    ├── Step 2: 洞察+主题提取 (并行)
                                    │
                                    ├── Step 3: 等待90%完成
                                    │
                                    └── Step 4: 自动报告 → ✅ 完成

---

**模式B特点：**
- **两步操作**: ① 只翻译 → ② 一键分析
- **适用场景**: 用户只想看翻译结果，或需要手动编辑维度后再分析
- **一键分析**: 点击后自动执行与模式A相同的完整流程（包括报告生成）
- **接口**: `POST /api/v1/products/{asin}/start-analysis`
```

---

## 🔄 详细数据流转过程

### **阶段 1: 数据采集 (Chrome 插件)**

#### 1.1 用户操作
- 用户访问亚马逊商品页面 (如 `amazon.com/dp/B08ABC123`)
- 点击浏览器工具栏的 VOC-Master 图标
- 在弹出窗口中配置采集参数:
  - 选择星级 (1-5星 或 全部星级)
  - 设置采集数量 (默认50条)
- 点击"开始采集"按钮

#### 1.2 采集过程 (content.js)
**关键文件**: `extension/src/content/content.js`

**步骤**:
1. **检测产品信息**
   - 从页面 DOM 中提取产品信息:
     - ASIN (产品唯一标识符)
     - 标题 (`#productTitle`)
     - 图片 URL (`#landingImage`)
     - 平均评分 (`#acrPopover`)
     - 价格 (`#priceblock_ourprice`)
     - 五点卖点 (`#feature-bullets`)

2. **智能翻页采集评论**
   - 逐页加载评论列表 (模拟人类滚动)
   - 从每条评论 DOM 中提取:
     ```javascript
     {
       review_id: "R123ABC...",    // 评论唯一ID
       rating: 5,                   // 1-5星
       title: "Great product!",     // 标题
       body: "This is amazing...",  // 正文
       author: "John Doe",          // 作者名
       review_date: "2024-01-15",   // 评论日期
       verified_purchase: true,     // 是否认证购买
       helpful_votes: 12,           // 有用票数
       review_url: "https://..."    // 评论链接
     }
     ```

3. **防反爬机制**
   - 随机延迟 2-5秒 模拟人类行为
   - 检测验证码 (`#captchacharacters`)
   - 自动暂停/恢复采集

4. **实时进度反馈**
   - 在页面上显示浮层进度条
   - 实时更新: "已采集 45/50 (3星: 10, 4星: 20, 5星: 15)"

#### 1.3 数据提交
**API 端点**: `POST /api/v1/reviews/ingest`

**请求体**:
```json
{
  "asin": "B08ABC123",
  "title": "Wireless Headphones",
  "image_url": "https://m.media-amazon.com/...",
  "marketplace": "amazon.com",
  "average_rating": 4.3,
  "price": "$59.99",
  "bullet_points": [
    "Active Noise Cancellation",
    "40-hour battery life",
    "...5条卖点..."
  ],
  "reviews": [
    {
      "review_id": "R123ABC...",
      "rating": 5,
      "title": "Great product!",
      "body": "This is amazing...",
      "author": "John Doe",
      "review_date": "2024-01-15",
      "verified_purchase": true,
      "helpful_votes": 12,
      "review_url": "https://..."
    },
    // ...更多评论...
  ]
}
```

---

### **阶段 2: 数据接收与存储 (FastAPI 后端)**

#### 2.1 接收数据
**关键文件**: `backend/app/api/reviews.py` → `ingest_reviews()`

**步骤**:
1. **验证数据完整性**
   - 检查 `reviews` 数组是否为空
   - 如果为空 → 返回错误提示 (可能未登录亚马逊)

2. **创建/更新产品记录**
   ```python
   product = await service.get_or_create_product(
       asin=request.asin,
       title=request.title,
       image_url=request.image_url,
       marketplace=request.marketplace,
       average_rating=request.average_rating,
       price=request.price,
       bullet_points=json.dumps(request.bullet_points)  # 存储为JSON
   )
   ```
   - **表**: `products`
   - **字段**: `id`, `asin`, `title`, `image_url`, `marketplace`, `average_rating`, `price`, `bullet_points`, `created_at`

3. **批量插入评论**
   ```python
   inserted, skipped = await service.bulk_insert_reviews(
       product_id=product.id,
       reviews_data=reviews_data
   )
   ```
   - **表**: `reviews`
   - **去重逻辑**: 通过 `(product_id, review_id)` 唯一索引自动跳过重复评论
   - **字段**: `id`, `product_id`, `review_id`, `rating`, `title_original`, `body_original`, `author`, `review_date`, `verified_purchase`, `helpful_votes`, `review_url`, `translation_status` (初始为 `pending`)

4. **返回响应**
   ```json
   {
     "success": true,
     "message": "Received 50 reviews, 45 new, 5 duplicates skipped",
     "product_id": "550e8400-e29b-41d4-a716-446655440000",
     "task_id": null,
     "reviews_received": 45,
     "dashboard_url": "http://localhost:3000/products/B08ABC123"
   }
   ```

---

### **阶段 3: 异步翻译处理 (Celery Worker)**

> **触发方式**: 用户在前端控制台手动点击"开始翻译"按钮

#### 3.1 任务队列架构
- **消息队列**: Redis (作为 Celery Broker)
- **任务类型**: 4个独立任务 (按顺序执行)
- **关键文件**: `backend/app/worker.py`

#### 3.2 Task 1: 翻译产品五点和标题
**任务名称**: `task_translate_bullet_points`

**触发条件**: 
- 产品标题未翻译 (`title_translated` 为空)
- 或五点卖点未翻译 (`bullet_points_translated` 为空)

**处理流程**:
1. 调用 Qwen API 翻译标题:
   ```python
   translated_title = translation_service.translate_product_title(product.title)
   # 输入: "Wireless Bluetooth Headphones"
   # 输出: "无线蓝牙耳机"
   ```

2. 调用 Qwen API 翻译五点:
   ```python
   translated_bullets = translation_service.translate_bullet_points(bullet_points)
   # 输入: ["Active Noise Cancellation", "40-hour battery life"]
   # 输出: ["主动降噪功能", "40小时续航"]
   ```

3. 更新产品表:
   ```sql
   UPDATE products
   SET title_translated = '无线蓝牙耳机',
       bullet_points_translated = '["主动降噪功能", "40小时续航"]'
   WHERE id = 'product_uuid';
   ```

#### 3.3 Task 2: 翻译评论内容
**任务名称**: `task_process_reviews`

**处理流程**:
1. **查询待翻译评论**
   ```sql
   SELECT * FROM reviews
   WHERE product_id = 'product_uuid'
     AND translation_status IN ('pending', 'processing', 'failed')
   ORDER BY review_date DESC;
   ```

2. **逐条调用 Qwen API 翻译**
   ```python
   for review in reviews:
       # 标记为处理中
       review.translation_status = 'processing'
       
       # 调用AI翻译 (带情感分析)
       title_translated, body_translated, sentiment, _ = translation_service.translate_review(
           title=review.title_original,
           body=review.body_original,
           extract_insights=False  # 仅翻译,不提取洞察
       )
       
       # Qwen 返回示例:
       # title_translated: "很棒的产品!"
       # body_translated: "这款耳机音质超赞,降噪效果一流..."
       # sentiment: "positive" / "neutral" / "negative"
       
       # 更新数据库
       review.title_translated = title_translated
       review.body_translated = body_translated
       review.sentiment = sentiment
       review.translation_status = 'completed'
       
       # 更新任务进度
       task.processed_items += 1
       
       # 限速: 每条评论间隔 0.2秒
       time.sleep(0.2)
   ```

3. **错误处理**
   - 如果翻译失败 → 标记 `translation_status = 'failed'`
   - 记录错误信息到 `tasks` 表
   - 支持手动重试

4. **数据库字段更新**
   - `reviews` 表:
     - `title_translated`: 翻译后的标题
     - `body_translated`: 翻译后的正文
     - `sentiment`: `positive` / `neutral` / `negative`
     - `translation_status`: `completed`

#### 3.4 Task 3: 提取维度洞察 (Insights)
**任务名称**: `task_extract_insights`

**触发方式**: 用户在前端点击"提取洞察"按钮 → `POST /api/v1/products/{asin}/extract-insights`

**处理流程**:
1. **查询已翻译的评论** (不含洞察的评论)
   ```sql
   SELECT r.* FROM reviews r
   LEFT JOIN review_insights i ON r.id = i.review_id
   WHERE r.product_id = 'product_uuid'
     AND r.translation_status = 'completed'
     AND i.id IS NULL  -- 没有洞察
   ORDER BY r.review_date DESC;
   ```

2. **逐条调用 AI 提取洞察**
   ```python
   for review in reviews:
       # 调用 AI 提取洞察
       insights = translation_service.extract_insights(
           original_text=review.body_original,
           translated_text=review.body_translated,
           dimension_schema=dimension_schema  # 可选:产品维度定义
       )
       
       # AI 返回格式 (JSON数组):
       [
         {
           "type": "strength",           # 洞察类型 (5类)
           "dimension": "音质",          # 维度名称
           "quote": "sound quality is amazing",         # 原文引用
           "quote_translated": "音质超赞",              # 中文引用
           "analysis": "用户对音质表现非常满意"         # AI分析
         },
         {
           "type": "weakness",
           "dimension": "续航",
           "quote": "battery drains fast",
           "quote_translated": "电池耗电快",
           "analysis": "用户反馈续航不足"
         },
         {
           "type": "suggestion",
           "dimension": "颜色",
           "quote": "wish it came in more colors",
           "quote_translated": "希望有更多颜色",
           "analysis": "用户建议增加配色选择"
         }
       ]
   ```

3. **存入数据库** (`review_insights` 表)
   ```sql
   INSERT INTO review_insights (
     review_id, 
     insight_type,      -- strength/weakness/suggestion/scenario/emotion
     dimension,         -- 音质/续航/外观/...
     quote,             -- 原文引用
     quote_translated,  -- 中文引用
     analysis           -- AI分析
   ) VALUES (...);
   ```

**5类洞察类型说明**:
- `strength`: 产品优势/卖点 (用于 Listing 五点描述和广告文案)
- `weakness`: 改进空间/痛点 (用于产品改进和客服 QA)
- `suggestion`: 用户建议 (产品经理的 Feature Request 池)
- `scenario`: 具体使用场景 (发现边缘场景/营销素材)
- `emotion`: 强烈情感洞察 (客服和公关关注点)

#### 3.4 Task 3.5: 学习产品维度
**任务名称**: 科学学习 - 维度发现

**触发方式**:
- **全自动模式**: `task_full_auto_analysis` 的 Step 1 会自动执行（**必须步骤**）
- **手动模式**: 用户点击"学习产品维度"按钮 → `POST /api/v1/products/{asin}/dimensions/generate`

> ⚠️ **重要**: 在全自动分析流程中，维度学习是**必须的前置步骤**，由 `task_full_auto_analysis` 保证在洞察提取之前完成。
> 只有在手动单独触发洞察提取时，如果没有维度，才会降级为通用维度自动判断。

**处理流程**:
1. **采样评论数据 (优先已翻译)**
   ```python
   # 获取最近50条评论
   reviews = await db.execute(
       select(Review.body_original, Review.body_translated)
       .where(Review.product_id == product_id)
       .order_by(Review.created_at.desc())
       .limit(50)
   )
   
   # 准备样本文本 (优先使用翻译文本)
   sample_texts = []
   for row in reviews:
       text = row.body_translated or row.body_original
       sample_texts.append(text.strip())
   ```

2. **获取产品官方信息**
   ```python
   # 产品标题
   product_title = "Wireless Bluetooth Headphones"
   
   # 五点卖点
   bullet_points = [
       "Active Noise Cancellation",
       "40-hour battery life",
       "Comfortable over-ear design",
       "Bluetooth 5.0 connectivity",
       "Foldable and portable"
   ]
   ```

3. **调用 AI 学习维度**
   ```python
   learned_dims = translation_service.learn_dimensions(
       reviews_text=sample_texts,      # 50条评论样本
       product_title=product_title,    # 产品标题 (提供上下文)
       bullet_points=bullet_points     # 五点卖点 (补充产品特性)
   )
   ```

4. **AI 学习过程 (Qwen API Prompt)**
   ```
   你是一位资深的产品经理和用户研究专家。请基于以下产品官方信息和用户评论样本,
   构建该产品的核心评价维度模型。
   
   # 产品官方信息
   - 产品标题: Wireless Bluetooth Headphones
   - 核心卖点 (Bullet Points):
     1. Active Noise Cancellation
     2. 40-hour battery life
     3. Comfortable over-ear design
     4. Bluetooth 5.0 connectivity
     5. Foldable and portable
   
   # 用户评论样本 (50条)
   "音质超赞,降噪效果一流..."
   "电池续航不如宣传的那么久..."
   "佩戴很舒服,长时间使用不累..."
   ... (共50条)
   
   # 任务: 提炼出 5-8 个核心评价维度
   
   # 要求
   1. 结合官方定义与用户视角 (维度名称应尽量使用官方术语)
   2. 维度名称: 使用简练的中文 (如: 音质表现、续航能力、佩戴舒适度)
   3. 维度定义: 用一句话描述该维度包含的具体内容
   4. 互斥性: 维度之间不要重叠
   5. 覆盖率: 必须覆盖评论中的主要痛点和爽点
   
   # 输出格式 (JSON Only)
   {
     "dimensions": [
       {"name": "音质表现", "description": "包括音质清晰度、低音效果等听觉体验"},
       ...
     ]
   }
   ```

5. **AI 返回示例**
   ```json
   {
     "dimensions": [
       {
         "name": "音质表现",
         "description": "包括音质清晰度、低音效果、高音表现等听觉体验相关评价"
       },
       {
         "name": "降噪效果",
         "description": "主动降噪(ANC)的强度、环境音隔离能力等降噪功能表现"
       },
       {
         "name": "续航能力",
         "description": "电池使用时长、充电速度、待机时间等电池相关表现"
       },
       {
         "name": "佩戴舒适度",
         "description": "耳罩材质、头梁压力、长时间佩戴的舒适性等人体工学评价"
       },
       {
         "name": "连接稳定性",
         "description": "蓝牙连接距离、信号稳定性、配对便利性等连接体验"
       },
       {
         "name": "外观设计",
         "description": "产品外观、配色、材质质感、折叠便携性等视觉和触觉评价"
       },
       {
         "name": "性价比",
         "description": "价格合理性、与竞品对比的性价比、物有所值的感受"
       }
     ]
   }
   ```

6. **存入数据库** (`product_dimensions` 表)
   ```sql
   INSERT INTO product_dimensions (
     product_id,
     name,
     description,
     is_ai_generated
   ) VALUES
   ('product_uuid', '音质表现', '包括音质清晰度、低音效果...', true),
   ('product_uuid', '降噪效果', '主动降噪(ANC)的强度...', true),
   ('product_uuid', '续航能力', '电池使用时长、充电速度...', true),
   ('product_uuid', '佩戴舒适度', '耳罩材质、头梁压力...', true),
   ('product_uuid', '连接稳定性', '蓝牙连接距离、信号稳定性...', true),
   ('product_uuid', '外观设计', '产品外观、配色、材质质感...', true),
   ('product_uuid', '性价比', '价格合理性、与竞品对比...', true);
   ```

**维度的作用**:
- 当执行 Task 3 (提取洞察) 时,AI 会**强制归类**到这些维度
- 如果没有定义维度,AI 会自动判断并归类为通用维度 (如 "整体满意度"、"其他")
- 维度支持手动添加/编辑/删除

**示例对比 (有无维度 Schema)**:

| 评论内容 | 无维度 Schema (自动判断) | 有维度 Schema (强制归类) |
|---------|------------------------|------------------------|
| "音质超赞" | dimension: "整体满意度" | dimension: "音质表现" ✅ |
| "电池不耐用" | dimension: "产品质量" | dimension: "续航能力" ✅ |
| "太重了" | dimension: "其他" | dimension: "外观设计" ✅ |
| "戴久了耳朵疼" | dimension: "使用体验" | dimension: "佩戴舒适度" ✅ |

**前端操作流程**:
```
产品详情页 → 点击 "学习产品维度" 按钮
↓
后端调用 AI 学习 (30秒)
↓
返回维度列表 (可编辑)
↓
用户可手动调整维度名称和定义
↓
保存后,提取洞察时会使用这些维度
```

---

#### 3.5 Task 4: 提取5W主题高亮 (Themes)
**任务名称**: `task_extract_themes`

**触发方式**: 用户在前端点击"提取主题"按钮 → `POST /api/v1/products/{asin}/extract-themes`

**处理流程**:
1. **自动学习标签库 (Definition 阶段)**
   - **检查**: 产品是否已有5W标签库
   - **如果没有** → 自动生成:
     ```python
     # 采样50条已翻译评论
     sample_reviews = get_sample_reviews(product_id, limit=50)
     
     # 调用 AI 学习5W标签
     learned_labels = translation_service.learn_context_labels(
         reviews_text=sample_reviews,
         product_title=product.title,
         bullet_points=bullet_points
     )
     
     # AI 返回示例:
     {
       "who": [
         {"name": "老人", "description": "老年用户"},
         {"name": "儿童", "description": "儿童用户"},
         {"name": "运动爱好者", "description": "健身运动人群"}
       ],
       "where": [
         {"name": "家中", "description": "家庭使用"},
         {"name": "健身房", "description": "运动场景"},
         {"name": "办公室", "description": "办公场景"}
       ],
       "when": [
         {"name": "工作时", "description": "工作期间使用"},
         {"name": "睡前", "description": "睡觉前使用"}
       ],
       "why": [
         {"name": "降噪", "description": "需要降噪功能"},
         {"name": "音质", "description": "追求音质"}
       ],
       "what": [
         {"name": "听音乐", "description": "主要用于音乐"},
         {"name": "看视频", "description": "视频娱乐"}
       ]
     }
     ```
   - 存入 `product_context_labels` 表

2. **强制归类提取主题 (Execution 阶段)**
   ```python
   # 查询未提取主题的评论
   reviews = get_reviews_without_themes(product_id)
   
   for review in reviews:
       # 调用 AI 提取5W主题 (强制匹配到标签库)
       themes = translation_service.extract_themes(
           original_text=review.body_original,
           translated_text=review.body_translated,
           context_schema=context_schema  # 注入5W标签库
       )
       
       # AI 返回格式:
       {
         "who": [
           {
             "content": "老人",
             "quote": "my elderly father loves it",
             "quote_translated": "我的老父亲很喜欢",
             "explanation": "评论提到老年父亲是使用者"
           }
         ],
         "where": [
           {
             "content": "健身房",
             "quote": "use them at the gym",
             "quote_translated": "在健身房使用",
             "explanation": "明确提到健身房场景"
           }
         ],
         "when": [...],
         "why": [...],
         "what": [...]
       }
   ```

3. **存入数据库** (`review_theme_highlights` 表)
   ```sql
   INSERT INTO review_theme_highlights (
     review_id,
     theme_type,        -- who/where/when/why/what
     label_name,        -- 标签名称 (如"老人")
     quote,             -- 原文证据
     quote_translated,  -- 中文证据
     explanation,       -- 归类理由
     context_label_id   -- 关联标签库ID
   ) VALUES (...);
   ```

**5W 框架说明**:
- `who`: 使用者是谁 (用户画像)
- `where`: 在哪里用 (使用场景)
- `when`: 何时使用 (使用时机)
- `why`: 购买动机 (核心需求)
- `what`: 具体用途 (Jobs-to-be-Done)

---

### **阶段 3.6: 维度 (Dimensions) vs 5W标签 (Context Labels) 的区别**

> **重要说明**: 很多人会混淆这两个概念,让我们明确它们的区别和关系

#### 📊 对比表格

| 特性 | product_dimensions (产品维度) | product_context_labels (5W标签库) |
|------|------------------------------|--------------------------------|
| **用途** | 用于**评价产品功能和属性** | 用于**描述用户和使用情境** |
| **关联任务** | Task 3: 提取洞察 (Insights) | Task 4: 提取5W主题 (Themes) |
| **维度数量** | 5-8个核心维度 | 每个5W类型3-8个标签 (共15-40个) |
| **示例** | 音质表现、续航能力、佩戴舒适度、连接稳定性 | Who: 老人/儿童/运动爱好者<br>Where: 家中/健身房/办公室<br>When: 工作时/睡前 |
| **AI分类方式** | 将洞察(优势/痛点/建议)归类到维度 | 将评论中的5W要素归类到标签 |
| **存储表** | `product_dimensions` | `product_context_labels` |
| **分类结果表** | `review_insights` | `review_theme_highlights` |

#### 🔍 具体示例

**评论**: "我是一名健身爱好者,在健身房用这款耳机听音乐,音质很棒但是电池续航不够用,希望能增加快充功能。"

**维度提取 (Dimensions - 评价产品)**:
```json
// 存入 review_insights 表
[
  {
    "type": "strength",
    "dimension": "音质表现",  ← 使用 product_dimensions
    "quote": "音质很棒"
  },
  {
    "type": "weakness",
    "dimension": "续航能力",  ← 使用 product_dimensions
    "quote": "电池续航不够用"
  },
  {
    "type": "suggestion",
    "dimension": "续航能力",  ← 使用 product_dimensions
    "quote": "希望能增加快充功能"
  }
]
```

**5W提取 (Context Labels - 描述用户和情境)**:
```json
// 存入 review_theme_highlights 表
{
  "who": [{
    "label_name": "运动爱好者",  ← 使用 product_context_labels
    "quote": "我是一名健身爱好者"
  }],
  "where": [{
    "label_name": "健身房",      ← 使用 product_context_labels
    "quote": "在健身房用"
  }],
  "what": [{
    "label_name": "听音乐",      ← 使用 product_context_labels
    "quote": "听音乐"
  }]
}
```

#### 💡 核心理解

**Dimensions (产品维度)** 回答:
- ❓ 这个产品**哪些方面**表现好/不好?
- 📊 用于分析**产品属性**的优劣
- 🎯 目标: 改进产品设计和功能

**5W Labels (用户情境标签)** 回答:
- ❓ **谁**在**何时何地**因为**什么原因**用它做**什么**?
- 👥 用于理解**用户画像和使用情境**
- 🎯 目标: 精准营销和场景化运营

#### 🔄 工作流程

```
用户采集评论
    ↓
翻译评论 (流式翻译)
    ↓
┌─────────────────────────────────────────────┐
│  ⭐ Step 1: 科学学习 (必须先执行！)          │
│  ┌─────────────────┬─────────────────┐      │
│  │ 学习维度         │ 学习5W标签       │      │
│  │ (维度发现)       │ (标签发现)       │      │
│  └─────────────────┴─────────────────┘      │
│                     ↓                        │
│          同步等待学习完成                     │
└─────────────────────────────────────────────┘
                      ↓
┌─────────────────────┬──────────────────────┐
│                     │                      │
│  提取洞察 (Task 3)   │  提取5W主题 (Task 4)  │
│  ⚡ 依赖维度Schema   │  ⚡ 依赖5W标签库      │
│                     │                      │
│  - 音质表现 (优势)   │  - Who: 运动爱好者    │
│  - 续航能力 (痛点)   │  - Where: 健身房     │
│  - 性价比 (建议)     │  - When: 工作时      │
│                     │  - Why: 降噪需求     │
│  ↓                  │  - What: 听音乐      │
│  review_insights    │  review_theme_hl...  │
└─────────────────────┴──────────────────────┘
              ↓
        聚合统计
              ↓
        生成报告
```

> ⚠️ **重要**: 在任何AI分析流程中，**学习步骤是必须的前置条件**。
> `task_full_auto_analysis` 的 Step 1 会同步执行学习，确保 Step 2 的提取任务有正确的 Schema 依赖。

#### ❌ 常见错误理解

**错误 1**: "维度和5W不是一回事吗?"
- ❌ 不是! 维度是评价产品,5W是描述用户
- ✅ 维度 = 产品视角, 5W = 用户视角

**错误 2**: "可以不学习维度和5W标签吗?"
- ❌ **在全自动分析流程中，学习是必须的前置步骤！**
- 📋 `task_full_auto_analysis` 的 Step 1 会强制执行学习，然后才触发提取
- ⚠️ 如果跳过学习直接单独触发提取任务（降级模式）:
  - 维度: AI自动判断，维度名称不统一，难以聚合（如 "其他"、"整体满意度"）
  - 5W: AI自由提取，标签名称不统一，难以聚合统计

**正确理解**: "学习和提取的执行顺序"
- ⭐ **必须顺序**: 先学习 → 后提取
- 💡 `task_full_auto_analysis` 自动保证这个顺序：
  - Step 1: 同步执行维度学习 + 5W标签学习
  - Step 2: 学习完成后，异步触发洞察提取 + 主题提取

#### 📈 数据聚合时的应用

**报告生成时**:
```python
# 聚合维度数据 (用于评价产品)
insight_stats = {
  "strength": {  # 优势
    "音质表现": {"count": 30, "percent": 37.5},
    "降噪效果": {"count": 20, "percent": 25.0}
  },
  "weakness": {  # 痛点
    "续航能力": {"count": 15, "percent": 18.8},
    "连接稳定性": {"count": 10, "percent": 12.5}
  }
}

# 聚合5W数据 (用于理解用户)
context_stats = {
  "who": {
    "运动爱好者": {"count": 25, "percent": 30.0},
    "老人": {"count": 20, "percent": 24.0}
  },
  "where": {
    "健身房": {"count": 18, "percent": 21.6},
    "家中": {"count": 35, "percent": 42.2}
  }
}
```

**AI 报告生成时会交叉分析**:
- 如果 `who=运动爱好者` 且 `weakness=续航能力` → 建议: "运动人群使用时长较长,需优先提升续航"
- 如果 `where=健身房` 且 `strength=降噪效果` → 卖点: "在嘈杂的健身房环境中依然享受纯净音质"

---

### **阶段 4: 数据聚合与统计分析**

#### 4.1 统计数据结构

**关键文件**: `backend/app/services/summary_service.py`

系统会将提取的洞察和主题数据聚合成可视化图表数据:

**5W Context 统计**:
```json
{
  "who": {
    "total_count": 150,
    "items": [
      {
        "name": "老人",
        "value": 45,
        "percent": 30.0,
        "evidence": [
          {
            "review_id": "uuid-1",
            "quote": "我的老父亲很喜欢",
            "rating": 5,
            "date": "2024-01-15"
          }
        ]
      },
      {"name": "儿童", "value": 30, "percent": 20.0}
    ]
  },
  "where": {...},
  "when": {...},
  "why": {...},
  "what": {...}
}
```

**5类 Insight 统计**:
```json
{
  "strength": {
    "total_count": 80,
    "items": [
      {
        "name": "音质",
        "value": 30,
        "percent": 37.5,
        "evidence": [
          {
            "review_id": "uuid-1",
            "quote": "音质超赞",
            "analysis": "用户称赞音质",
            "rating": 5
          }
        ]
      }
    ]
  },
  "weakness": {...},
  "suggestion": {...},
  "scenario": {...},
  "emotion": {...}
}
```

---

### **阶段 5: 智能报告生成**

#### 5.1 报告类型 (四位一体决策中台)

**触发方式（推荐）**: `POST /api/v1/products/{asin}/report/generate-async?report_type=comprehensive`  
**触发方式（同步）**: `POST /api/v1/products/{asin}/report/generate?report_type=comprehensive`

> **🆕 异步报告生成（2026-01-15 新增）**：
> - 推荐使用异步接口，避免前端页面卡顿
> - 立即返回 `task_id`，用户可离开页面
> - 通过 `GET /api/v1/products/{asin}/report/task/{task_id}` 轮询状态
> - 报告生成完成后返回 `report_id`

系统支持4种角色化报告:

| 报告类型 | 目标受众 | 核心内容 |
|---------|---------|---------|
| `comprehensive` | CEO/企业高管 | SWOT分析、市场定位、部门指令、风险等级 |
| `operations` | CMO/运营市场 | 卖点挖掘、广告定位、差评话术、Listing优化 |
| `product` | CPO/产品研发 | 质量评分、缺陷分析、迭代建议、易用性问题 |
| `supply_chain` | 供应链/质检 | 材质问题、包装优化、QC清单、退货原因 |

#### 5.2 报告生成流程

**关键文件**: `backend/app/services/summary_service.py` → `generate_report()`

**核心生成步骤**:
1. **验证数据量**
   ```python
   total_reviews = await _count_translated_reviews(product_id)
   if total_reviews < 10:
       return {"success": False, "error": "数据量不足"}
   ```

2. **聚合原始数据**
   ```python
   # 聚合5W Context数据
   context_stats = await _aggregate_5w_stats(product_id)
   
   # 聚合5类Insight数据
   insight_stats = await _aggregate_insight_stats(product_id)
   ```

3. **格式化数据喂给 AI**
   ```python
   stats_text = f"""
   === 📊 基础信息 ===
   - 分析样本: {total_reviews} 条已翻译评论
   
   === 📊 PART 1: 5W Context (宏观画像) ===
   - Who (核心人群): 老人(45次, 30%), 儿童(30次, 20%)
   - Where (使用地点): 家中(37次, 24.7%), 健身房(17次, 11.3%)
   - When (使用时机): 工作时(18次, 12%), 睡前(11次, 7.3%)
   - Why (购买动机): 降噪(23次, 15.3%), 音质(15次, 10%)
   - What (用户任务): 听音乐(38次, 25.3%), 看视频(19次, 12.7%)
   
   === 📉 PART 2: Deep Insights (微观洞察 - 5类) ===
   1. [Strength - 卖点库]: 音质(30次, 37.5%), 降噪(20次, 25%)
   2. [Weakness - 痛点库]: 续航(15次, 18.8%), 连接不稳(10次, 12.5%)
   3. [Suggestion - 用户心声]: 增加配色(8次, 10%), 改进包装(5次, 6.3%)
   4. [Scenario - 行为故事]: 长途飞行(12次, 15%), 健身房(7次, 8.8%)
   5. [Emotion - 情绪预警]: 惊喜好评(15次, 18.8%), 失望吐槽(6次, 7.5%)
   """
   ```

4. **选择对应角色 Prompt 模板**
   ```python
   # 例如: CEO综合版
   prompt = f"""
   你是一位企业CEO兼战略顾问。请基于"用户画像(5W)"和"口碑洞察(Dimensions)"数据,
   生成一份全局战略分析报告 (JSON)。
   
   # 输入数据
   {stats_text}
   
   # 必填字段 (JSON Key)
   1. "user_profile": 用户画像深度分析
   2. "strategic_verdict": 3句话的战略定调
   3. "core_swot": SWOT分析 (每项需带source_tag用于溯源)
   4. "department_directives": 给各部门的一句话指令
   5. "priority_actions": Top 3 优先行动项
   6. "risk_level": 风险等级 (low/medium/high/critical)
   
   要求: 只输出纯JSON,简体中文。
   """
   ```

5. **调用 Qwen AI 生成报告**
   ```python
   response = translation_service.client.chat.completions.create(
       model="qwen-plus",
       messages=[
           {"role": "system", "content": "You are a data analyst. Output JSON only."},
           {"role": "user", "content": prompt}
       ],
       temperature=0.4,
       max_tokens=3500,
       response_format={"type": "json_object"}  # 强制JSON输出
   )
   
   content_json = response.choices[0].message.content
   ```

6. **AI 返回示例 (CEO综合版)**
   ```json
   {
     "user_profile": {
       "core_users": "中老年人和家庭主妇为主要用户群体",
       "user_characteristics": ["注重实用性", "价格敏感", "追求性价比"],
       "usage_scenarios": "主要在家庭环境使用,包括客厅和卧室",
       "purchase_motivation": "降噪需求为核心,音质为次要考量",
       "jobs_to_be_done": "听音乐、看视频、工作专注",
       "persona_insight": "典型用户为追求安静环境的居家人群"
     },
     "strategic_verdict": "产品在音质和降噪功能上表现强劲,但续航和连接稳定性严重拖后腿,建议优先整改质量问题再扩大市场投入。",
     "market_fit_analysis": "产品准确抓住了居家场景的降噪需求,但在健身房等移动场景下表现不佳,存在场景错位。",
     "core_swot": {
       "strengths": [
         {"point": "音质表现优秀", "source_tag": "音质"},
         {"point": "降噪效果显著", "source_tag": "降噪"}
       ],
       "weaknesses": [
         {"point": "续航时间不足", "source_tag": "续航"},
         {"point": "蓝牙连接不稳定", "source_tag": "连接不稳"}
       ],
       "opportunities": [
         "扩展配色选择可吸引年轻用户",
         "优化包装可降低破损率"
       ],
       "threats": [
         "竞品在同价位提供更长续航",
         "用户对连接问题容忍度低"
       ]
     },
     "department_directives": {
       "to_marketing": "主打降噪卖点,避免提及续航,重点攻克居家场景",
       "to_product": "立即解决蓝牙芯片问题,下一代必须提升续航至40小时",
       "to_supply_chain": "更换电池供应商,加强包装测试"
     },
     "priority_actions": [
       {
         "action": "召回质量团队分析续航问题根因",
         "owner": "CTO",
         "deadline": "本周内",
         "source_tag": "续航"
       },
       {
         "action": "暂停所有广告投放,避免扩大差评影响",
         "owner": "CMO",
         "deadline": "立即",
         "source_tag": "连接不稳"
       },
       {
         "action": "启动用户召回计划,免费更换问题批次",
         "owner": "客服总监",
         "deadline": "本月内",
         "source_tag": "质量投诉"
       }
     ],
     "risk_level": "high"
   }
   ```

7. **持久化存储**
   ```python
   # 存入 product_reports 表
   report = ProductReport(
       product_id=product_id,
       title="全维度战略分析报告 - 2024-01-20 15:30",
       content=content_json,        # AI的观点 (JSON)
       report_type="comprehensive",
       analysis_data={               # 原始统计数据 (给前端画图)
           "total_reviews": 150,
           "context": context_stats,
           "insight": insight_stats,
           "meta": {...}
       },
       status="completed"
   )
   ```

---

### **阶段 6: 数据透视与数据总览分析**

> **🆕 新增功能（2026-01-25）**：
> - 数据透视：专注于交叉分析（2D/3D组合）推理决策
> - 数据总览：专注于单维度总结分析对比
> - 两个模块独立生成，互不依赖

#### 6.1 数据透视分析 (Pivot Insights)

**业务定位**：通过2D/3D交叉矩阵分析，发现维度间的关联关系和决策洞察

**触发方式**：
- **分享页面**: `POST /api/v1/share/{token}/generate-pivot-insights` (异步)
- **轮询状态**: `GET /api/v1/share/{token}/generate-pivot-insights/{task_id}`
- **获取结果**: `GET /api/v1/share/{token}/pivot-insights`

**关键文件**: 
- `backend/app/services/pivot_insight_service.py` - 数据透视分析服务
- `backend/app/services/pivot_insight_prompts.py` - AI Prompt模板管理

**数据来源**：
- `review_theme_highlights` 表：用于 buyer, user, where, when, why 维度
- `review_insights` 表：用于 strength, weakness, suggestion, scenario, emotion 维度
- `reviews` 表：用于 sentiment, rating, helpful_votes 统计

**分析流程**：

1. **数据准备**
   ```python
   # 获取产品所有评论
   reviews = db.query(Review).filter(Review.product_id == product_id).all()
   
   # 查询主题标签（5W维度）
   theme_highlights = db.query(ReviewThemeHighlight).filter(
       ReviewThemeHighlight.review_id.in_([r.id for r in reviews])
   ).all()
   
   # 查询洞察数据（5类洞察）
   insights = db.query(ReviewInsight).filter(
       ReviewInsight.review_id.in_([r.id for r in reviews])
   ).all()
   ```

2. **生成5大洞察模块（20个子模块）**

   **A. 人群洞察 (Audience Insights)**
   - `decision_flow`: 决策链路分析 (buyer × user)
   - `decision_logic_chain`: 决策逻辑链 (buyer × user × motivation) - 3D
   - `audience_strength`: 人群优势映射 (buyer × strength)

   **B. 需求洞察 (Demand Insights)**
   - `motivation_location`: 动机×地点 (why × where)
   - `motivation_emotion`: 动机×情感 (why × emotion)
   - `rnd_priority`: 研发优先级 (buyer × user × motivation) - 3D
   - `demand_satisfaction`: 需求满足度 (why × sentiment)

   **C. 产品洞察 (Product Insights)**
   - `strength_weakness`: 优劣势对比 (strength × weakness)
   - `strength_emotion`: 优势×情感 (strength × emotion)
   - `critical_weakness`: 关键劣势 (weakness × sentiment)
   - `improvement_priority`: 改进优先级 (where × suggestion)
   - `motivation_suggestion`: 动机×建议 (why × suggestion)
   - `negative_optimization`: 负面优化 (strength × suggestion)

   **D. 场景洞察 (Scenario Insights)**
   - `scenario_distribution`: 场景分布 (where × when)
   - `scenario_sentiment`: 场景×情感 (scenario × emotion)
   - `life_moment`: 真实生活瞬间 (location × time × scenario) - 3D
   - `environment_conflict`: 环境冲突 (emotion × dimension × location) - 3D

   **E. 品牌洞察 (Brand Insights)**
   - `brand_memory`: 品牌记忆点 (strength × scenario × emotion) - 3D
   - `recommendation_willingness`: 推荐意愿 (rating × helpful_votes)
   - `brand_mind`: 品牌核心心智 (strength统计分布)

3. **数据矩阵计算**
   ```python
   # 示例：决策链路分析 (buyer × user)
   buyer_user_pairs = {}
   for review in reviews:
       buyers = [th.dimension for th in theme_highlights 
                 if th.review_id == review.id and th.theme_type == 'buyer']
       users = [th.dimension for th in theme_highlights 
                if th.review_id == review.id and th.theme_type == 'user']
       
       for buyer in buyers:
           for user in users:
               key = f"{buyer}×{user}"
               buyer_user_pairs[key] = buyer_user_pairs.get(key, 0) + 1
   
   # 返回矩阵数据
   return {
       "buyerUserMatrix": buyer_user_pairs,
       "buyers": list(set([...])),
       "users": list(set([...]))
   }
   ```

4. **AI解读生成**
   ```python
   # 使用标准化的Prompt模板
   prompt = generate_pivot_insight_prompt(
       sub_type="decision_flow",
       data=matrix_data,
       total_reviews=len(reviews)
   )
   
   # 调用AI生成解读
   ai_response = translation_service.client.chat.completions.create(
       model="qwen-max",
       messages=[{"role": "user", "content": prompt}],
       response_format={"type": "json_object"}
   )
   
   # 解析AI返回
   interpretation = json.loads(ai_response.choices[0].message.content)
   # 结构: { keyFindings: [], dataSupport: [], recommendations: [], severity: 'success'|'warning'|'critical' }
   ```

5. **存储到数据库**
   ```python
   # 存入 product_pivot_insights 表
   insight = ProductPivotInsight(
       product_id=product_id,
       insight_type="audience",  # audience/demand/product/scenario/brand
       sub_type="decision_flow",
       insight_data=interpretation,  # AI生成的JSON
       raw_data=matrix_data,  # 原始矩阵数据
       generation_status="completed"
   )
   ```

**数据格式示例**：
```json
{
  "insight_type": "audience",
  "sub_type": "decision_flow",
  "insight_data": {
    "severity": "success",
    "dataSupport": [
      {"value": "38", "metric": "总配对数"},
      {"value": "3个（宝妈、祖辈、送礼者）", "metric": "购买者身份类型数"}
    ],
    "keyFindings": [
      "宝妈是绝对主导购买者，覆盖7种使用者类型（占比92.1%，35/38次配对）",
      "存在明显的决策错位：祖辈购买但儿童使用（占比7.9%，3/38次配对）"
    ],
    "recommendations": [
      "针对'宝妈-学龄前儿童'核心配对（34.2%）优化详情页首屏",
      "为祖辈购买者提供'适合送礼'的包装和说明"
    ]
  }
}
```

#### 6.2 数据总览分析 (Dimension Summaries)

**业务定位**：对单维度进行深度总结，提供维度特征、趋势和消费者画像

**触发方式**：
- **分享页面**: `POST /api/v1/share/{token}/generate-summaries` (异步)
- **轮询状态**: `GET /api/v1/share/{token}/generate-summaries/{task_id}`
- **获取结果**: `GET /api/v1/share/{token}` (返回 `dimension_summaries` 字段)

**关键文件**: 
- `backend/app/services/dimension_summary_service.py` - 数据总览分析服务

**数据来源**：
- `aggregated_themes`: 5W主题聚合统计
- `aggregated_insights`: 5类洞察聚合统计
- `reviews` 表：评论基础数据

**分析流程**：

1. **数据聚合**
   ```python
   # 聚合5W主题数据
   aggregated_themes = {
       "buyer": {"宝妈": 45, "祖辈": 12, ...},
       "user": {"学龄前儿童": 38, "小学生": 15, ...},
       "where": {"家中": 37, "户外": 17, ...},
       "when": {"工作时": 18, "睡前": 11, ...},
       "why": {"感官发育": 23, "教育启蒙": 15, ...},
       "what": {"听音乐": 38, "看视频": 19, ...}
   }
   
   # 聚合洞察数据
   aggregated_insights = {
       "strengths": {"音质": 30, "降噪": 20, ...},
       "weaknesses": {"续航": 15, "连接不稳": 10, ...},
       "suggestions": {"增加配色": 8, "改进包装": 5, ...},
       "scenarios": {"长途飞行": 12, "健身房": 7, ...},
       "emotions": {"惊喜好评": 15, "失望吐槽": 6, ...}
   }
   ```

2. **生成6大总结模块**

   **A. 5W主题总结**
   - `theme_buyer`: 购买者画像总结
   - `theme_user`: 使用者画像总结
   - `theme_where`: 使用地点总结
   - `theme_when`: 使用时机总结
   - `theme_why`: 购买动机总结
   - `theme_what`: 用户任务总结

   **B. 维度总结**
   - `dimension`: 产品维度总结（strength/weakness维度）

   **C. 情感总结**
   - `emotion`: 情感维度总结

   **D. 场景总结**
   - `scenario`: 场景维度总结

   **E. 消费者原型**
   - `consumer_persona`: 消费者原型画像（综合5W信息）

   **F. 整体总结**
   - `overall`: 整体数据总结

3. **AI总结生成**
   ```python
   # 为每个维度生成总结
   for summary_type in ['theme_buyer', 'theme_user', ...]:
       # 构建Prompt
       prompt = f"""
       你是一位数据分析师。请基于以下数据，生成{summary_type}的深度总结。
       
       数据：
       {aggregated_data[summary_type]}
       
       要求：
       1. 生成标题和总结内容
       2. 提取3-5个核心要点（带证据数量）
       3. 判断情感倾向（positive/negative/neutral/mixed）
       4. 输出JSON格式
       """
       
       # 调用AI
       ai_response = translation_service.client.chat.completions.create(...)
       summary = json.loads(ai_response.choices[0].message.content)
   ```

4. **存储到数据库**
   ```python
   # 存入 product_dimension_summaries 表
   summary = ProductDimensionSummary(
       product_id=product_id,
       summary_type="theme_buyer",
       category="宝妈",
       title="宝妈购买者画像分析",
       summary="用户普遍反馈...",
       key_points=[
           {"point": "主要购买者", "evidence_count": 45},
           {"point": "注重实用性", "evidence_count": 32}
       ],
       sentiment_tendency="positive",
       evidence_count=77
   )
   ```

**数据格式示例**：
```json
{
  "summary_type": "theme_buyer",
  "category": "宝妈",
  "title": "宝妈购买者画像分析",
  "summary": "宝妈是产品的绝对主导购买者，占比75%...",
  "key_points": [
    {"point": "主要购买者，占比75%", "evidence_count": 45},
    {"point": "注重产品实用性和安全性", "evidence_count": 32}
  ],
  "sentiment_tendency": "positive",
  "evidence_count": 77
}
```

#### 6.3 数据透视与数据总览的区别

| 维度 | 数据透视 (Pivot Insights) | 数据总览 (Dimension Summaries) |
|------|-------------------------|------------------------------|
| **业务定位** | 交叉分析（2D/3D组合）推理决策 | 单维度总结分析对比 |
| **分析粒度** | **关系洞察**（购买者×使用者、动机×地点等） | **维度描述**（某个维度的特征、趋势） |
| **数据输入** | 预聚合矩阵（交叉关系） | 聚合统计数据（单维度） |
| **输出内容** | 交叉关系的洞察（决策错位、刚需场景等） | 单维度的总结（购买者画像、维度特征等） |
| **前端展示** | 数据透视Tab（20个子模块） | 数据总览Tab（6大总结模块） |
| **存储表** | `product_pivot_insights` | `product_dimension_summaries` |

#### 6.4 前端展示流程

**分享页面URL**: `http://localhost:3000/share/{token}`

**数据加载流程**：
1. **加载基础数据**
   ```typescript
   // GET /api/v1/share/{token}
   const response = await fetch(`/api/v1/share/${token}`);
   const data = await response.json();
   // 包含: reviews, aggregated_themes, aggregated_insights, dimension_summaries
   ```

2. **加载数据透视洞察**
   ```typescript
   // GET /api/v1/share/{token}/pivot-insights
   const pivotResponse = await fetch(`/api/v1/share/${token}/pivot-insights`);
   const pivotData = await pivotResponse.json();
   // 包含: insights.audience, insights.demand, insights.product, insights.scenario, insights.brand
   ```

3. **生成数据透视报告（可选）**
   ```typescript
   // POST /api/v1/share/{token}/generate-pivot-insights
   const generateResponse = await fetch(`/api/v1/share/${token}/generate-pivot-insights`, {
     method: 'POST'
   });
   const { task_id } = await generateResponse.json();
   
   // 轮询任务状态
   const pollStatus = async () => {
     const statusResponse = await fetch(`/api/v1/share/${token}/generate-pivot-insights/${task_id}`);
     const status = await statusResponse.json();
     if (status.status === 'completed') {
       // 重新加载数据
       await loadPivotInsights();
     }
   };
   ```

**前端组件结构**：
- `PivotInsightReport.tsx`: 数据透视报告主组件
  - `AudienceInsight.tsx`: 人群洞察模块
  - `DemandInsight.tsx`: 需求洞察模块
  - `ProductInsight.tsx`: 产品洞察模块
  - `ScenarioInsight.tsx`: 场景洞察模块
  - `BrandInsight.tsx`: 品牌洞察模块
- `DimensionSummaryReport.tsx`: 数据总览报告主组件
  - 展示6大总结模块的卡片式布局

---

### **阶段 7: 竞品对比分析**

#### 6.1 对比分析架构

**触发方式**: 
1. 用户在前端选择2-5个产品
2. 创建对比项目: `POST /api/v1/analysis/projects`
3. 系统自动触发分析

**关键文件**: `backend/app/services/analysis_service.py`

#### 6.2 对比分析流程

**步骤**:
1. **收集产品数据**
   ```python
   for product in products:
       # 聚合每个产品的5W和5类Insight数据
       context_stats = await _aggregate_5w_stats(product.id)
       insight_stats = await _aggregate_insight_stats(product.id)
       
       # 精简为Top 20标签 (减少Token消耗)
       product_data = {
           "name": "产品A (耳机)",
           "asin": "B08ABC123",
           "data": {
               "user_context": simplify_stats(context_stats),
               "key_insights": simplify_stats(insight_stats)
           }
       }
   ```

2. **并行调用 AI 分析每个产品**
   ```python
   # 为每个产品生成独立的画像
   for product_data in products:
       profile = await analyze_single_product(product_data)
   
   # AI返回示例:
   {
     "product_name": "产品A (耳机)",
     "asin": "B08ABC123",
     "five_w": {
       "who": [{"label": "老人", "desc": "主要使用者", "count": 42}],
       "when": [{"label": "工作时", "desc": "使用频率最高", "count": 18}],
       ...
     },
     "dimensions": {
       "pros": [{"label": "音质", "desc": "音质超赞", "count": 31}],
       "cons": [{"label": "续航", "desc": "电池不耐用", "count": 15}],
       ...
     }
   }
   ```

3. **生成维度洞察 (10个维度)**
   ```python
   # 将所有产品的画像汇总,生成对比洞察
   dimension_insights = await generate_dimension_insights(product_profiles)
   
   # AI返回示例:
   {
     "dimension_insights": {
       "who": {
         "name": "用户是谁",
         "commonality": "五款产品均定位于减压解压赛道",
         "differences": [
           {"product": 1, "text": "全年龄覆盖,大众市场"},
           {"product": 2, "text": "深耕特殊儿童市场"}
         ],
         "positioning": [
           {"product": 1, "text": "大众减压工具,追求市场覆盖最大化"},
           {"product": 2, "text": "医疗康复赛道,建立专业护城河"}
         ]
       },
       "pros": {...},
       "cons": {...},
       ...
     }
   }
   ```

4. **生成策略总结**
   ```python
   strategy_summary = await generate_strategy_summary(product_profiles)
   
   # AI返回示例:
   {
     "market_summary": "市场呈现差异化竞争格局,产品1占据大众市场,产品2主攻细分领域",
     "strategy_summary": {
       "market_positioning": {
         "title": "市场定位策略",
         "emoji": "🎯",
         "content": "产品1应强化性价比优势,产品2应深化专业医疗认证..."
       },
       "scenario_deep_dive": {...},
       "growth_opportunities": {...}
     }
   }
   ```

5. **存入数据库** (`analysis_projects` 表)
   ```json
   {
     "product_profiles": [...],          // 每个产品的详细画像
     "dimension_insights": {...},        // 10个维度的对比洞察
     "market_summary": "...",            // 市场总结
     "strategy_summary": {...}           // 策略建议
   }
   ```

---

### **阶段 8: 前端展示与交互**

#### 7.1 产品列表页
**URL**: `http://localhost:3000/`

**展示内容**:
- 所有已采集的产品卡片
- 每个产品的统计信息:
  - 总评论数 (已翻译/总数)
  - 平均评分
  - 采集时间
- 操作按钮:
  - 查看详情
  - 开始翻译
  - 删除产品

#### 7.2 产品详情页
**URL**: `http://localhost:3000/products/{asin}`

**布局**:
```
┌─────────────────────────────────────────────┐
│  产品信息卡片                                │
│  - 标题 (中英双语)                           │
│  - 图片                                      │
│  - 五点卖点 (中英双语)                       │
│  - 平均评分                                  │
│  - 操作按钮: 开始翻译 / 提取洞察 / 提取主题  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  数据概览 (统计卡片)                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │总评论数 │ │已翻译数 │ │洞察数量 │       │
│  └─────────┘ └─────────┘ └─────────┘       │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  评论列表 (双语卡片)                         │
│  ┌───────────────────────────────────────┐  │
│  │ ⭐⭐⭐⭐⭐ (5星)  John Doe  2024-01-15 │  │
│  │ 标题: Great product! | 很棒的产品!    │  │
│  │ 正文: This is amazing... | 这款太棒了..│  │
│  │ 洞察: 🟢音质 🟢降噪                   │  │
│  │ 主题: 👤老人 📍家中 🎯降噪             │  │
│  └───────────────────────────────────────┘  │
│  [加载更多]                                  │
└─────────────────────────────────────────────┘
```

#### 7.3 报告页面
**URL**: `http://localhost:3000/report/{asin}/{report_id}`

**🆕 架构更新（2026-01-15）**:
- **模块化渲染**: 每种报告类型有独立的 React 组件
  - `SupplyChainReportPage` - 供应链报告
  - `ComprehensiveReportPage` - 综合战略报告
  - `OperationsReportPage` - 运营市场报告
  - `ProductReportPage` - 产品研发报告
- **数据概览**: 所有报告页面都包含"数据概览"（5W用户画像 + 5类洞察统计）
- **导航栏**: 报告大纲（Table of Contents）自动收集所有板块标题
- **侧边栏**: 点击数据概览中的标签可查看相关评论证据

**展示内容**:
- **选择报告类型**: CEO综合版 / 运营版 / 产品版 / 供应链版
- **异步生成**: 点击后调用 `/api/v1/products/{asin}/report/generate-async`，轮询任务状态
- **报告内容** (动态渲染JSON):
  - 用户画像卡片
  - SWOT分析表格
  - 部门指令列表
  - 优先行动项时间线
  - 原始数据图表 (ECharts):
    - 5W饼图
    - 洞察条形图
    - 情感分布图
- **导出功能**:
  - 导出为 PDF
  - 导出为 Excel
  - 分享报告链接

#### 7.4 对比分析页面
**URL**: `http://localhost:3000/analysis/projects/{project_id}`

**展示内容**:
- **产品对比表格**: 横向对比5W和5类Insight
- **维度洞察卡片**: 10个维度的共性/差异/定位分析
- **策略建议**: 市场定位/场景深耕/增长机会
- **数据图表**:
  - 雷达图 (多产品对比)
  - 热力图 (标签重叠度)
  - 气泡图 (用户群体分布)

---

## 🗄️ 数据库表结构

### 核心表

#### 1. `products` (产品表)
```sql
id                      UUID PRIMARY KEY
asin                    VARCHAR(10) UNIQUE
title                   TEXT
title_translated        TEXT
image_url               TEXT
marketplace             VARCHAR(50)
average_rating          FLOAT
price                   VARCHAR(50)
bullet_points           JSONB                    -- 原文五点
bullet_points_translated JSONB                   -- 中文五点
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

#### 2. `reviews` (评论表)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
review_id               VARCHAR(255)
rating                  INTEGER
title_original          TEXT
title_translated        TEXT
body_original           TEXT
body_translated         TEXT
author                  VARCHAR(255)
review_date             TIMESTAMP
verified_purchase       BOOLEAN
helpful_votes           INTEGER
review_url              TEXT
sentiment               VARCHAR(20)              -- positive/neutral/negative
translation_status      VARCHAR(20)              -- pending/processing/completed/failed
is_pinned               BOOLEAN DEFAULT FALSE
is_hidden               BOOLEAN DEFAULT FALSE
is_deleted              BOOLEAN DEFAULT FALSE
created_at              TIMESTAMP
updated_at              TIMESTAMP

UNIQUE (product_id, review_id)
```

#### 3. `review_insights` (洞察表)
```sql
id                      UUID PRIMARY KEY
review_id               UUID REFERENCES reviews(id)
insight_type            VARCHAR(50)              -- strength/weakness/suggestion/scenario/emotion
dimension               VARCHAR(100)             -- 音质/续航/外观/...
quote                   TEXT                     -- 原文引用
quote_translated        TEXT                     -- 中文引用
analysis                TEXT                     -- AI分析
created_at              TIMESTAMP
```

#### 4. `review_theme_highlights` (5W主题表)
```sql
id                      UUID PRIMARY KEY
review_id               UUID REFERENCES reviews(id)
theme_type              VARCHAR(50)              -- who/where/when/why/what
label_name              VARCHAR(100)             -- 标签名称
quote                   TEXT                     -- 原文证据
quote_translated        TEXT                     -- 中文证据
explanation             TEXT                     -- 归类理由
context_label_id        UUID                     -- 关联标签库ID
items                   JSONB                    -- 兼容旧数据
created_at              TIMESTAMP
```

#### 5. `product_context_labels` (5W标签库)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
type                    VARCHAR(50)              -- who/where/when/why/what
name                    VARCHAR(100)             -- 标签名称
description             TEXT                     -- 标签描述
count                   INTEGER DEFAULT 0        -- 使用次数
is_ai_generated         BOOLEAN DEFAULT FALSE
created_at              TIMESTAMP
```

#### 6. `product_dimensions` (产品维度表)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
name                    VARCHAR(100)             -- 维度名称
description             TEXT                     -- 维度描述
is_ai_generated         BOOLEAN DEFAULT FALSE
created_at              TIMESTAMP
```

#### 7. `product_reports` (报告表)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
title                   VARCHAR(255)
content                 JSONB                    -- AI生成的报告内容
analysis_data           JSONB                    -- 原始统计数据
report_type             VARCHAR(50)              -- comprehensive/operations/product/supply_chain
status                  VARCHAR(20)              -- pending/completed/failed
error_message           TEXT
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

#### 8. `product_pivot_insights` (数据透视洞察表) 🆕
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
insight_type            VARCHAR(50)              -- audience/demand/product/scenario/brand/dimension_summary
sub_type                VARCHAR(100)             -- decision_flow, strength_mapping, critical_weakness 等
dimension               VARCHAR(100)             -- 维度名称（用于dimension_summary类型）
summary_type            VARCHAR(50)              -- 总结类型（用于dimension_summary类型）
insight_data            JSONB                    -- AI生成的洞察内容 { keyFindings, dataSupport, recommendations, severity }
raw_data                JSONB                    -- 原始数据（矩阵数据、统计信息等）
confidence              DECIMAL(3,2)            -- 置信度分数 (0-1)
generation_status       VARCHAR(20)              -- pending/completed/failed
error_message           TEXT
created_at              TIMESTAMP
updated_at              TIMESTAMP
UNIQUE (product_id, insight_type, sub_type, dimension, summary_type)
```

**用途**：存储数据透视板块的AI解读数据，包含20个子模块的交叉分析洞察

#### 9. `product_dimension_summaries` (数据总览总结表) 🆕
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
summary_type            VARCHAR(50)              -- theme_buyer/user/where/when/why/what, dimension, emotion, scenario, consumer_persona, overall
category                VARCHAR(200)             -- 具体分类名称（如：质感体验、清洁收纳等）
title                   VARCHAR(500)             -- 标题/名称
summary                 TEXT                     -- 总结内容
key_points              JSONB                    -- 核心要点列表 [{"point": "...", "evidence_count": 10}]
evidence_count          INTEGER                  -- 支撑证据数量
sentiment_tendency      VARCHAR(20)              -- positive/negative/neutral/mixed
persona_data            JSONB                    -- 消费者原型专用字段 {"buyer": "宝妈", "user": "学龄前儿童", ...}
ai_model                VARCHAR(50)              -- qwen-max
confidence              FLOAT                    -- 置信度
raw_response            JSONB                    -- AI原始响应（用于调试）
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

**用途**：存储数据总览板块的AI总结数据，包含6大总结模块的单维度深度分析

#### 10. `tasks` (任务表)
```sql
id                      UUID PRIMARY KEY
product_id              UUID REFERENCES products(id)
task_type               VARCHAR(50)              -- translation/insights/themes
status                  VARCHAR(20)              -- pending/processing/completed/failed/stopped/timeout
total_items             INTEGER
processed_items         INTEGER
progress_percentage     INTEGER
last_heartbeat          TIMESTAMP                -- 心跳时间
celery_task_id          VARCHAR(255)
error_message           TEXT
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

#### 11. `analysis_projects` (对比分析项目表)
```sql
id                      UUID PRIMARY KEY
title                   VARCHAR(255)
description             TEXT
analysis_type           VARCHAR(50)              -- comparison
status                  VARCHAR(20)              -- pending/processing/completed/failed
result_content          JSONB                    -- 分析结果
raw_data_snapshot       JSONB                    -- 原始数据快照
error_message           TEXT
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

#### 12. `analysis_project_items` (对比项目明细表)
```sql
id                      UUID PRIMARY KEY
project_id              UUID REFERENCES analysis_projects(id)
product_id              UUID REFERENCES products(id)
role_label              VARCHAR(50)              -- target/competitor/gen1/gen2
display_order           INTEGER
created_at              TIMESTAMP
```

---

## 🔧 技术栈总览

### 前端
- **框架**: React 18 + TypeScript
- **路由**: React Router v6
- **UI 组件**: Tailwind CSS + shadcn/ui
- **图表**: ECharts / Recharts
- **状态管理**: React Query (TanStack Query)
- **HTTP 客户端**: Axios
- **打包工具**: Vite

### 后端
- **框架**: FastAPI 0.104+
- **ORM**: SQLAlchemy 2.0 (异步)
- **数据库**: PostgreSQL 15
- **任务队列**: Celery + Redis
- **AI 服务**: 阿里云通义千问 (Qwen API)
- **数据导出**: pandas + openpyxl

### 基础设施
- **反向代理**: Nginx
- **容器化**: Docker + Docker Compose
- **日志**: Python logging

### 浏览器插件
- **标准**: Chrome Manifest V3
- **语言**: Vanilla JavaScript (ES6+)
- **通信**: Chrome Extensions API

---

## 📈 数据流转时序图

### v2.0 流式并行时序图 (推荐)

```
用户           插件            后端API          Redis队列        Celery Worker      AI服务          数据库
 │              │               │                │                │                │              │
 │═══════════════════════════════════════════════════════════════════════════════════════════════│
 │                     【阶段1: 数据采集 - 流式处理】                                              │
 │═══════════════════════════════════════════════════════════════════════════════════════════════│
 │              │               │                │                │                │              │
 │──点击采集───→│               │                │                │                │              │
 │              │               │                │                │                │              │
 │              │──第1批评论────→│                │                │                │              │
 │              │               │──入Redis队列──→│                │                │              │
 │              │               │                │──消费入库─────→│                │              │
 │              │               │                │                │──存入评论表───┼──────────────→│
 │              │               │                │                │⚡立即触发翻译  │              │
 │              │               │                │                │────翻译评论───→│              │
 │              │               │                │                │                │──返回译文───→│
 │              │               │                │                │                │              │
 │              │──第2批评论────→│                │                │                │              │
 │              │               │──入Redis队列──→│ (并行处理)    │                │              │
 │              │               │                │──消费入库─────→│                │              │
 │              │               │                │                │──存入评论表───┼──────────────→│
 │              │               │                │                │⚡立即触发翻译  │              │
 │              │               │                │                │────翻译评论───→│              │
 │              │               │                │                │                │──返回译文───→│
 │              │               │                │                │                │              │
 │              │  ...持续采集... │                │  (翻译持续进行中,边采边译)      │              │
 │              │               │                │                │                │              │
 │              │──采集完成信号→│                │                │                │              │
 │              │               │                │                │                │              │
 │═══════════════════════════════════════════════════════════════════════════════════════════════│
 │                     【阶段2: 全自动分析流水线】                                                 │
 │═══════════════════════════════════════════════════════════════════════════════════════════════│
 │              │               │                │                │                │              │
 │              │               │──触发全自动────┼───────────────→│                │              │
 │              │               │  分析任务      │                │                │              │
 │              │               │                │                │                │              │
 │              │               │                │   ┌────────────────────────────────────────────│
 │              │               │                │   │ Step 1: 科学学习 (基于英文原文,不等翻译!) │
 │              │               │                │   └────────────────────────────────────────────│
 │              │               │                │                │                │              │
 │              │               │                │                │──查询英文样本──┼──────────────→│
 │              │               │                │                │                │              │
 │              │               │                │                │──学习维度─────→│              │
 │              │               │                │                │                │──分析原文───→│
 │              │               │                │                │←──返回5-8维度──│              │
 │              │               │                │                │──存入维度表───┼──────────────→│
 │              │               │                │                │                │              │
 │              │               │                │                │──学习5W标签──→│              │
 │              │               │                │                │                │──分析原文───→│
 │              │               │                │                │←──返回标签库──│              │
 │              │               │                │                │──存入标签表───┼──────────────→│
 │              │               │                │                │                │              │
 │              │               │                │   ┌────────────────────────────────────────────│
 │              │               │                │   │ Step 2: 并行提取 (翻译仍在进行中!)        │
 │              │               │                │   └────────────────────────────────────────────│
 │              │               │                │                │                │              │
 │              │               │                │                │──触发洞察提取──┼──────────────→│
 │              │               │                │                │  (使用维度)    │              │
 │              │               │                │                │──触发主题提取──┼──────────────→│
 │              │               │                │                │  (使用标签)    │              │
 │              │               │                │                │                │              │
 │              │               │                │   ┌────────────────────────────────────────────│
 │              │               │                │   │ Step 3: 等待并行完成 (三任务同时进行!)    │
 │              │               │                │   └────────────────────────────────────────────│
 │              │               │                │                │                │              │
 │              │               │                │                │  翻译任务 ────→│──批量翻译───→│
 │              │               │                │                │  洞察任务 ────→│──提取洞察───→│
 │              │               │                │                │  主题任务 ────→│──提取主题───→│
 │              │               │                │                │                │              │
 │              │               │                │                │←──90%完成度───│              │
 │              │               │                │                │                │              │
 │              │               │                │   ┌────────────────────────────────────────────│
 │              │               │                │   │ Step 4: 自动生成报告                      │
 │              │               │                │   └────────────────────────────────────────────│
 │              │               │                │                │                │              │
 │              │               │                │                │──聚合5W+洞察───┼──────────────→│
 │              │               │                │                │──生成报告─────→│              │
 │              │               │                │                │                │──AI撰写─────→│
 │              │               │                │                │←──返回JSON────│              │
 │              │               │                │                │──存入报告表───┼──────────────→│
 │              │               │                │                │                │              │
 │←───任务完成,前端刷新──────────────────────────┼────────────────│                │              │
 │              │               │                │                │                │              │
```

### v1.0 传统时序图 (兼容)

<details>
<summary>点击展开传统时序图</summary>

```
用户           插件            后端API         Celery Worker      AI服务          数据库
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                          【阶段1: 数据采集】                                   │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──点击采集───→│               │                │                │              │
 │              │──爬取评论─────→│                │                │              │
 │              │               │                │                │              │
 │              │               │──存入产品表────┼────────────────┼─────────────→│
 │              │               │  (products)    │                │              │
 │              │               │──存入评论表────┼────────────────┼─────────────→│
 │              │               │  (reviews)     │                │              │
 │              │←──返回成功────│                │                │              │
 │              │               │                │                │              │
 │←─跳转控制台──│               │                │                │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                          【阶段2: 翻译处理】                                   │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──点击翻译────────────────────→│                │                │              │
 │              │               │──创建任务表────┼────────────────┼─────────────→│
 │              │               │  (tasks)       │                │              │
 │              │               │──发送翻译任务──┼───────────────→│              │
 │              │               │  到Redis队列   │                │              │
 │              │               │                │                │              │
 │              │               │                │──Task1:翻译五点─→│             │
 │              │               │                │                │──翻译标题+卖点│
 │              │               │                │←───返回译文────│              │
 │              │               │                │──更新产品表────┼─────────────→│
 │              │               │                │                │              │
 │              │               │                │──Task2:翻译评论─→│             │
 │              │               │                │                │──逐条翻译────→│
 │              │               │                │←───返回译文────│              │
 │              │               │                │──更新评论表────┼─────────────→│
 │              │               │                │──更新任务进度──┼─────────────→│
 │              │               │                │                │              │
 │──轮询进度────────────────────→│──查询任务状态──┼────────────────┼─────────────→│
 │←──返回80%────────────────────│                │                │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │               【阶段3.1: 学习产品维度 (全自动必须/手动可选)】                 │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──学习维度────────────────────→│──查询评论样本──┼────────────────┼─────────────→│
 │              │               │──查询产品信息──┼────────────────┼─────────────→│
 │              │               │                │                │              │
 │              │               │──调用AI学习────┼────────────────→│              │
 │              │               │  (产品标题+    │                │              │
 │              │               │   五点+评论)   │                │──AI分析────→│
 │              │               │                │                │  生成维度    │
 │              │               │                │←───返回维度────│              │
 │              │               │──存入维度表────┼────────────────┼─────────────→│
 │              │               │  (product_     │                │              │
 │              │               │   dimensions)  │                │              │
 │              │               │                │                │              │
 │←──返回维度列表───────────────│                │                │              │
 │  (可编辑)     │               │                │                │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                       【阶段3.2: 提取洞察 (Insights)】                         │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──点击洞察────────────────────→│──查询维度Schema┼────────────────┼─────────────→│
 │              │               │  (如果已定义)  │                │              │
 │              │               │──发送洞察任务──┼───────────────→│              │
 │              │               │                │                │              │
 │              │               │                │──Task3:提取洞察─→│             │
 │              │               │                │  (带维度Schema)│              │
 │              │               │                │                │──AI提取5类──→│
 │              │               │                │                │  洞察(优势/  │
 │              │               │                │                │  痛点/建议/  │
 │              │               │                │                │  场景/情绪)  │
 │              │               │                │←───返回洞察────│              │
 │              │               │                │──存入洞察表────┼─────────────→│
 │              │               │                │  (review_      │              │
 │              │               │                │   insights)    │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                    【阶段3.3: 学习5W标签库 + 提取主题】                         │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──点击主题────────────────────→│──发送主题任务──┼───────────────→│              │
 │              │               │                │                │              │
 │              │               │                │──Task4:提取主题─→│             │
 │              │               │                │                │              │
 │              │               │                │─检查标签库是否存在─────────────→│
 │              │               │                │←─不存在,需学习─┼─────────────→│
 │              │               │                │                │              │
 │              │               │                │──Step1:学习5W──→│             │
 │              │               │                │  标签库        │              │
 │              │               │                │  (产品标题+    │              │
 │              │               │                │   五点+评论样本)│              │
 │              │               │                │                │──AI学习────→│
 │              │               │                │                │  生成Who/   │
 │              │               │                │                │  Where/When/│
 │              │               │                │                │  Why/What标签│
 │              │               │                │←───返回标签库──│              │
 │              │               │                │──存入标签库────┼─────────────→│
 │              │               │                │  (product_     │              │
 │              │               │                │   context_     │              │
 │              │               │                │   labels)      │              │
 │              │               │                │                │              │
 │              │               │                │──Step2:提取5W──→│             │
 │              │               │                │  主题(强制归类)│              │
 │              │               │                │                │──AI提取────→│
 │              │               │                │                │  5W要素并   │
 │              │               │                │                │  匹配标签   │
 │              │               │                │←───返回主题────│              │
 │              │               │                │──存入主题表────┼─────────────→│
 │              │               │                │  (review_theme_│              │
 │              │               │                │   highlights)  │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                          【阶段4: 报告生成】                                   │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──生成报告────────────────────→│──聚合5W数据────┼────────────────┼─────────────→│
 │  (选择类型)  │               │──聚合洞察数据──┼────────────────┼─────────────→│
 │              │               │──格式化Prompt──│                │              │
 │              │               │                │                │              │
 │              │               │──调用AI生成────┼────────────────→│              │
 │              │               │  (CEO/CMO/CPO/ │                │              │
 │              │               │   供应链版本)  │                │──AI撰写报告→│
 │              │               │                │                │  (SWOT/卖点/ │
 │              │               │                │                │   痛点/建议) │
 │              │               │                │←───返回报告JSON│              │
 │              │               │──存入报告表────┼────────────────┼─────────────→│
 │              │               │  (product_     │                │              │
 │              │               │   reports)     │                │              │
 │              │               │                │                │              │
 │←───展示报告──────────────────│                │                │              │
 │  (可导出PDF/Excel)            │                │                │              │
 │              │               │                │                │              │
 │──────────────────────────────────────────────────────────────────────────────│
 │                    【阶段6: 数据透视与数据总览分析】                            │
 │──────────────────────────────────────────────────────────────────────────────│
 │              │               │                │                │              │
 │──生成数据透视─────────────────→│──查询主题标签──┼────────────────┼─────────────→│
 │  洞察(分享页)│               │  (5W维度)      │                │              │
 │              │               │──查询洞察数据──┼────────────────┼─────────────→│
 │              │               │  (5类洞察)    │                │              │
 │              │               │──计算交叉矩阵──┼────────────────┼─────────────→│
 │              │               │  (2D/3D)      │                │              │
 │              │               │──调用AI解读────┼────────────────→│              │
 │              │               │  (20个子模块)   │                │──AI生成解读──→│
 │              │               │                │                │  (keyFindings│
 │              │               │                │                │   /recommend │
 │              │               │                │                │   ations)    │
 │              │               │                │←───返回JSON────│              │
 │              │               │──存入透视表────┼────────────────┼─────────────→│
 │              │               │  (product_     │                │              │
 │              │               │   pivot_       │                │              │
 │              │               │   insights)    │                │              │
 │              │               │                │                │              │
 │──生成数据总览─────────────────→│──聚合5W统计───┼────────────────┼─────────────→│
 │  总结(分享页)│               │──聚合洞察统计──┼────────────────┼─────────────→│
 │              │               │──调用AI总结────┼────────────────→│              │
 │              │               │  (6大模块)    │                │──AI生成总结──→│
 │              │               │                │                │  (summary/   │
 │              │               │                │                │   keyPoints) │
 │              │               │                │←───返回JSON────│              │
 │              │               │──存入总览表───┼────────────────┼─────────────→│
 │              │               │  (product_     │                │              │
 │              │               │   dimension_   │                │              │
 │              │               │   summaries)   │                │              │
 │              │               │                │                │              │
 │←───展示数据透视────────────────│                │                │              │
 │  和数据总览  │               │                │                │              │
```

</details>

### 时序图说明

**v2.0 流式并行架构**:
- ⚡ **阶段1**: 流式采集 (边采边译,不等待采集完成)
- 🔬 **阶段2.Step1**: 科学学习 (基于英文原文,不依赖翻译)
- 🔄 **阶段2.Step2**: 并行提取 (翻译+洞察+主题同时进行)
- 📊 **阶段2.Step3**: 智能等待 (90%完成度即可)
- 📝 **阶段2.Step4**: 自动报告 (无需用户手动触发)

**v1.0 传统架构**:
- 🔵 **阶段1**: 数据采集 (Chrome插件 → 后端存储)
- 🟢 **阶段2**: 翻译处理 (Task1: 五点翻译 → Task2: 评论翻译)
- 🟡 **阶段3.1**: 学习产品维度 (全自动必须,用于洞察分类)
- 🟠 **阶段3.2**: 提取洞察 (5类: 优势/痛点/建议/场景/情绪)
- 🔴 **阶段3.3**: 学习5W标签库 + 提取5W主题 (Who/Where/When/Why/What)
- 🟣 **阶段4**: 报告生成 (4种角色化报告)

**关键优化点**:
1. **边采边译**: 每批评论入库后立即触发翻译,无需等待采集完成
2. **跨语言学习**: 维度和5W标签基于英文原文学习,不阻塞翻译
3. **三任务并行**: 翻译、洞察、主题提取同时进行
4. **智能阈值**: 90%完成度即触发报告,不死等100%
5. **自动恢复**: 定时任务每15秒检查补漏

---

## 🎯 关键设计亮点

### 1. **智能去重机制**
- 评论表使用 `(product_id, review_id)` 唯一索引
- 自动跳过重复评论,避免数据冗余
- 支持增量采集 (采集50条 → 再采集50条 = 自动合并)

### 2. **人性化采集**
- 随机延迟 (2-5秒) 模拟人类行为
- 验证码检测 & 自动暂停
- 进度实时反馈 (浮层显示)

### 3. **异步处理架构**
- Celery 分布式任务队列
- 4个独立任务 (翻译/洞察/主题/报告)
- 心跳监控 + 超时恢复
- 支持手动停止/重试

### 4. **AI-Native 数据架构**
- **先学习标准,后强制归类** (5W标签库)
- **5类洞察框架** (strength/weakness/suggestion/scenario/emotion)
- **带证据溯源** (每个标签都可追溯到原始评论)

### 5. **角色化报告系统**
- 4种报告类型 (CEO/CMO/CPO/供应链)
- 每种报告使用不同的 AI Prompt
- JSON 格式输出,前端动态渲染
- 支持历史报告回溯

### 6. **可追溯性设计**
- 每个统计项都带 `evidence` 数组
- 点击标签 → 展示相关评论
- 报告中的建议都带 `source_tag` → 可跳转到原始洞察

### 7. **N-Way 对比分析**
- 支持2-5个产品同时对比
- 10个维度交叉分析 (5W + 5类Insight)
- 共性/差异/定位洞察
- 策略建议 (市场定位/场景深耕/增长机会)

---

## 🚀 部署与运行

### Docker Compose 一键启动
```bash
# 1. 克隆项目
git clone <your-repo-url>
cd voc-master

# 2. 配置环境变量
cp .env.example .env
nano .env  # 填入 QWEN_API_KEY

# 3. 启动所有服务
docker-compose up -d

# 4. 查看日志
docker-compose logs -f

# 5. 访问服务
# - 前端: http://localhost:3000
# - 后端: http://localhost:8000
# - API文档: http://localhost:8000/docs
```

### 服务列表
| 服务 | 端口 | 说明 |
|------|------|------|
| `db-postgres` | 5432 | PostgreSQL 15 数据库 |
| `db-redis` | 6379 | Redis 7 消息队列 |
| `app-backend` | 8000 | FastAPI 后端 API |
| `app-worker` | - | Celery 翻译 Worker |
| `app-frontend` | 3000 | React 前端 (Nginx) |

---

## 📚 API 接口汇总

### 评论相关
- `POST /api/v1/reviews/ingest` - 接收插件采集的评论
- `GET /api/v1/reviews/{asin}` - 获取商品评论列表
- `GET /api/v1/reviews/{asin}/export` - 导出 Excel

### 产品相关
- `GET /api/v1/products` - 商品列表
- `GET /api/v1/products/{asin}/stats` - 商品统计
- `POST /api/v1/products/{asin}/translate` - 触发翻译
- `POST /api/v1/products/{asin}/extract-insights` - 提取洞察
- `POST /api/v1/products/{asin}/extract-themes` - 提取5W主题
- `POST /api/v1/products/{asin}/stop-analysis` - 停止分析

### 维度管理
- `GET /api/v1/products/{asin}/dimensions` - 获取产品维度
- `POST /api/v1/products/{asin}/dimensions/generate` - AI生成维度
- `POST /api/v1/products/{asin}/dimensions` - 手动添加维度
- `PUT /api/v1/products/dimensions/{id}` - 更新维度
- `DELETE /api/v1/products/dimensions/{id}` - 删除维度

### 5W标签管理
- `GET /api/v1/products/{asin}/context-labels` - 获取5W标签库
- `POST /api/v1/products/{asin}/context-labels/generate` - AI学习标签
- `GET /api/v1/products/{asin}/context-labels/schema` - 获取标签Schema
- `POST /api/v1/products/{asin}/context-labels` - 添加标签
- `PUT /api/v1/products/context-labels/{id}` - 更新标签
- `DELETE /api/v1/products/context-labels/{id}` - 删除标签

### 报告相关
- `GET /api/v1/products/report-types` - 获取所有报告类型
- `POST /api/v1/products/{asin}/report/generate-async?report_type=comprehensive` - 🆕 异步生成报告（推荐）
- `GET /api/v1/products/{asin}/report/task/{task_id}` - 🆕 查询报告生成任务状态
- `POST /api/v1/products/{asin}/report/generate?report_type=comprehensive` - 同步生成报告（兼容）
- `GET /api/v1/products/{asin}/report/preview` - 报告预览
- `GET /api/v1/products/{asin}/reports` - 历史报告列表
- `GET /api/v1/products/{asin}/reports/latest` - 最新报告
- `GET /api/v1/products/{asin}/reports/{report_id}` - 获取指定报告
- `DELETE /api/v1/products/{asin}/reports/{report_id}` - 删除报告

### 对比分析
- `POST /api/v1/analysis/projects` - 创建对比项目
- `GET /api/v1/analysis/projects` - 项目列表
- `GET /api/v1/analysis/projects/{project_id}` - 项目详情
- `POST /api/v1/analysis/projects/{project_id}/run` - 触发分析
- `DELETE /api/v1/analysis/projects/{project_id}` - 删除项目
- `POST /api/v1/analysis/preview` - 对比预览
- `GET /api/v1/analysis/products/{asin}/reviews-by-label` - 根据标签获取评论

### 任务管理
- `GET /api/v1/tasks/{task_id}` - 任务状态查询
- `GET /api/v1/products/{asin}/tasks/health` - 任务健康检查

---

## 🔍 故障排查

### 常见问题

#### 1. 翻译任务卡住不动
**症状**: 进度条停在某个百分比,长时间不更新

**排查步骤**:
```bash
# 1. 检查 Worker 是否运行
docker-compose logs app-worker

# 2. 检查任务心跳
curl http://localhost:8000/api/v1/products/{asin}/tasks/health

# 3. 如果发现超时任务,手动恢复
curl -X POST http://localhost:8000/api/v1/products/{asin}/tasks/health?auto_recover=true

# 4. 或者手动重启 Worker
docker-compose restart app-worker
```

#### 2. AI 服务调用失败
**症状**: 翻译/洞察/主题提取失败,错误日志显示 API 错误

**排查步骤**:
```bash
# 1. 检查 Qwen API Key 是否配置
docker-compose exec app-backend env | grep QWEN

# 2. 测试 API 连通性
curl https://dashscope.aliyuncs.com/compatible-mode/v1/models \
  -H "Authorization: Bearer YOUR_API_KEY"

# 3. 如果 API Key 失效,更新环境变量
docker-compose down
nano .env  # 更新 QWEN_API_KEY
docker-compose up -d
```

#### 3. 数据采集失败
**症状**: 插件提示"采集失败"或"请确保已登录亚马逊"

**排查步骤**:
1. 确认已登录亚马逊账号
2. 刷新商品页面,重新尝试
3. 检查是否触发验证码 → 手动完成验证码后继续
4. 如果是站点不支持 → 确认是否为 amazon.com/amazon.co.uk 等主流站点

#### 4. 报告生成失败
**症状**: 点击"生成报告"后返回错误

**排查步骤**:
```bash
# 1. 检查数据量是否充足
curl http://localhost:8000/api/v1/products/{asin}/report/preview

# 确保:
# - total_reviews >= 10
# - 已完成翻译 (translation_status = completed)

# 2. 如果数据不足
# - 继续采集更多评论
# - 或手动触发翻译
```

---

## 📊 性能指标

### 采集速度
- **单条评论**: 2-5秒 (含人类模拟延迟)
- **50条评论**: 约 3-5 分钟
- **翻页次数**: 取决于每页评论数 (通常10条/页)

### 翻译速度
- **单条评论翻译**: 1-2秒 (Qwen API)
- **100条评论**: 约 3-5 分钟
- **限流**: 每条评论间隔 0.2秒

### 洞察提取速度
- **单条评论洞察**: 2-3秒 (Qwen API)
- **100条评论**: 约 5-8 分钟

### 5W主题提取速度
- **学习标签库**: 10-15秒 (基于50条样本)
- **单条评论主题**: 2-3秒 (Qwen API)
- **100条评论**: 约 5-8 分钟

### 报告生成速度
- **单份报告**: 30-60秒 (AI撰写)
- **对比分析**: 2-5分钟 (2-5个产品)

---

## 🎉 总结

VOC-Master 通过以下流程实现了从数据采集到智能分析的全链路自动化:

1. **采集**: Chrome插件无感爬取评论
2. **存储**: PostgreSQL持久化 + 智能去重
3. **翻译**: Celery异步队列 + Qwen AI高精度翻译
4. **提取**: AI提取5W主题 + 5类洞察 + 证据溯源
5. **聚合**: 统计分析 + 数据可视化
6. **生成**: 4种角色化报告 + N-Way对比分析
7. **展示**: React前端 + 双语阅读 + 图表展示

整个系统的核心设计理念是:
- **AI-Native**: 深度依赖 AI 进行数据理解和生成
- **可追溯性**: 每个数据点都可以追溯到原始评论
- **角色化**: 不同角色看到不同视角的报告
- **自动化**: 最小化人工干预,最大化效率

---

## 📋 Celery 任务清单 (v2.0)

### 核心任务一览

| 序号 | 任务名称 | 函数名 | 触发方式 | 描述 |
|-----|---------|-------|---------|------|
| 1 | 评论翻译 | `task_process_reviews` | 手动/定时 | 翻译评论标题和正文,分析情感 |
| 2 | 五点翻译 | `task_translate_bullet_points` | 入库自动 | 翻译产品标题和五点卖点 |
| 3 | 洞察提取 | `task_extract_insights` | 自动/手动 | 提取5类洞察(优势/痛点/建议/场景/情绪) |
| 4 | 主题提取 | `task_extract_themes` | 自动/手动 | 提取5W主题(Buyer/User/Where/When/Why/What) |
| 5 | 科学学习 | `task_scientific_learning` | 全自动流水线 | 学习产品维度+5W标签库 |
| 6 | 入库翻译 | `task_ingest_translation_only` | 入库后立即 | 流式翻译(边采边译) |
| 7 | 全自动分析 | `task_full_auto_analysis` | 采集完成 | 完整分析流水线(学习→提取→报告) |
| 8 | 报告生成 | `task_generate_report` | 🆕 异步触发 | 生成指定类型的AI报告 |
| 9 | 🆕 维度总结 | `task_generate_dimension_summaries` | 用户手动触发 | 生成中观层AI分析（打通微观→宏观桥梁） |
| 10 | 翻译调度 | `task_check_pending_translations` | 定时(15秒) | 检查并补发翻译任务 |
| 11 | 队列消费 | `task_process_ingestion_queue` | 定时(5秒) | 从Redis队列批量入库 |

### 任务依赖关系图

```
                                  ┌──────────────────────┐
                                  │ Chrome 插件采集       │
                                  └──────────┬───────────┘
                                             │
                         ┌───────────────────┼───────────────────┐
                         ↓                   ↓                   ↓
            ┌────────────────────┐  ┌────────────────┐  ┌────────────────┐
            │ task_process_      │  │ task_translate_│  │ task_ingest_   │
            │ ingestion_queue    │  │ bullet_points  │  │ translation_   │
            │ (队列消费入库)      │  │ (翻译五点)      │  │ only           │
            └─────────┬──────────┘  └────────────────┘  │ (流式翻译)      │
                      │                                  └────────────────┘
                      │ 采集完成信号                                ↑
                      ↓                                             │
            ┌────────────────────┐                                  │
            │ task_full_auto_    │──────────────────────────────────┘
            │ analysis           │       ↑ 补发翻译
            │ (全自动分析)        │       │
            └─────────┬──────────┘       │
                      │           ┌──────┴────────────┐
          ┌───────────┼───────────│ task_check_       │
          ↓           ↓           │ pending_          │
    ┌───────────┐ ┌───────────┐   │ translations      │
    │ 学习维度   │ │ 学习5W标签 │   │ (定时补漏)        │
    └─────┬─────┘ └─────┬─────┘   └───────────────────┘
          │             │
          ↓             ↓
    ┌───────────┐ ┌───────────┐
    │task_      │ │task_      │
    │extract_   │ │extract_   │
    │insights   │ │themes     │
    │(洞察提取) │ │(主题提取) │
    └─────┬─────┘ └─────┬─────┘
          │             │
          └──────┬──────┘
                 ↓
        ┌────────────────┐
        │ generate_report│
        │ (生成报告)      │
        └────────────────┘
```

### 定时任务配置 (Celery Beat)

```python
# backend/app/worker.py

celery_app.conf.beat_schedule = {
    # 每 5 秒消费 Redis 队列
    'consume-ingestion-queue': {
        'task': 'app.worker.task_process_ingestion_queue',
        'schedule': 5.0,
    },
    # 每 15 秒检查待翻译任务
    'check-pending-translations': {
        'task': 'app.worker.task_check_pending_translations',
        'schedule': 15.0,
    },
}
```

---

## 🆕 维度总结（中观层AI分析）- 2026-01-22 新增

### 功能定位

维度总结是**打通微观（单条评论）到宏观（项目报告）的桥梁层**，提供中观层的AI分析内容。

**数据流转层级：**
```
单条评论 → review_insights/review_theme_highlights (微观层)
    ↓ 聚合分析
product_dimension_summaries (中观层) ← 新增这一层
    ↓ 综合
product_reports (宏观层)
```

### 触发机制

**用户手动触发**（不再自动触发）：
- 触发位置：分享页面（`/share/{token}`）的"生成AI分析"按钮
- 触发条件：用户确认洞察和主题提取已完成
- API端点：`POST /api/v1/share/{token}/generate-summaries`
- 优势：节省AI调用成本，用户主导，确保数据完整性

### 生成内容类型

维度总结服务生成6种类型的AI分析：

1. **5W主题总结**（6个）：
   - `theme_buyer` - 购买者画像总结
   - `theme_user` - 使用者画像总结
   - `theme_where` - 使用地点总结
   - `theme_when` - 使用时机总结
   - `theme_why` - 购买动机总结
   - `theme_what` - 产品用途总结

2. **产品维度总结**：
   - `dimension` - 每个评价维度的优劣势总结（如：加热性能、质感体验等）

3. **情感维度总结**：
   - `emotion` - 每个情感类型的总结（如：失望不满、惊喜好评等）

4. **场景维度总结**：
   - `scenario` - 每个使用场景的总结

5. **消费者原型**：
   - `consumer_persona` - 生成3-5个典型消费者画像（基于5W交叉分析）

6. **整体数据总结**：
   - `overall` - 产品的整体洞察总结

### 数据流转

```
[用户点击"生成AI分析"按钮]
    ↓
POST /api/v1/share/{token}/generate-summaries
    ↓
DimensionSummaryService.generate_all_summaries()
    ↓
┌─────────────────────────────────────────────────────────┐
│ 收集数据：                                                │
│ • 5W主题数据（从 review_theme_highlights 聚合）          │
│ • 产品维度洞察（从 review_insights 聚合）                │
│ • 情感/场景洞察（从 review_insights 聚合）               │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ 生成AI总结（调用 Qwen API）：                             │
│ 1. 5W主题总结（6个）                                      │
│ 2. 产品维度总结（每个维度1个）                            │
│ 3. 情感维度总结（每个情感类型1个）                        │
│ 4. 场景维度总结（每个场景类型1个）                        │
│ 5. 消费者原型（3-5个）                                    │
│ 6. 整体数据总结（1个）                                    │
└─────────────────────────────────────────────────────────┘
    ↓
存入 product_dimension_summaries 表
    ↓
前端分享页面展示：
• 用户画像区域：显示AI消费者原型
• 产品维度区域：显示每个维度的AI总结
• 页面底部：显示整体数据总结
```

### 数据库表结构

**表名：** `product_dimension_summaries`

**关键字段：**
- `product_id` - 关联产品
- `summary_type` - 总结类型（theme_buyer/user/where/when/why/what, dimension, emotion, scenario, consumer_persona, overall）
- `category` - 具体分类（如维度名、情感类型名等）
- `title` - 标题/名称
- `summary` - AI生成的总结内容
- `key_points` - 核心要点（JSONB）
- `evidence_count` - 支撑证据数量
- `sentiment_tendency` - 情感倾向（positive/negative/neutral/mixed）
- `persona_data` - 消费者原型数据（JSONB，仅consumer_persona类型使用）

### 服务实现

**服务文件：** `backend/app/services/dimension_summary_service.py`

**核心方法：**
- `generate_all_summaries()` - 生成所有类型的总结
- `_generate_theme_summary()` - 生成5W主题总结
- `_generate_dimension_summary()` - 生成产品维度总结
- `_generate_emotion_summary()` - 生成情感维度总结
- `_generate_scenario_summary()` - 生成场景维度总结
- `_generate_consumer_personas()` - 生成消费者原型
- `_generate_overall_summary()` - 生成整体数据总结

**Celery任务：** `backend/app/worker.py` → `task_generate_dimension_summaries()`

---

## 🎉 总结

VOC-Master 通过以下流程实现了从数据采集到智能分析的全链路自动化:

1. **采集**: Chrome插件无感爬取评论
2. **存储**: Redis队列 → PostgreSQL持久化 + 智能去重
3. **翻译**: ⚡ **流式处理** - 边采边译,不等待采集完成
4. **学习**: 🔬 **科学学习** - 基于英文原文,不依赖翻译
5. **提取**: 🔄 **并行处理** - 翻译+洞察+主题同时进行
6. **聚合**: 统计分析 + 数据可视化
7. **🆕 维度总结**: 中观层AI分析 - 打通微观到宏观的桥梁
8. **生成**: 4种角色化报告 + N-Way对比分析
9. **展示**: React前端 + 双语阅读 + 图表展示

### v2.0 核心设计理念

| 设计原则 | 说明 |
|---------|------|
| **AI-Native** | 深度依赖 AI 进行数据理解和生成 |
| **流式处理** | 边采边译,不阻塞用户体验 |
| **跨语言学习** | 维度/标签基于原文学习,不依赖翻译 |
| **并行优化** | 三任务同时进行,节省50%+时间 |
| **智能阈值** | 90%完成度即可,不死等100% |
| **可追溯性** | 每个数据点都可以追溯到原始评论 |
| **角色化** | 不同角色看到不同视角的报告 |
| **自动化** | 最小化人工干预,最大化效率 |

---

**文档生成时间**: 2025-01-09  
**最后更新时间**: 2026-01-22  
**项目版本**: v2.2.0 (流式并行架构 + 异步报告生成 + 维度总结)  
**作者**: VOC-Master Team

---

## 📝 更新日志

| 版本 | 日期 | 更新内容 |
|-----|------|---------|
| v2.2.0 | 2026-01-22 | 1. 🆕 新增维度总结（中观层AI分析）功能<br>2. 🆕 打通微观（单条评论）到宏观（项目报告）的桥梁<br>3. 🆕 用户手动触发机制（分享页面一键生成）<br>4. 🆕 支持6种类型总结：5W主题/产品维度/情感/场景/消费者原型/整体总结<br>5. 更新任务清单和触发机制说明 |
| v2.1.0 | 2026-01-15 | 1. 🆕 新增异步报告生成机制<br>2. 🆕 前端报告页面模块化重构<br>3. 🆕 报告页面支持侧边栏查看证据<br>4. 更新 API 接口文档 |
| v2.0.0 | 2026-01-13 | 1. 新增流式并行架构说明<br>2. 更新任务触发时序图<br>3. 添加 Celery 任务清单<br>4. 更新核心设计理念 |
| v1.0.0 | 2025-01-09 | 初始版本,完整数据流转文档 |
