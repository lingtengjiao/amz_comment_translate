services:
  # ============================================================================
  # ğŸ—„ï¸ PostgreSQL Databaseï¼ˆä¼˜åŒ–é…ç½®ï¼š4GB shared_buffersï¼‰
  # ============================================================================
  db-postgres:
    image: postgres:15-alpine
    container_name: voc-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-vocmaster}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-vocmaster123}
      POSTGRES_DB: ${POSTGRES_DB:-vocmaster}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    # ğŸ”¥ PostgreSQL é«˜æ€§èƒ½é…ç½®ï¼ˆ16GB æœåŠ¡å™¨ä¼˜åŒ–ï¼‰
    command: >
      postgres
      -c shared_buffers=4GB
      -c work_mem=64MB
      -c max_connections=500
      -c effective_cache_size=8GB
      -c maintenance_work_mem=512MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=64MB
      -c random_page_cost=1.1
    # é™åˆ¶å†…å­˜ä½¿ç”¨ï¼Œç¡®ä¿ä¸è¶…è¿‡åˆ†é…
    deploy:
      resources:
        limits:
          memory: 5G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vocmaster}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - voc-network

  # ============================================================================
  # ğŸ”´ Redisï¼ˆ2GB å†…å­˜é™åˆ¶ï¼Œé˜Ÿåˆ—ç¼“å†²åŒºï¼‰
  # ============================================================================
  db-redis:
    image: redis:7-alpine
    container_name: voc-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    # ğŸ”¥ Redis é«˜æ€§èƒ½é…ç½®
    command: >
      redis-server
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
    deploy:
      resources:
        limits:
          memory: 2G
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - voc-network

  # ============================================================================
  # ğŸš€ FastAPI Backend
  # ============================================================================
  app-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-backend
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    ports:
      - "8000:8000"
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - voc-network

  # ============================================================================
  # ğŸš€ Celery Workersï¼ˆ5 é˜Ÿåˆ— + 4 Worker é«˜ååæ¶æ„ï¼‰
  # ============================================================================
  #
  # ğŸ¯ è®¾è®¡ç›®æ ‡ï¼š4æ ¸16G æœåŠ¡å™¨ï¼Œ404 å¹¶å‘ APIï¼Œæ”¯æŒç™¾äººåŒæ—¶é‡‡é›†
  #
  # 5 ç‹¬ç«‹é˜Ÿåˆ—ï¼š
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ 1. ingestion   - å…¥åº“ï¼ˆç§’çº§å“åº”ï¼‰                                  â”‚
  # â”‚ 2. reports     - æŠ¥å‘Šç”Ÿæˆï¼ˆç§’çº§å“åº”ï¼‰                              â”‚
  # â”‚ 3. learning    - å­¦ä¹ ç»´åº¦/5Wï¼ˆæ–°äº§å“ç§’çº§å»ºæ¨¡ï¼‰                      â”‚
  # â”‚ 4. translation - ç¿»è¯‘ï¼ˆé«˜å¹¶å‘ AI APIï¼‰                            â”‚
  # â”‚ 5. analysis    - æ´å¯Ÿ+ä¸»é¢˜ï¼ˆé«˜å¹¶å‘ AI APIï¼‰                        â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  #
  # 4 Worker åˆ†å·¥ï¼š
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ Worker 1: åŸºç¡€å“åº”å‘˜ (Prefork, 4çº¿ç¨‹)                             â”‚
  # â”‚   Queue: ingestion, reports, celery                              â”‚
  # â”‚   ç‰¹ç‚¹ï¼šçº¯ CPU + ç£ç›˜ï¼Œä¿è¯ API æ°¸è¿œä¸å¡                           â”‚
  # â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  # â”‚ Worker 2: VIP å»ºæ¨¡å‘˜ (Gevent, 100åç¨‹)                            â”‚
  # â”‚   Queue: learning                                                 â”‚
  # â”‚   ç‰¹ç‚¹ï¼šæ–°äº§å“ç§’çº§å»ºæ¨¡ï¼Œç‹¬ç«‹å¿«è½¦é“                                  â”‚
  # â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  # â”‚ Worker 3 & 4: AI ååä¸»åŠ› (Gevent, å„150åç¨‹)                     â”‚
  # â”‚   Queue: learning, translation, analysis                         â”‚
  # â”‚   ç‰¹ç‚¹ï¼š300 å¹¶å‘ APIï¼Œç¿»è¯‘/æ´å¯Ÿ/ä¸»é¢˜ä¸€èµ·å¤„ç†                       â”‚
  # â”‚   learning ä¹Ÿç›‘å¬ï¼Œä½œä¸º VIP Worker çš„å¤‡ä»½                          â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  #
  # æ€»å¹¶å‘ï¼š4 + 100 + 300 = 404 å¹¶å‘ API è¯·æ±‚ï¼

  # ==========================================================================
  # Worker 1: åŸºç¡€å“åº”å‘˜ (Base Worker)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼šingestion, reports, celery
  # æ¨¡å¼ï¼šPrefork, 4 çº¿ç¨‹
  # èŒè´£ï¼šæµå¼å†™å…¥ + æŠ¥å‘Šç»„è£…ï¼Œçº¯ CPU + ç£ç›˜ï¼Œä¿è¯ API æ°¸è¿œä¸å¡
  worker-base:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-base
    restart: unless-stopped
    # Beat åœ¨è¿™é‡Œè¿è¡Œ
    command: celery -A app.worker worker --beat --loglevel=info --concurrency=4 -Q ingestion,reports,celery -n base@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d base@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ==========================================================================
  # Worker 2: VIP å»ºæ¨¡å‘˜ (Vanguard/Learning)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼šlearning, translationï¼ˆä¼˜å…ˆ learningï¼Œé—²æ—¶æ”¯æ´ç¿»è¯‘ï¼‰
  # æ¨¡å¼ï¼šGevent, 100 åç¨‹
  # èŒè´£ï¼šæ–°äº§å“ç§’çº§å»ºæ¨¡ + é—²æ—¶æ¶ˆåŒ–ç¿»è¯‘é˜Ÿåˆ—
  # ğŸ”¥ "ä¸“ä¸šåˆ†å·¥ + é—²æ—¶æ”¯æ´"ç­–ç•¥
  worker-learning:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-learning
    restart: unless-stopped
    # ğŸ”¥ VIP å¿«è½¦é“ï¼šä¼˜å…ˆ learningï¼Œé—²æ—¶æ”¯æ´ translation
    # Celery æŒ‰é˜Ÿåˆ—é¡ºåºä¼˜å…ˆçº§å¤„ç†ï¼šlearning ä¼˜å…ˆäº translation
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=100 -Q learning,translation -n learning@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d learning@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ==========================================================================
  # Worker 3: AI ååä¸»åŠ› 1 å· (Heavy Lifter #1)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼šlearning, translation, analysis
  # æ¨¡å¼ï¼šGevent, 150 åç¨‹
  # èŒè´£ï¼šé«˜å¹¶å‘è°ƒç”¨ LLM APIï¼Œç¿»è¯‘/æ´å¯Ÿ/ä¸»é¢˜ + learning å¤‡ä»½
  worker-heavy-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-heavy-1
    restart: unless-stopped
    # ğŸ”¥ è¶…é«˜å¹¶å‘ï¼š150 åç¨‹åŒæ—¶æŒ‚èµ· API è¯·æ±‚
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=150 -Q learning,translation,analysis -n heavy1@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d heavy1@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ==========================================================================
  # Worker 4: AI ååä¸»åŠ› 2 å· (Heavy Lifter #2)
  # ==========================================================================
  # ä¸ Worker 3 å®Œå…¨ç›¸åŒï¼Œåˆ†æ‹…è´Ÿè½½
  worker-heavy-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-heavy-2
    restart: unless-stopped
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=150 -Q learning,translation,analysis -n heavy2@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d heavy2@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ============================================================================
  # React Frontend
  # ============================================================================
  app-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: voc-frontend
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      - app-backend
    networks:
      - voc-network

  # ============================================================================
  # Nginx åå‘ä»£ç†
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: voc-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "3000:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - app-backend
      - app-frontend
    networks:
      - voc-network

volumes:
  postgres_data:
  redis_data:

networks:
  voc-network:
    driver: bridge
