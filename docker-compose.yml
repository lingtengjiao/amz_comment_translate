services:
  # ============================================================================
  # ğŸ—„ï¸ PostgreSQL Databaseï¼ˆä¼˜åŒ–é…ç½®ï¼š4GB shared_buffersï¼‰
  # ============================================================================
  db-postgres:
    image: postgres:15-alpine
    container_name: voc-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-vocmaster}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-vocmaster123}
      POSTGRES_DB: ${POSTGRES_DB:-vocmaster}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    # ğŸ”¥ PostgreSQL é«˜æ€§èƒ½é…ç½®ï¼ˆ16GB æœåŠ¡å™¨ä¼˜åŒ–ï¼‰
    command: >
      postgres
      -c shared_buffers=4GB
      -c work_mem=64MB
      -c max_connections=500
      -c effective_cache_size=8GB
      -c maintenance_work_mem=512MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=64MB
      -c random_page_cost=1.1
    # é™åˆ¶å†…å­˜ä½¿ç”¨ï¼Œç¡®ä¿ä¸è¶…è¿‡åˆ†é…
    deploy:
      resources:
        limits:
          memory: 5G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vocmaster}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - voc-network

  # ============================================================================
  # ğŸ”´ Redisï¼ˆ2GB å†…å­˜é™åˆ¶ï¼Œé˜Ÿåˆ—ç¼“å†²åŒºï¼‰
  # ============================================================================
  db-redis:
    image: redis:7-alpine
    container_name: voc-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    # ğŸ”¥ Redis é«˜æ€§èƒ½é…ç½®
    command: >
      redis-server
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
    deploy:
      resources:
        limits:
          memory: 2G
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - voc-network

  # ============================================================================
  # ğŸš€ FastAPI Backend
  # ============================================================================
  app-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-backend
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    ports:
      - "8000:8000"
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - voc-network

  # ============================================================================
  # ğŸš€ Celery Workersï¼ˆ5 é˜Ÿåˆ— + 4 Worker é«˜ååæ¶æ„ï¼‰
  # ============================================================================
  #
  # ğŸ¯ è®¾è®¡ç›®æ ‡ï¼š4æ ¸16G æœåŠ¡å™¨ï¼Œ404 å¹¶å‘ APIï¼Œæ”¯æŒç™¾äººåŒæ—¶é‡‡é›†
  #
  # 5 ç‹¬ç«‹é˜Ÿåˆ—ï¼š
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ 1. ingestion   - å…¥åº“ï¼ˆç§’çº§å“åº”ï¼‰                                  â”‚
  # â”‚ 2. reports     - æŠ¥å‘Šç”Ÿæˆï¼ˆç§’çº§å“åº”ï¼‰                              â”‚
  # â”‚ 3. learning    - å­¦ä¹ ç»´åº¦/5Wï¼ˆæ–°äº§å“ç§’çº§å»ºæ¨¡ï¼‰                      â”‚
  # â”‚ 4. translation - ç¿»è¯‘ï¼ˆé«˜å¹¶å‘ AI APIï¼‰                            â”‚
  # â”‚ 5. analysis    - æ´å¯Ÿ+ä¸»é¢˜ï¼ˆé«˜å¹¶å‘ AI APIï¼‰                        â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  #
  # 4 Worker åˆ†å·¥ï¼š
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ Worker 1: åŸºç¡€å“åº”å‘˜ (Prefork, 4çº¿ç¨‹)                             â”‚
  # â”‚   Queue: ingestion, reports, celery                              â”‚
  # â”‚   ç‰¹ç‚¹ï¼šçº¯ CPU + ç£ç›˜ï¼Œä¿è¯ API æ°¸è¿œä¸å¡                           â”‚
  # â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  # â”‚ Worker 2: VIP å»ºæ¨¡å‘˜ (Gevent, 100åç¨‹)                            â”‚
  # â”‚   Queue: learning                                                 â”‚
  # â”‚   ç‰¹ç‚¹ï¼šæ–°äº§å“ç§’çº§å»ºæ¨¡ï¼Œç‹¬ç«‹å¿«è½¦é“                                  â”‚
  # â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  # â”‚ Worker 3 & 4: AI ååä¸»åŠ› (Gevent, å„150åç¨‹)                     â”‚
  # â”‚   Queue: learning, translation, analysis                         â”‚
  # â”‚   ç‰¹ç‚¹ï¼š300 å¹¶å‘ APIï¼Œç¿»è¯‘/æ´å¯Ÿ/ä¸»é¢˜ä¸€èµ·å¤„ç†                       â”‚
  # â”‚   learning ä¹Ÿç›‘å¬ï¼Œä½œä¸º VIP Worker çš„å¤‡ä»½                          â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  #
  # æ€»å¹¶å‘ï¼š4 + 100 + 300 = 404 å¹¶å‘ API è¯·æ±‚ï¼

  # ============================================================================
  # ğŸš€ 6 é˜Ÿåˆ— + 5 Worker èŒèƒ½åŒ–æ¶æ„ï¼ˆè§£å†³ç¿»è¯‘é˜»å¡åˆ†æé—®é¢˜ï¼‰
  # ============================================================================
  #
  # ğŸ¯ æ ¸å¿ƒä¼˜åŒ–ï¼šç‰©ç†éš”ç¦»é˜Ÿåˆ— + èŒèƒ½åŒ– Worker åˆ†å·¥
  #
  # æ€»å¹¶å‘ï¼š4 + 50 + 100 + 100 + 100 = 354 å¹¶å‘ï¼
  #
  # æ ¸å¿ƒä¼˜åŠ¿ï¼š
  # - ç¿»è¯‘ä¸å†æ˜¯å±éšœï¼šç‹¬ç«‹ Workerï¼Œä¸é˜»å¡åˆ†æ
  # - å»ºæ¨¡æ°¸è¿œä¼˜å…ˆï¼šæ‰€æœ‰ AI Worker éƒ½æ”¯æ´ learning
  # - æ´å¯Ÿ/ä¸»é¢˜å¹¶è¡Œï¼šå„æœ‰ä¸“å±é˜Ÿåˆ—ï¼Œä¸äº’ç›¸ç«äº‰
  #

  # ==========================================================================
  # Worker 1: åŸºç¡€å“åº”å‘˜ (Base Worker)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼šingestion, reports, celery
  # æ¨¡å¼ï¼šPrefork, 4 çº¿ç¨‹
  # èŒè´£ï¼šæ­»å®ˆå…¥åº“ï¼Œä¸æ¥ AI æ´»ï¼Œç¡®ä¿æ’ä»¶ä¸Šä¼ æ°¸è¿œç§’å›
  worker-base:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-base
    restart: unless-stopped
    # Beat åœ¨è¿™é‡Œè¿è¡Œ
    command: celery -A app.worker worker --beat --loglevel=info --concurrency=4 -Q ingestion,reports,celery -n base@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d base@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ==========================================================================
  # Worker 2: VIP å»ºæ¨¡å‘˜ (VIP/Learning)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼šlearningï¼ˆä¸“å±ï¼‰
  # æ¨¡å¼ï¼šGevent, 50 åç¨‹
  # èŒè´£ï¼šå»ºæ¨¡å¿«è½¦é“ï¼Œä¸“æ”»ç»´åº¦å­¦ä¹ å’Œ 5W å»ºæ¨¡ï¼Œåˆ†æå¼€å§‹çš„å¼€å…³
  worker-vip:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-vip
    restart: unless-stopped
    # ğŸŒŸ VIP å¿«è½¦é“ï¼šåªç›‘å¬ learningï¼Œä¿è¯æ–°äº§å“ç§’çº§å»ºæ¨¡
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=50 -Q learning -n vip@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d vip@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ==========================================================================
  # Worker 3: ç‹¬ç«‹ç¿»è¯‘ç»„ (Translation)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼štranslationï¼ˆä¸“å±ï¼‰
  # æ¨¡å¼ï¼šGevent, 100 åç¨‹
  # èŒè´£ï¼šä¸“é—¨æ¶ˆåŒ–æµ·é‡ç¿»è¯‘ï¼Œä¸å½±å“å…¶ä»–åˆ†æä»»åŠ¡
  worker-trans:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-trans
    restart: unless-stopped
    # ğŸ”„ ç‹¬ç«‹ç¿»è¯‘ï¼šä¸“å±é˜Ÿåˆ—ï¼Œä¸é˜»å¡æ´å¯Ÿå’Œä¸»é¢˜æå–
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=100 -Q translation -n trans@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1.5G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d trans@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ==========================================================================
  # Worker 4: æ´å¯Ÿä¸“å‘˜ (Insight Extraction)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼šinsight_extraction, learningï¼ˆä¼˜å…ˆæ´å¯Ÿï¼Œé—²æ—¶æ”¯æ´å»ºæ¨¡ï¼‰
  # æ¨¡å¼ï¼šGevent, 100 åç¨‹
  # èŒè´£ï¼šä¸»æ”»æ´å¯Ÿæå–ï¼Œé—²æ—¶æ”¯æ´å»ºæ¨¡
  worker-insight:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-insight
    restart: unless-stopped
    # ğŸ” æ´å¯Ÿä¸“å‘˜ï¼šä¼˜å…ˆ insight_extractionï¼Œé—²æ—¶æ”¯æ´ learning
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=100 -Q insight_extraction,learning -n insight@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1.5G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d insight@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ==========================================================================
  # Worker 5: ä¸»é¢˜ä¸“å‘˜ (Theme Extraction)
  # ==========================================================================
  # é˜Ÿåˆ—ï¼štheme_extraction, learningï¼ˆä¼˜å…ˆä¸»é¢˜ï¼Œé—²æ—¶æ”¯æ´å»ºæ¨¡ï¼‰
  # æ¨¡å¼ï¼šGevent, 100 åç¨‹
  # èŒè´£ï¼šä¸»æ”»ä¸»é¢˜æå–ï¼Œé—²æ—¶æ”¯æ´å»ºæ¨¡
  worker-theme:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voc-worker-theme
    restart: unless-stopped
    # ğŸ·ï¸ ä¸»é¢˜ä¸“å‘˜ï¼šä¼˜å…ˆ theme_extractionï¼Œé—²æ—¶æ”¯æ´ learning
    command: celery -A app.worker worker --loglevel=info --pool=gevent --concurrency=100 -Q theme_extraction,learning -n theme@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-vocmaster}:${POSTGRES_PASSWORD:-vocmaster123}@db-postgres:5432/${POSTGRES_DB:-vocmaster}
      - REDIS_URL=redis://db-redis:6379/0
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
    depends_on:
      db-postgres:
        condition: service_healthy
      db-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    deploy:
      resources:
        limits:
          memory: 1.5G
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.worker inspect ping -d theme@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - voc-network

  # ============================================================================
  # ğŸŒ¸ Flower - Celery å®æ—¶ç›‘æ§é¢æ¿
  # ============================================================================
  # ç›‘æ§ 5 ä¸ª Worker çš„å®æ—¶çŠ¶æ€ã€ä»»åŠ¡æ‰§è¡Œã€é˜Ÿåˆ—æƒ…å†µ
  # Worker: base, vip, trans, insight, theme
  # è®¿é—®: http://localhost:5555
  flower:
    image: mher/flower:2.0
    container_name: voc-flower
    restart: unless-stopped
    command: celery --broker=redis://db-redis:6379/0 flower --port=5555 --broker_api=redis://db-redis:6379/0
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://db-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://db-redis:6379/0
    depends_on:
      db-redis:
        condition: service_healthy
    networks:
      - voc-network

  # ============================================================================
  # React Frontend
  # ============================================================================
  app-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: voc-frontend
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      - app-backend
    networks:
      - voc-network

  # ============================================================================
  # Nginx åå‘ä»£ç†
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: voc-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "3000:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - app-backend
      - app-frontend
    networks:
      - voc-network

volumes:
  postgres_data:
  redis_data:

networks:
  voc-network:
    driver: bridge
