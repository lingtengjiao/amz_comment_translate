# 细分市场洞察分析数据流转文档

## 1. 概述

细分市场洞察分析（Market Insight Analysis）是一个多产品聚合分析功能，通过项目级学习建立统一标准，然后基于映射关系聚合多个产品的数据，生成市场级别的洞察。

**核心思想**：
- **"学习一次，分类多次"**：从多个产品中采样评论，学习统一的项目级维度和标签标准
- **映射关系**：建立项目级标准与产品级数据的映射关系（1:N）
- **数据聚合**：基于映射关系，将产品级数据聚合到项目级，无需重新分析评论

## 2. 前置条件

### 2.1 产品分析状态检查

市场洞察分析要求所有参与产品都已完成单产品分析：

- ✅ 产品必须有维度（`product_dimensions` 表有数据）
- ✅ 产品必须有标签（`product_context_labels` 表有数据）

**检查逻辑**：
```python
# backend/app/services/project_learning_service.py
async def check_products_analysis_status(product_ids: List[UUID])
```

**API 端点**：
```
POST /api/v1/analysis/products/analysis-status
```

如果产品未完成分析，会返回错误信息，阻止创建市场洞察项目。

### 2.2 数据准备

- 产品评论已翻译完成（`translation_status = 'completed'`）
- 产品已完成单产品分析（有维度和标签）
- 产品有足够的评论样本（建议每个产品至少 50 条评论）

## 3. 数据流转步骤

### Step 0: 项目级维度/标签学习

**目标**：从多个产品中学习统一的市场级维度和标签标准

**执行流程**：

1. **采样评论**
   - 从每个产品采样 40 条评论（英文原文）
   - 总样本数限制在 100 条以内
   - 分层采样：差评 25%，中评 15%，好评 60%
   - 优先使用已翻译的评论

2. **学习项目级维度**
   - 调用 `translation_service.learn_dimensions_from_raw()`
   - 输入：80 条英文评论 + 产品标题和卖点
   - 输出：3 类维度（product/scenario/emotion）
   - 示例输出：
     ```json
     {
       "product": [
         {"name": "功能表现", "description": "..."},
         {"name": "结构做工", "description": "..."}
       ],
       "scenario": [
         {"name": "亲子互动", "description": "..."},
         {"name": "车载使用", "description": "..."}
       ],
       "emotion": [
         {"name": "惊喜好评", "description": "..."},
         {"name": "失望不满", "description": "..."}
       ]
     }
     ```

3. **学习项目级标签**
   - 调用 `translation_service.learn_context_labels_from_raw()`
   - 输入：80 条英文评论 + 产品标题和卖点
   - 输出：5W 标签（buyer/user/where/when/why/what）
   - 示例输出：
     ```json
     {
       "buyer": [{"name": "宝妈", "description": "..."}, ...],
       "user": [{"name": "3岁幼儿", "description": "..."}, ...],
       "where": [{"name": "家中", "description": "..."}, ...],
       "when": [{"name": "旅行时", "description": "..."}, ...],
       "why": [{"name": "教育目的", "description": "..."}, ...],
       "what": [{"name": "颜色配对", "description": "..."}, ...]
     }
     ```

4. **存储项目级标准**
   - 保存到 `project_dimensions` 表
   - 保存到 `project_context_labels` 表

**代码位置**：
- `backend/app/services/project_learning_service.py::learn_project_dimensions_and_labels()`

### Step 1: 建立映射关系

**目标**：建立项目级标准与产品级数据的映射关系（1:N）

**映射类型**：

#### 1.1 维度映射（Dimension Mapping）

**映射规则**：
- 维度映射**限制类型**（product→product, scenario→scenario, emotion→emotion）
- 一个项目级维度可以映射多个产品级维度
- 基于语义相似度匹配

**执行流程**：

1. **AI 映射**（优先）
   - 调用 AI 建立映射关系
   - 输入：项目级维度名称列表 + 产品级维度名称列表（按类型分组）
   - 输出：映射关系 JSON
   - 示例：
     ```json
     {
       "product": {
         "功能表现": [
           {"product_id": "xxx", "dimension_name": "功能表现"},
           {"product_id": "yyy", "dimension_name": "功能表现"}
         ]
       },
       "scenario": {
         "车载使用": [
           {"product_id": "xxx", "dimension_name": "便携性与使用场景"}
         ]
       }
     }
     ```

2. **后备映射**（AI 失败时）
   - 基于名称相似度（SequenceMatcher）
   - 相似度阈值：0.5
   - 同类型内匹配

3. **保存映射**
   - 保存到 `project_dimension_mappings` 表
   - 字段：`project_dimension_id`, `product_dimension_id`, `product_id`

#### 1.2 标签映射（Label Mapping）

**映射规则**：
- 标签映射**限制类型**（buyer→buyer, user→user, where→where 等）
- 一个项目级标签可以映射多个产品级标签
- 基于语义相似度匹配

**执行流程**：

1. **AI 映射**（优先）
   - 调用 AI 建立映射关系
   - 输入：项目级标签名称列表 + 产品级标签名称列表（按类型分组）
   - 输出：映射关系 JSON
   - 示例：
     ```json
     {
       "buyer": {
         "宝妈": [
           {"product_id": "xxx", "label_name": "宝妈"},
           {"product_id": "yyy", "label_name": "宝妈"}
         ]
       },
       "user": {
         "3岁幼儿": [
           {"product_id": "xxx", "label_name": "3岁幼儿"},
           {"product_id": "yyy", "label_name": "3岁幼儿"}
         ]
       }
     }
     ```

2. **后备映射**（AI 失败时）
   - 基于名称相似度（SequenceMatcher）
   - 相似度阈值：0.5
   - 同类型内匹配

3. **保存映射**
   - 保存到 `project_label_mappings` 表
   - 字段：`project_label_id`, `product_label_id`, `product_id`

**代码位置**：
- `backend/app/services/project_learning_service.py::_create_dimension_mappings()`
- `backend/app/services/project_learning_service.py::_create_label_mappings()`

### Step 2: 收集产品数据

**目标**：获取所有参与产品的完整分析数据

**执行流程**：

1. **遍历产品列表**
   - 从 `analysis_project_items` 表获取产品 ID 列表

2. **获取产品数据**
   - 调用 `_fetch_product_data_full()` 方法
   - 获取内容：
     - 产品基本信息（ASIN、标题、图片等）
     - 评论统计（总数、平均评分等）
     - 5W 用户画像数据（`user_context`）
     - 关键洞察数据（`key_insights`）
     - 维度统计（`dimensions`）

3. **保存快照**
   - 保存到 `analysis_projects.raw_data_snapshot` 字段（JSON）

**数据结构**：
```json
{
  "product_name": {
    "asin": "B0D5CW9RLM",
    "user_context": {
      "buyer": {"items": [{"name": "宝妈", "value": 50}, ...]},
      "user": {"items": [{"name": "3岁幼儿", "value": 45}, ...]},
      "where": {"items": [{"name": "家中", "value": 60}, ...]},
      ...
    },
    "key_insights": {
      "strength": {"items": [{"name": "功能表现", "value": 80}, ...]},
      "weakness": {"items": [{"name": "安全性", "value": 20}, ...]},
      ...
    }
  }
}
```

**代码位置**：
- `backend/app/services/analysis_service.py::_run_market_insight_analysis()` (Step 1)

### Step 3: 聚合市场级别数据

**目标**：基于映射关系，将产品级数据聚合到项目级

**执行流程**：

1. **5W 数据聚合**
   - 遍历所有产品的 5W 标签数据
   - 按类型（buyer/user/where/when/why/what）聚合
   - 相同标签名称的计数累加
   - 示例：
     ```
     产品A: buyer["宝妈"] = 50
     产品B: buyer["宝妈"] = 30
     → 市场级: buyer["宝妈"] = 80
     ```

2. **洞察数据聚合**
   - 遍历所有产品的洞察数据
   - 按类型（strength/weakness/suggestion/scenario/emotion）聚合
   - **注意**：这里聚合的是产品级维度名称，不是项目级维度
   - 示例：
     ```
     产品A: strength["功能表现"] = 80
     产品B: strength["功能表现"] = 60
     → 市场级: strength["功能表现"] = 140
     ```

3. **排序和格式化**
   - 按计数降序排序
   - 计算百分比
   - 限制 Top 20

**聚合结果结构**：
```json
{
  "five_w": {
    "buyer": [
      {"label": "宝妈", "count": 80, "percentage": "45.2%"},
      {"label": "幼教老师", "count": 50, "percentage": "28.2%"},
      ...
    ],
    "user": [...],
    "where": [...],
    ...
  },
  "dimensions": {
    "pros": [
      {"label": "功能表现", "count": 140, "percentage": "35.0%"},
      ...
    ],
    "cons": [...],
    "suggestion": [...],
    ...
  },
  "total_products": 2,
  "total_labels": 150
}
```

**代码位置**：
- `backend/app/services/analysis_service.py::_aggregate_market_data()`

**重要说明**：
- 当前聚合逻辑是**直接按标签名称聚合**，没有使用映射关系
- 这意味着如果产品级标签名称不同，即使语义相同，也不会聚合
- 未来优化方向：基于映射关系，将产品级标签聚合到项目级标签

### Step 4: 生成产品摘要

**目标**：为每个产品生成简洁的摘要，用于 AI 分析

**摘要内容**：
- 产品名称和 ASIN
- 评论数量
- Top 5W 标签（用户、时机、场景、动机、用途）
- Top 优势/痛点

**代码位置**：
- `backend/app/services/analysis_service.py::_generate_product_summaries_for_market()`

### Step 5: AI 分析生成

**目标**：基于聚合数据生成市场级别的洞察分析

**并行执行 4 个 AI 分析任务**：

#### 5.1 市场概览（Market Overview）

**Prompt**：`MARKET_AGGREGATION_PROMPT`

**输入**：
- 产品数量、总评论数
- 聚合统计数据（5W + 洞察）
- 产品摘要

**输出**：
```json
{
  "market_overview": {
    "summary": "市场整体概述",
    "market_size_indicator": "高需求/中等需求/小众市场",
    "maturity_level": "新兴市场/成长期/成熟期/饱和期",
    "competition_intensity": "低/中/高"
  },
  "common_needs": {
    "description": "市场共性需求总结",
    "top_needs": [...],
    "confidence": "high/medium/low"
  },
  "common_pain_points": {
    "description": "市场共性痛点总结",
    "top_pain_points": [...],
    "confidence": "high/medium/low"
  },
  "market_concentration": {
    "description": "市场需求集中度分析",
    "concentration_level": "high/medium/low",
    "dominant_dimensions": [...],
    "fragmented_dimensions": [...]
  }
}
```

#### 5.2 市场用户画像（Market Persona）

**Prompt**：`MARKET_SEGMENT_PROMPT`

**输入**：
- 产品数量、总评论数
- 5W 聚合数据

**输出**：
```json
{
  "market_persona": {
    "primary_buyers": {
      "description": "主要购买者群体描述",
      "segments": [...],
      "confidence": "high/medium/low"
    },
    "primary_users": {
      "description": "主要使用者群体描述",
      "segments": [...],
      "confidence": "high/medium/low"
    },
    "usage_scenarios": {
      "description": "典型使用场景总结",
      "top_scenarios": [...],
      "confidence": "high/medium/low"
    },
    "purchase_motivations": {
      "description": "主要购买动机总结",
      "top_motivations": [...],
      "confidence": "high/medium/low"
    },
    "jobs_to_be_done": {
      "description": "用户核心任务/JTBD",
      "primary_jtbd": "核心任务描述",
      "secondary_jtbd": [...]
    }
  },
  "typical_user_story": "一段描述典型用户画像的故事"
}
```

#### 5.3 市场机会（Market Opportunities）

**Prompt**：`MARKET_OPPORTUNITY_PROMPT`

**输入**：
- 产品数量、总评论数
- 产品摘要
- 痛点数据（cons + suggestion）

**输出**：
```json
{
  "market_opportunities": {
    "description": "市场机会总结",
    "opportunities": [
      {
        "opportunity": "机会描述",
        "potential": "high/medium/low",
        "evidence": "支撑证据"
      },
      ...
    ],
    "confidence": "high/medium/low"
  }
}
```

#### 5.4 市场趋势（Market Trends）

**Prompt**：`MARKET_TREND_PROMPT`

**输入**：
- 产品数量、总评论数
- 产品摘要
- 聚合数据

**输出**：
```json
{
  "market_trends": {
    "description": "市场趋势总结",
    "trends": [
      {
        "trend": "趋势描述",
        "direction": "上升/下降/稳定",
        "evidence": "支撑证据"
      },
      ...
    ],
    "confidence": "high/medium/low"
  }
}
```

**代码位置**：
- `backend/app/services/analysis_service.py::_run_market_insight_analysis()` (Step 5)

### Step 6: 保存分析结果

**目标**：将 AI 分析结果保存到数据库

**保存内容**：
- 市场概览
- 市场用户画像
- 市场机会
- 市场趋势
- 产品对比数据（保留）

**保存位置**：
- `analysis_projects.result_content` 字段（JSON）

**代码位置**：
- `backend/app/services/analysis_service.py::_run_market_insight_analysis()` (Step 6)

## 4. 数据库表结构

### 4.1 项目级学习表

#### project_dimensions
项目级维度标准

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| project_id | UUID | 项目 ID |
| name | String | 维度名称 |
| description | String | 维度描述 |
| dimension_type | String | 维度类型（product/scenario/emotion） |
| is_ai_generated | Boolean | 是否 AI 生成 |
| created_at | Timestamp | 创建时间 |
| updated_at | Timestamp | 更新时间 |

#### project_context_labels
项目级标签标准

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| project_id | UUID | 项目 ID |
| type | String | 标签类型（buyer/user/where/when/why/what） |
| name | String | 标签名称 |
| description | String | 标签描述 |
| is_ai_generated | Boolean | 是否 AI 生成 |
| created_at | Timestamp | 创建时间 |
| updated_at | Timestamp | 更新时间 |

### 4.2 映射关系表

#### project_dimension_mappings
项目级维度与产品级维度的映射关系

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| project_dimension_id | UUID | 项目级维度 ID |
| product_dimension_id | UUID | 产品级维度 ID |
| product_id | UUID | 产品 ID（冗余字段，用于查询优化） |
| created_at | Timestamp | 创建时间 |

**关系**：1 个项目级维度 → N 个产品级维度

#### project_label_mappings
项目级标签与产品级标签的映射关系

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| project_label_id | UUID | 项目级标签 ID |
| product_label_id | UUID | 产品级标签 ID |
| product_id | UUID | 产品 ID（冗余字段，用于查询优化） |
| created_at | Timestamp | 创建时间 |

**关系**：1 个项目级标签 → N 个产品级标签

### 4.3 分析项目表

#### analysis_projects
分析项目主表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| title | String | 项目标题 |
| analysis_type | String | 分析类型（market_insight/comparison） |
| status | String | 状态（pending/processing/completed/failed） |
| result_content | JSON | 分析结果（包含市场洞察） |
| raw_data_snapshot | JSON | 原始数据快照 |
| error_message | String | 错误信息 |
| created_at | Timestamp | 创建时间 |
| updated_at | Timestamp | 更新时间 |

## 5. 映射关系详解

### 5.1 维度映射规则

**类型限制**：
- `product` 类型维度只能映射到 `product` 类型
- `scenario` 类型维度只能映射到 `scenario` 类型
- `emotion` 类型维度只能映射到 `emotion` 类型

**映射方式**：
1. **AI 映射（优先）**：基于语义理解建立映射
2. **后备映射**：基于名称相似度（阈值 0.5）

**示例**：
```
项目级维度（scenario）: "车载使用"
  ↓ 映射到
产品级维度（product）: "便携性与使用场景"
  （AI 理解语义相似，允许跨类型映射）
```

**注意**：旧数据问题
- 旧版本的产品级维度只有 `product` 类型
- 新版本应该有三种类型（product/scenario/emotion）
- 如果产品级维度缺少某些类型，对应类型的项目级维度无法建立映射

### 5.2 标签映射规则

**类型限制**：
- `buyer` 只能映射到 `buyer`
- `user` 只能映射到 `user`
- `where` 只能映射到 `where`
- `when` 只能映射到 `when`
- `why` 只能映射到 `why`
- `what` 只能映射到 `what`

**映射方式**：
1. **AI 映射（优先）**：基于语义理解建立映射
2. **后备映射**：基于名称相似度（阈值 0.5）

**示例**：
```
项目级标签（buyer）: "宝妈"
  ↓ 映射到
产品A标签（buyer）: "宝妈"  （完全匹配）
产品B标签（buyer）: "宝妈"  （完全匹配）
```

## 6. 数据聚合逻辑

### 6.1 当前聚合方式

**5W 数据聚合**：
- 直接按标签名称聚合
- 相同名称的计数累加
- 跨产品合并

**洞察数据聚合**：
- 直接按维度名称聚合
- 相同名称的计数累加
- 跨产品合并

**问题**：
- 如果产品级标签名称不同，即使语义相同，也不会聚合
- 例如：产品A 有 "宝妈"，产品B 有 "妈妈"，不会聚合

### 6.2 未来优化方向

**基于映射关系聚合**：
1. 通过 `project_label_mappings` 表，找到产品级标签对应的项目级标签
2. 将产品级标签的计数聚合到项目级标签
3. 这样即使产品级标签名称不同，也能正确聚合

**示例**：
```
产品A: buyer["宝妈"] = 50
产品B: buyer["妈妈"] = 30

映射关系：
  "宝妈" (项目级) ← "宝妈" (产品A)
  "宝妈" (项目级) ← "妈妈" (产品B)

聚合结果：
  "宝妈" (项目级) = 50 + 30 = 80
```

## 7. 关键代码文件

### 7.1 项目级学习
- `backend/app/services/project_learning_service.py`
  - `learn_project_dimensions_and_labels()` - 主入口
  - `_sample_reviews_raw()` - 采样评论
  - `_create_dimension_mappings()` - 建立维度映射
  - `_create_label_mappings()` - 建立标签映射
  - `_save_project_learning_result()` - 保存学习结果

### 7.2 市场洞察分析
- `backend/app/services/analysis_service.py`
  - `_run_market_insight_analysis()` - 主入口
  - `_aggregate_market_data()` - 聚合市场数据
  - `_generate_product_summaries_for_market()` - 生成产品摘要

### 7.3 翻译服务
- `backend/app/services/translation.py`
  - `learn_dimensions_from_raw()` - 学习维度
  - `learn_context_labels_from_raw()` - 学习标签

### 7.4 API 端点
- `backend/app/api/analysis.py`
  - `POST /api/v1/analysis/projects` - 创建分析项目
  - `POST /api/v1/analysis/projects/{id}/run` - 触发分析
  - `POST /api/v1/analysis/products/analysis-status` - 检查产品分析状态

## 8. 数据流转图

```
┌─────────────────────────────────────────────────────────────┐
│ Step 0: 项目级学习                                          │
├─────────────────────────────────────────────────────────────┤
│ 1. 采样评论（80-100条）                                      │
│ 2. 学习项目级维度（3类：product/scenario/emotion）           │
│ 3. 学习项目级标签（5W：buyer/user/where/when/why/what）     │
│ 4. 保存到 project_dimensions 和 project_context_labels      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 建立映射关系                                         │
├─────────────────────────────────────────────────────────────┤
│ 1. AI 映射（优先）                                           │
│    - 维度映射：项目级维度 → 产品级维度（同类型）              │
│    - 标签映射：项目级标签 → 产品级标签（同类型）              │
│ 2. 后备映射（AI 失败时）                                     │
│    - 基于名称相似度（阈值 0.5）                              │
│ 3. 保存到 project_dimension_mappings 和 project_label_mappings │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 2: 收集产品数据                                         │
├─────────────────────────────────────────────────────────────┤
│ 1. 遍历产品列表                                              │
│ 2. 获取每个产品的完整数据                                    │
│    - 5W 用户画像（user_context）                             │
│    - 关键洞察（key_insights）                                │
│    - 维度统计（dimensions）                                  │
│ 3. 保存快照到 raw_data_snapshot                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 3: 聚合市场数据                                         │
├─────────────────────────────────────────────────────────────┤
│ 1. 5W 数据聚合（按标签名称）                                 │
│    - buyer/user/where/when/why/what                         │
│ 2. 洞察数据聚合（按维度名称）                                │
│    - strength/weakness/suggestion/scenario/emotion           │
│ 3. 排序和格式化（Top 20，计算百分比）                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 4: 生成产品摘要                                         │
├─────────────────────────────────────────────────────────────┤
│ 为每个产品生成简洁摘要（用于 AI 分析）                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 5: AI 分析生成（并行）                                 │
├─────────────────────────────────────────────────────────────┤
│ 1. 市场概览（Market Overview）                               │
│ 2. 市场用户画像（Market Persona）                           │
│ 3. 市场机会（Market Opportunities）                          │
│ 4. 市场趋势（Market Trends）                                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 6: 保存分析结果                                         │
├─────────────────────────────────────────────────────────────┤
│ 保存到 analysis_projects.result_content                     │
└─────────────────────────────────────────────────────────────┘
```

## 9. 注意事项

### 9.1 旧数据兼容性

- **产品级维度类型**：旧数据只有 `product` 类型，新数据应该有三种类型
- **产品级标签类型**：旧数据可能只有 `who` 类型，新数据应该有 `buyer` 和 `user` 类型
- **解决方案**：重新运行产品级分析，生成新格式的数据

### 9.2 映射失败处理

- **AI 映射失败**：自动切换到后备映射方案（基于名称相似度）
- **后备映射失败**：返回空映射，但不影响整体流程
- **日志记录**：详细记录映射过程，便于调试

### 9.3 数据聚合优化

- **当前问题**：直接按名称聚合，如果名称不同不会聚合
- **未来优化**：基于映射关系聚合，将产品级数据聚合到项目级标准

### 9.4 性能考虑

- **采样限制**：每个产品最多 40 条，总样本最多 100 条
- **AI 调用**：使用异步并行调用，提高效率
- **数据库查询**：使用 JOIN 和批量查询，减少 N+1 问题

## 10. 相关文档

- [市场洞察功能测试指南](./市场洞察功能测试指南.md)
- [市场洞察功能联调总结](./市场洞察功能联调总结.md)
- [数据库结构对比报告](./数据库结构对比报告.md)

---

**文档版本**：v1.0  
**最后更新**：2026-01-17  
**维护者**：AI Assistant
