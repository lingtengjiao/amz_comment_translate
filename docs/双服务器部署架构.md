# 🚀 双服务器部署架构方案

## 📊 资源概览

### 服务器配置

| 服务器 | 配置 | 角色 | 主要职责 |
|--------|------|------|----------|
| **服务器 A** | 8核16G | 主服务器 | 数据库 + 应用 + 翻译 Worker |
| **服务器 B** | 4核8G | Worker 节点 | 洞察 + 主题 + 翻译备份 |

### API 限制

| 模型 | RPM | RPS | 安全 RPS (80%) |
|------|-----|-----|----------------|
| qwen-plus-latest | 15,000 | 250 | **200** |
| qwen3-max | 600 | 10 | 8 |

---

## 🏗️ 架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        服务器 A (8核16G) - 主服务器                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ PostgreSQL  │  │    Redis    │  │   Nginx     │  │   Flower    │    │
│  │   (5GB)     │  │   (2GB)     │  │             │  │   监控      │    │
│  └─────────────┘  └──────┬──────┘  └─────────────┘  └─────────────┘    │
│                          │                                              │
│  ┌─────────────┐  ┌──────┴──────┐  ┌─────────────┐                     │
│  │  Backend    │  │             │  │  Frontend   │                     │
│  │  (FastAPI)  │◄─┤  消息队列   ├─►│  (React)    │                     │
│  └─────────────┘  │             │  └─────────────┘                     │
│                   └──────┬──────┘                                       │
│                          │                                              │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        Worker 层                                  │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │
│  │  │ worker-base │  │  worker-vip │  │ worker-trans│               │  │
│  │  │ (Prefork,4) │  │ (Gevent,30) │  │ (Gevent,60) │               │  │
│  │  │ 入库+报告   │  │    建模     │  │    翻译     │               │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘               │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Redis 消息队列 (TCP 6379)
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       服务器 B (4核8G) - Worker 节点                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        Worker 层                                  │  │
│  │                                                                   │  │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐         │  │
│  │  │worker-insight │  │ worker-theme  │  │worker-trans-2 │         │  │
│  │  │ (Gevent, 4)   │  │ (Gevent, 4)   │  │ (Gevent, 40)  │         │  │
│  │  │PARALLEL_SIZE  │  │PARALLEL_SIZE  │  │    翻译备份   │         │  │
│  │  │    = 40       │  │    = 50       │  │               │         │  │
│  │  │  洞察提取     │  │  主题提取     │  │               │         │  │
│  │  └───────────────┘  └───────────────┘  └───────────────┘         │  │
│  │                                                                   │  │
│  │  ┌───────────────┐                                               │  │
│  │  │ worker-backup │                                               │  │
│  │  │ (Gevent, 20)  │                                               │  │
│  │  │  全能备份     │                                               │  │
│  │  └───────────────┘                                               │  │
│  │                                                                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 队列设计

### 6 队列架构（保持不变）

| 队列名称 | 职责 | 处理 Worker |
|----------|------|-------------|
| `ingestion` | 评论入库 | A: worker-base |
| `reports` | 报告生成 | A: worker-base |
| `celery` | 默认队列 | A: worker-base |
| `learning` | 维度学习/5W建模 | A: worker-vip, B: worker-backup |
| `translation` | 翻译任务 | A: worker-trans, B: worker-trans-2 |
| `insight_extraction` | 洞察提取 | B: worker-insight, worker-backup |
| `theme_extraction` | 主题提取 | B: worker-theme, worker-backup |

---

## 👷 Worker 配置详解

### 服务器 A Workers

| Worker | 并发模式 | 并发数 | 队列 | 内存 | 职责 |
|--------|----------|--------|------|------|------|
| **base** | Prefork | 4 进程 | ingestion, reports, celery | 1GB | 入库秒回，CPU 密集 |
| **vip** | Gevent | 30 协程 | learning | 1GB | 建模快车道 |
| **trans** | Gevent | 60 协程 | translation | 1.5GB | 翻译主力 |

**服务器 A 总并发**：4 + 30 + 60 = **94**

### 服务器 B Workers

| Worker | 并发模式 | 并发数 | PARALLEL_SIZE | 队列 | 内存 | 职责 |
|--------|----------|--------|---------------|------|------|------|
| **insight** | Gevent | 4 协程 | 40 | insight_extraction | 1.5GB | 洞察专攻 |
| **theme** | Gevent | 4 协程 | 50 | theme_extraction | 1.5GB | 主题专攻 |
| **trans-2** | Gevent | 40 协程 | - | translation | 1.5GB | 翻译分担 |
| **backup** | Gevent | 20 协程 | - | learning, insight, theme | 1.5GB | 全能备份 |

**服务器 B 总并发**：4 + 4 + 40 + 20 = **68**

---

## 🔢 并发能力计算

### API 并发分析

| 任务类型 | Worker 并发 | × PARALLEL_SIZE | = 最大 API 并发 |
|----------|-------------|-----------------|-----------------|
| 翻译 (A) | 60 | × 1 | 60 |
| 翻译 (B) | 40 | × 1 | 40 |
| 建模 (A) | 30 | × 1 | 30 |
| 洞察 (B) | 4 | × 40 | **160** |
| 主题 (B) | 4 | × 50 | **200** |
| 备份 (B) | 20 | × 1 | 20 |

**理论最大 API 并发**：60 + 40 + 30 + 160 + 200 + 20 = **510**

### 实际限流保护

```python
# 全局 API 限流器确保安全
MAX_RPS = 200  # 留 20% 安全余量

# 15,000 RPM ÷ 60 秒 = 250 RPS
# 250 × 0.8 = 200 RPS (安全上限)
```

**关键**：即使配置了 510 个"槽位"，全局限流器会确保实际 RPS ≤ 200

---

## 💾 内存分配

### 服务器 A (16GB)

| 组件 | 内存 |
|------|------|
| PostgreSQL | 5GB |
| Redis | 2GB |
| Backend + Frontend + Nginx | 1.5GB |
| Flower | 0.5GB |
| worker-base | 1GB |
| worker-vip | 1GB |
| worker-trans | 1.5GB |
| 系统预留 | 3.5GB |
| **总计** | **16GB** |

### 服务器 B (8GB)

| 组件 | 内存 |
|------|------|
| worker-insight | 1.5GB |
| worker-theme | 1.5GB |
| worker-trans-2 | 1.5GB |
| worker-backup | 1.5GB |
| 系统预留 | 2GB |
| **总计** | **8GB** |

---

## 🚀 性能预期

### 处理速度对比

| 场景 | 单机 (4核16G) | 双机 (8+4核, 24G) | 提升 |
|------|---------------|-------------------|------|
| 翻译并发 | 100 | 100 | 持平 |
| 洞察并发 | 100 × 20 = 2000 理论 | 4 × 40 = 160 实际 | 更稳定 |
| 主题并发 | 100 × 30 = 3000 理论 | 4 × 50 = 200 实际 | 更稳定 |
| 多用户支持 | 10 产品同时 | 20+ 产品同时 | **2x** |

### 关键优势

1. **物理隔离**：翻译和分析在不同服务器，互不干扰
2. **更稳定**：降低 Worker 并发，提高 PARALLEL_SIZE，减少任务调度开销
3. **可扩展**：可以再加服务器 C、D...
4. **高可用**：A 故障时，B 可以继续处理分析任务

---

## 🔧 部署步骤

### 1. 准备工作

```bash
# 服务器 A
mkdir -p /opt/voc-master
cd /opt/voc-master

# 服务器 B
mkdir -p /opt/voc-worker
cd /opt/voc-worker
```

### 2. 部署服务器 A

```bash
# 复制代码和配置
scp -r ./* root@server-a:/opt/voc-master/

# 启动服务
ssh root@server-a
cd /opt/voc-master
docker-compose -f docker-compose-master.yml up -d
```

### 3. 部署服务器 B

```bash
# 复制 Worker 相关代码
scp -r backend/* root@server-b:/opt/voc-worker/backend/

# 修改 Redis 和 DB 连接地址
# 编辑 docker-compose-worker.yml 中的环境变量

# 启动 Worker
ssh root@server-b
cd /opt/voc-worker
docker-compose -f docker-compose-worker.yml up -d
```

### 4. 验证

```bash
# 在服务器 A 上检查 Flower
curl http://localhost:5555/api/workers

# 应该看到所有 7 个 Worker：
# base@server-a, vip@server-a, trans@server-a
# insight@server-b, theme@server-b, trans-2@server-b, backup@server-b
```

---

## ⚠️ 注意事项

### 网络配置

1. **防火墙**：服务器 A 需要开放 6379 (Redis) 和 5432 (PostgreSQL) 端口给服务器 B
2. **延迟**：建议两台服务器在同一内网，延迟 < 1ms
3. **带宽**：消息量不大，100Mbps 足够

### 安全配置

```bash
# Redis 添加密码
redis-server --requirepass your_password

# PostgreSQL 允许远程连接
# postgresql.conf: listen_addresses = '*'
# pg_hba.conf: host all all 192.168.x.0/24 md5
```

### 监控建议

1. **Flower**：监控任务执行情况
2. **Prometheus + Grafana**：监控服务器资源
3. **告警**：API 错误率 > 5% 时告警

---

## 📈 扩展路径

### 如果需要更多算力

```
┌────────────────┐
│   服务器 C     │
│   4核8G        │──────┐
│ worker-insight │      │
│ worker-theme   │      │
└────────────────┘      │
                        │
┌────────────────┐      │     ┌────────────────┐
│   服务器 A     │      │     │     Redis      │
│   8核16G       │◄─────┼─────┤   (服务器 A)   │
│   主服务器     │      │     └────────────────┘
└────────────────┘      │
                        │
┌────────────────┐      │
│   服务器 B     │      │
│   4核8G        │──────┘
│ worker-insight │
│ worker-theme   │
└────────────────┘
```

**横向扩展原则**：
- 只需要添加 Worker 节点
- 所有 Worker 连接同一个 Redis
- 全局限流器自动协调 API 调用

---

## 📝 配置文件清单

| 文件 | 用途 | 部署位置 |
|------|------|----------|
| `docker-compose-master.yml` | 主服务器配置 | 服务器 A |
| `docker-compose-worker.yml` | Worker 节点配置 | 服务器 B |
| `.env` (服务器 A) | 主服务器环境变量 | 服务器 A |
| `.env` (服务器 B) | Worker 环境变量 | 服务器 B |

---

## 🔐 环境变量配置

### 服务器 A (.env)

```bash
# 数据库配置
POSTGRES_USER=vocmaster
POSTGRES_PASSWORD=your_secure_password
POSTGRES_DB=vocmaster

# AI API 配置
QWEN_API_KEY=your_qwen_api_key
QWEN_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1

# API 限流配置（qwen-plus-latest: 15000 RPM = 250 RPS）
MAX_API_RPS=200

# 并行度配置（主服务器不运行洞察/主题任务，仅作备用）
INSIGHT_PARALLEL_SIZE=40
THEME_PARALLEL_SIZE=50
```

### 服务器 B (.env)

```bash
# ⚠️ 重要：修改为服务器 A 的实际 IP 地址
MASTER_IP=192.168.1.100

# 数据库配置（连接服务器 A）
POSTGRES_USER=vocmaster
POSTGRES_PASSWORD=your_secure_password
POSTGRES_DB=vocmaster

# AI API 配置
QWEN_API_KEY=your_qwen_api_key
QWEN_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1

# API 限流配置（共享服务器 A 的 Redis 限流）
MAX_API_RPS=200

# 并行度配置（专用 Worker，高并发）
INSIGHT_PARALLEL_SIZE=40
THEME_PARALLEL_SIZE=50
```

---

## 🔄 可调参数说明

| 环境变量 | 默认值 | 说明 | 调整建议 |
|----------|--------|------|----------|
| `MAX_API_RPS` | 200 | 全局 API 请求限流 | qwen-plus: 200, qwen3-max: 8 |
| `INSIGHT_PARALLEL_SIZE` | 40 | 洞察任务内部并发 | 根据 API 响应时间调整 |
| `THEME_PARALLEL_SIZE` | 50 | 主题任务内部并发 | 主题 API 更快，可以更高 |

### 如果使用 qwen3-max 模型

```bash
# qwen3-max 只有 600 RPM = 10 RPS
MAX_API_RPS=8
INSIGHT_PARALLEL_SIZE=10
THEME_PARALLEL_SIZE=15
```

---

**文档版本**: v1.0  
**创建时间**: 2026-01-11  
**适用场景**: 多服务器分布式部署
