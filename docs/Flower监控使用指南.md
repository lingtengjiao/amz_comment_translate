# ğŸŒ¸ Flower ç›‘æ§ä½¿ç”¨æŒ‡å—

## ä¸€ã€è®¿é—®åœ°å€

```
http://localhost:5555
```

æˆ–è€…åœ¨æµè§ˆå™¨è¾“å…¥ï¼š`http://æœåŠ¡å™¨IP:5555`

---

## äºŒã€ä¸»è¦åŠŸèƒ½

### 1. Workers é¡µé¢ï¼ˆå·¥äººè§†å›¾ï¼‰

**æŸ¥çœ‹æ‰€æœ‰ Worker çš„å®æ—¶çŠ¶æ€ï¼š**

- âœ… **worker-base** (base@xxx)
  - é˜Ÿåˆ—ï¼š`ingestion`, `reports`, `celery`
  - å¹¶å‘ï¼š4 çº¿ç¨‹ï¼ˆPreforkï¼‰
  - èŒè´£ï¼šå…¥åº“ + æŠ¥å‘Šç”Ÿæˆ

- âœ… **worker-learning** (learning@xxx)
  - é˜Ÿåˆ—ï¼š`learning`, `translation`
  - å¹¶å‘ï¼š100 åç¨‹ï¼ˆGeventï¼‰
  - èŒè´£ï¼šVIP å¿«è½¦é“ï¼Œæ–°äº§å“å»ºæ¨¡

- âœ… **worker-heavy-1** (heavy1@xxx)
  - é˜Ÿåˆ—ï¼š`learning`, `translation`, `analysis`
  - å¹¶å‘ï¼š150 åç¨‹ï¼ˆGeventï¼‰
  - èŒè´£ï¼šAI ååä¸»åŠ›ï¼Œç¿»è¯‘+æ´å¯Ÿ+ä¸»é¢˜

- âœ… **worker-heavy-2** (heavy2@xxx)
  - é˜Ÿåˆ—ï¼š`learning`, `translation`, `analysis`
  - å¹¶å‘ï¼š150 åç¨‹ï¼ˆGeventï¼‰
  - èŒè´£ï¼šAI ååä¸»åŠ›ï¼Œç¿»è¯‘+æ´å¯Ÿ+ä¸»é¢˜

**å®æ—¶æŒ‡æ ‡ï¼š**
- **Active Tasks**: æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•°
- **Processed**: å·²å®Œæˆçš„ä»»åŠ¡æ€»æ•°
- **Load Average**: ç³»ç»Ÿè´Ÿè½½
- **Memory Usage**: å†…å­˜ä½¿ç”¨æƒ…å†µ

---

### 2. Tasks é¡µé¢ï¼ˆä»»åŠ¡è§†å›¾ï¼‰

**æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µï¼š**

- ä»»åŠ¡åç§°ï¼ˆå¦‚ `task_ingest_translation_only`ï¼‰
- æ‰§è¡ŒçŠ¶æ€ï¼ˆSuccess / Failure / Pendingï¼‰
- æ‰§è¡Œæ—¶é—´
- ä»»åŠ¡å‚æ•°
- é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰

**ä»»åŠ¡ç±»å‹ï¼š**
- ğŸ”µ **task_process_ingestion_queue** - å…¥åº“ä»»åŠ¡
- ğŸŸ¢ **task_ingest_translation_only** - æ‰¹é‡ç¿»è¯‘ï¼ˆ10æ¡ä¸€æ‰¹ï¼‰
- ğŸŸ¡ **task_extract_insights** - æ´å¯Ÿæå–
- ğŸŸ  **task_extract_themes** - ä¸»é¢˜æå–
- ğŸ”´ **task_full_auto_analysis** - å…¨è‡ªåŠ¨åˆ†æ
- ğŸŸ£ **task_scientific_learning_and_analysis** - å­¦ä¹ å»ºæ¨¡

---

### 3. Monitor é¡µé¢ï¼ˆç›‘æ§è§†å›¾ï¼‰

**å®æ—¶å›¾è¡¨ï¼š**
- ä»»åŠ¡æ‰§è¡Œé€Ÿç‡ï¼ˆTasks/ç§’ï¼‰
- ä»»åŠ¡æˆåŠŸ/å¤±è´¥æ¯”ä¾‹
- Worker è´Ÿè½½åˆ†å¸ƒ

---

### 4. Broker é¡µé¢ï¼ˆé˜Ÿåˆ—è§†å›¾ï¼‰

**æŸ¥çœ‹ Redis é˜Ÿåˆ—çŠ¶æ€ï¼š**
- é˜Ÿåˆ—åç§°
- å¾…å¤„ç†ä»»åŠ¡æ•°
- æ¶ˆè´¹é€Ÿç‡

**5 ä¸ªé˜Ÿåˆ—ï¼š**
1. `ingestion` - å…¥åº“é˜Ÿåˆ—
2. `reports` - æŠ¥å‘Šé˜Ÿåˆ—
3. `learning` - å­¦ä¹ å»ºæ¨¡é˜Ÿåˆ—ï¼ˆVIP å¿«è½¦é“ï¼‰
4. `translation` - ç¿»è¯‘é˜Ÿåˆ—
5. `analysis` - åˆ†æé˜Ÿåˆ—ï¼ˆæ´å¯Ÿ+ä¸»é¢˜ï¼‰

---

## ä¸‰ã€å¦‚ä½•ä½¿ç”¨ Flower ç›‘æ§æ‰¹é‡ç¿»è¯‘æ•ˆæœ

### 1. æŸ¥çœ‹ç¿»è¯‘ä»»åŠ¡æ‰§è¡Œæƒ…å†µ

**æ­¥éª¤ï¼š**
1. æ‰“å¼€ `http://localhost:5555/tasks`
2. æœç´¢ `task_ingest_translation_only`
3. æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¶é—´å’ŒçŠ¶æ€

**ä¼˜åŒ–å‰ vs ä¼˜åŒ–åï¼š**

| æŒ‡æ ‡ | å•æ¡æ¨¡å¼ï¼ˆä¼˜åŒ–å‰ï¼‰ | æ‰¹é‡æ¨¡å¼ï¼ˆä¼˜åŒ–åï¼‰ |
|------|-------------------|-------------------|
| 100 æ¡è¯„è®ºç¿»è¯‘æ—¶é—´ | ~5 åˆ†é’Ÿ | ~1 åˆ†é’Ÿ |
| API è°ƒç”¨æ¬¡æ•° | 100 æ¬¡ | 10 æ¬¡ |
| ä»»åŠ¡æˆåŠŸç‡ | å®¹æ˜“è¶…æ—¶ | ç¨³å®š |

### 2. ç›‘æ§ Worker è´Ÿè½½

**æ­¥éª¤ï¼š**
1. æ‰“å¼€ `http://localhost:5555/workers`
2. æŸ¥çœ‹æ¯ä¸ª Worker çš„ **Active Tasks**

**ç†æƒ³çŠ¶æ€ï¼š**
- `worker-base`: 0-2 ä¸ªä»»åŠ¡ï¼ˆå…¥åº“å¾ˆå¿«ï¼‰
- `worker-learning`: 0-10 ä¸ªä»»åŠ¡ï¼ˆå»ºæ¨¡ä»»åŠ¡å°‘ï¼‰
- `worker-heavy-1/2`: 10-50 ä¸ªä»»åŠ¡ï¼ˆé«˜å¹¶å‘ç¿»è¯‘/åˆ†æï¼‰

### 3. æ£€æŸ¥é˜Ÿåˆ—ç§¯å‹

**æ­¥éª¤ï¼š**
1. æ‰“å¼€ `http://localhost:5555/broker`
2. æŸ¥çœ‹å„é˜Ÿåˆ—çš„ **Messages**

**å¼‚å¸¸æƒ…å†µï¼š**
- `translation` é˜Ÿåˆ—ç§¯å‹ > 100ï¼šè¯´æ˜ç¿»è¯‘ä»»åŠ¡æ¥ä¸åŠå¤„ç†
- `analysis` é˜Ÿåˆ—ç§¯å‹ > 50ï¼šè¯´æ˜æ´å¯Ÿ/ä¸»é¢˜æå–è¾ƒæ…¢

---

## å››ã€å¸¸è§é—®é¢˜æ’æŸ¥

### 1. Worker ç¦»çº¿

**ç—‡çŠ¶ï¼š** Workers é¡µé¢æ˜¾ç¤ºæŸä¸ª Worker ç¦»çº¿

**æ’æŸ¥ï¼š**
```bash
# æŸ¥çœ‹ Worker å®¹å™¨çŠ¶æ€
docker ps | grep worker

# é‡å¯ç¦»çº¿çš„ Worker
docker-compose restart worker-heavy-1
```

### 2. ä»»åŠ¡å¤±è´¥ç‡é«˜

**ç—‡çŠ¶ï¼š** Tasks é¡µé¢æ˜¾ç¤ºå¤§é‡ Failure

**æ’æŸ¥ï¼š**
```bash
# æŸ¥çœ‹ Worker æ—¥å¿—
docker logs voc-worker-heavy-1 --tail 100

# æ£€æŸ¥ Qwen API é™æµ
redis-cli -h localhost GET api_limit:qwen:1
```

### 3. é˜Ÿåˆ—ç§¯å‹ä¸¥é‡

**ç—‡çŠ¶ï¼š** Broker é¡µé¢æ˜¾ç¤ºé˜Ÿåˆ—æ¶ˆæ¯æ•° > 1000

**æ’æŸ¥ï¼š**
1. æ£€æŸ¥æ˜¯å¦æœ‰ Worker å´©æºƒ
2. æ£€æŸ¥ API QPS æ˜¯å¦è§¦é¡¶ï¼ˆ25 QPSï¼‰
3. è€ƒè™‘å¢åŠ  Worker å¹¶å‘æ•°

---

## äº”ã€æ€§èƒ½è°ƒä¼˜å»ºè®®

### 1. æ ¹æ® Flower æ•°æ®è°ƒæ•´å¹¶å‘

**å¦‚æœç¿»è¯‘é˜Ÿåˆ—ç§¯å‹ä¸¥é‡ï¼š**
```yaml
# docker-compose.yml
worker-heavy-1:
  command: celery -A app.worker worker --pool=gevent --concurrency=200 -Q learning,translation,analysis
```

### 2. æ ¹æ®ä»»åŠ¡æˆåŠŸç‡è°ƒæ•´é‡è¯•

**å¦‚æœä»»åŠ¡å¤±è´¥ç‡ > 10%ï¼š**
```python
# worker.py
@celery_app.task(bind=True, max_retries=5, default_retry_delay=60)
def task_ingest_translation_only(self, product_id: str):
    ...
```

### 3. æ ¹æ®æ‰§è¡Œæ—¶é—´ä¼˜åŒ–æ‰¹é‡å¤§å°

**å¦‚æœæ‰¹é‡ç¿»è¯‘è¶…æ—¶ï¼š**
```python
# worker.py
BATCH_SIZE = 5  # ä» 10 æ¡é™åˆ° 5 æ¡
```

---

## å…­ã€å¯åŠ¨/åœæ­¢ Flower

### å¯åŠ¨
```bash
docker start voc-flower
```

### åœæ­¢
```bash
docker stop voc-flower
```

### é‡å¯
```bash
docker restart voc-flower
```

### æŸ¥çœ‹æ—¥å¿—
```bash
docker logs -f voc-flower
```

---

## ä¸ƒã€é«˜çº§åŠŸèƒ½

### 1. API è®¿é—®

Flower æä¾› REST APIï¼Œå¯ä»¥ç¼–ç¨‹æ–¹å¼è·å–æ•°æ®ï¼š

```bash
# è·å–æ‰€æœ‰ Worker çŠ¶æ€
curl http://localhost:5555/api/workers

# è·å–ä»»åŠ¡åˆ—è¡¨
curl http://localhost:5555/api/tasks

# è·å–é˜Ÿåˆ—çŠ¶æ€
curl http://localhost:5555/api/queues/lengths
```

### 2. ä»»åŠ¡æ§åˆ¶

åœ¨ Flower ç•Œé¢å¯ä»¥ï¼š
- ğŸ”„ é‡è¯•å¤±è´¥çš„ä»»åŠ¡
- â¸ï¸ æš‚åœ Worker
- ğŸ”¥ å…³é—­ Worker
- ğŸ“Š æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œå†å²

---

## å…«ã€æ‰¹é‡ç¿»è¯‘ç›‘æ§å®æˆ˜

### åœºæ™¯ï¼šé‡‡é›†ä¸€ä¸ªæ–°äº§å“ï¼ˆ100 æ¡è¯„è®ºï¼‰

**å®æ—¶ç›‘æ§æµç¨‹ï¼š**

1. **T+0s**: é‡‡é›†å¼€å§‹
   - æŸ¥çœ‹ `ingestion` é˜Ÿåˆ—ï¼š100 æ¡å¾…å…¥åº“
   
2. **T+10s**: å…¥åº“å®Œæˆï¼Œç¿»è¯‘å¼€å§‹
   - æŸ¥çœ‹ `translation` é˜Ÿåˆ—ï¼š100 æ¡å¾…ç¿»è¯‘
   - æŸ¥çœ‹ `worker-learning` å’Œ `worker-heavy-1/2` çš„ Active Tasks
   
3. **T+1min**: æ‰¹é‡ç¿»è¯‘å®Œæˆï¼ˆ10 æ¬¡ API è°ƒç”¨ï¼‰
   - æŸ¥çœ‹ Tasks é¡µé¢ï¼š10 ä¸ª `task_ingest_translation_only` å…¨éƒ¨ Success
   - æŸ¥çœ‹ç¿»è¯‘ä»»åŠ¡å¹³å‡è€—æ—¶ï¼š~6 ç§’/æ‰¹ï¼ˆ10æ¡ï¼‰
   
4. **T+2min**: æ´å¯Ÿå’Œä¸»é¢˜æå–å®Œæˆ
   - æŸ¥çœ‹ `analysis` é˜Ÿåˆ—ï¼šæ¸…ç©º
   
5. **T+3min**: æŠ¥å‘Šç”Ÿæˆå®Œæˆ
   - æŸ¥çœ‹ `reports` é˜Ÿåˆ—ï¼šæ¸…ç©º

**å¯¹æ¯”å•æ¡ç¿»è¯‘æ¨¡å¼ï¼š**
- åŸæ¥éœ€è¦ 5 åˆ†é’Ÿï¼Œç°åœ¨åªéœ€ 1 åˆ†é’Ÿ
- API è°ƒç”¨ä» 100 æ¬¡é™åˆ° 10 æ¬¡
- QPS æ¶ˆè€—ä» 100 é™åˆ° 10

---

ğŸ‰ ç°åœ¨ä½ å¯ä»¥é€šè¿‡ Flower å®æ—¶ç›‘æ§æ•´ä¸ªç¿»è¯‘æµæ°´çº¿äº†ï¼
