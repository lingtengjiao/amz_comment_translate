# 数据透视与数据总览业务逻辑梳理

## 一、概述

本文档梳理 `product_pivot_insights` 和 `product_dimension_summaries` 两个表的业务逻辑，明确它们各自的职责、使用场景，以及是否存在重叠部分。

---

## 二、表结构对比

### 2.1 `product_pivot_insights` 表

**用途**：存储**数据透视板块**的AI解读数据

**表结构**：
```sql
CREATE TABLE product_pivot_insights (
    id UUID PRIMARY KEY,
    product_id UUID NOT NULL,
    
    -- 洞察类型：audience/demand/product/scenario/brand/dimension_summary
    insight_type VARCHAR(50) NOT NULL,
    
    -- 子类型：decision_flow, strength_mapping, critical_weakness 等
    sub_type VARCHAR(100),
    
    -- 维度名称（用于dimension_summary类型）
    dimension VARCHAR(100),
    
    -- 总结类型（用于dimension_summary类型，兼容原表）
    summary_type VARCHAR(50),
    
    -- AI生成的洞察内容（JSON格式）
    -- 结构：{ keyFindings: [], dataSupport: [], recommendations: [], severity: 'normal'|'warning'|'critical' }
    insight_data JSONB NOT NULL DEFAULT '{}',
    
    -- 原始数据（用于重新生成）
    raw_data JSONB DEFAULT '{}',
    
    -- 置信度分数 (0-1)
    confidence DECIMAL(3,2),
    
    -- 生成状态
    generation_status VARCHAR(20) DEFAULT 'pending',
    
    -- 错误信息
    error_message TEXT,
    
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    
    -- 唯一约束
    UNIQUE (product_id, insight_type, sub_type, dimension, summary_type)
);
```

**关键字段说明**：
- `insight_type`: 5大洞察模块类型（audience/demand/product/scenario/brand）
- `sub_type`: 具体子模块标识（如 `decision_flow`, `strength_mapping`, `critical_weakness` 等）
- `insight_data`: AI生成的解读内容，包含 `keyFindings`, `dataSupport`, `recommendations`, `severity`
- `raw_data`: 用于生成洞察的原始数据（矩阵数据、统计信息等）

---

### 2.2 `product_dimension_summaries` 表

**用途**：存储**数据总览板块**的AI总结数据

**表结构**：
```sql
CREATE TABLE product_dimension_summaries (
    id UUID PRIMARY KEY,
    product_id UUID NOT NULL,
    
    -- 总结类型
    -- theme_buyer, theme_user, theme_where, theme_when, theme_why, theme_what (5W主题总结)
    -- dimension (产品维度总结)
    -- emotion (情感维度总结)
    -- scenario (场景维度总结)
    -- consumer_persona (消费者原型)
    -- overall (整体数据总结)
    summary_type VARCHAR(50) NOT NULL,
    
    -- 具体分类名称（如：质感体验、清洁收纳、失望不满 等）
    category VARCHAR(200),
    
    -- AI生成内容
    title VARCHAR(500),                    -- 标题/名称
    summary TEXT,                          -- 总结内容
    key_points JSONB DEFAULT '[]'::jsonb,  -- 核心要点列表 [{"point": "...", "evidence_count": 10}]
    evidence_count INTEGER DEFAULT 0,      -- 支撑证据数量
    sentiment_tendency VARCHAR(20),        -- positive/negative/neutral/mixed
    
    -- 消费者原型专用字段
    persona_data JSONB,                    -- {"buyer": "宝妈", "user": "学龄前儿童", "why": "感官发育", ...}
    
    -- 元数据
    ai_model VARCHAR(50) DEFAULT 'qwen-max',
    confidence FLOAT DEFAULT 0.8,
    raw_response JSONB,                    -- AI原始响应（用于调试）
    
    created_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ,
    
    -- 唯一约束
    UNIQUE (product_id, summary_type, category)
);
```

**关键字段说明**：
- `summary_type`: 总结类型（5W主题、维度、情感、场景、消费者原型、整体总结）
- `category`: 具体分类（维度名、情感类型名等）
- `summary`: AI生成的总结文本
- `key_points`: 核心要点列表（带证据数量）
- `persona_data`: 消费者原型专用，存储5W组合数据

---

## 三、使用场景对比

### 3.1 `product_pivot_insights` - 数据透视板块

**前端组件**：`PivotInsightReport.tsx` → `PivotView.tsx`

**使用位置**：评论分享页的 **"数据透视"** Tab

**数据流向**：
```
后端 API: /api/v1/share/{token}/pivot-insights
    ↓
前端: PivotInsightReport.tsx
    ↓
5大洞察模块:
  - AudienceInsight (人群洞察)
  - DemandInsight (需求洞察)
  - ProductInsight (产品洞察)
  - ScenarioInsight (场景洞察)
  - BrandInsight (品牌洞察)
```

**数据内容**：
- **25个子模块的AI解读**（对应18种2D组合 + 5种3D组合 + 2个概览模块）
- 每个子模块对应一个 `insight_type` + `sub_type` 组合
- 例如：
  - `insight_type='audience'`, `sub_type='decision_flow'` → 1.1 决策链路分析
  - `insight_type='demand'`, `sub_type='rnd_priority'` → 2.4 研发优先级
  - `insight_type='product'`, `sub_type='critical_weakness'` → 3.1 致命缺陷识别

**数据格式**：
```typescript
{
  insight_type: 'audience',
  sub_type: 'decision_flow',
  insight_data: {
    keyFindings: ['购买者与使用者存在明显错位...'],
    dataSupport: [
      { metric: '购买者-使用者配对数', value: '15组' }
    ],
    recommendations: ['优化广告投放策略...'],
    severity: 'info'
  }
}
```

---

### 3.2 `product_dimension_summaries` - 数据总览板块

**前端组件**：`SharedReviewReader.tsx` → Overview Tab

**使用位置**：评论分享页的 **"数据总览"** Tab

**数据流向**：
```
后端 API: /api/v1/share/{token}
    ↓
前端: SharedReviewReader.tsx
    ↓
数据总览模块:
  - 5W主题总结 (theme_buyer/user/where/when/why/what)
  - 产品维度总结 (dimension)
  - 情感维度总结 (emotion)
  - 场景维度总结 (scenario)
  - 消费者原型 (consumer_persona)
  - 整体数据总结 (overall)
```

**数据内容**：
- **5W主题总结**：每个5W主题（buyer/user/where/when/why/what）的AI总结
- **维度总结**：每个产品维度（如"电池续航"、"外观设计"）的AI总结
- **情感总结**：每个情感类型（如"惊喜好评"、"失望不满"）的AI总结
- **场景总结**：每个场景类型（如"家居日常"、"办公场景"）的AI总结
- **消费者原型**：综合5W数据的用户画像总结
- **整体总结**：产品整体数据概览

**数据格式**：
```typescript
{
  summary_type: 'dimension',
  category: '电池续航',
  title: '电池续航维度分析',
  summary: '用户普遍反馈电池续航时间较短...',
  key_points: [
    { point: '续航时间平均2-3天', evidence_count: 45 },
    { point: '充电速度较慢', evidence_count: 32 }
  ],
  sentiment_tendency: 'negative',
  evidence_count: 77
}
```

---

## 四、业务逻辑区分

### 4.1 核心区别

| 维度 | `product_pivot_insights` | `product_dimension_summaries` |
|------|-------------------------|------------------------------|
| **业务定位** | 数据透视的AI解读 | 数据总览的AI总结 |
| **分析粒度** | **交叉分析**（2D/3D组合） | **单维度总结**（5W主题、维度、情感、场景） |
| **分析视角** | **关系洞察**（购买者×使用者、动机×地点等） | **维度描述**（某个维度的特征、趋势） |
| **数据输入** | 预聚合矩阵（`pivot_matrices`） | 聚合统计数据（`aggregated_themes`, `aggregated_insights`） |
| **输出内容** | 交叉关系的洞察（决策错位、刚需场景等） | 单维度的总结（购买者画像、维度特征等） |
| **前端展示** | 数据透视Tab（25个子模块） | 数据总览Tab（6大总结模块） |

### 4.2 数据来源对比

**`product_pivot_insights` 的数据来源**：
- 预聚合矩阵（`pivot_matrices`）：
  - `buyer_user_motivation` (3D)
  - `motivation_weakness_suggestion` (3D)
  - `location_time_scenario` (3D)
  - `emotion_dimension_location` (3D)
  - `strength_scenario_emotion` (3D)
  - `motivation_location` (2D)
  - `location_suggestion` (2D)
- 交叉统计关系（如购买者×使用者配对、动机×地点热力图）

**`product_dimension_summaries` 的数据来源**：
- 聚合统计数据：
  - `aggregated_themes.buyer/user/where/when/why/what` (5W主题统计)
  - `aggregated_insights.strengths/weaknesses/suggestions/scenarios/emotions` (洞察统计)
- 单维度统计（如某个维度的出现次数、情感倾向分布）

---

## 五、重叠部分分析

### 5.1 设计意图的重叠

从 `migrate_pivot_insights.sql` 迁移脚本可以看出，`product_pivot_insights` 表在设计时**考虑了兼容** `product_dimension_summaries`：

```sql
-- 从 product_dimension_summaries 迁移数据
INSERT INTO product_pivot_insights (
    product_id,
    insight_type,
    dimension,
    summary_type,
    insight_data,
    ...
)
SELECT 
    pds.product_id,
    'dimension_summary' as insight_type,  -- 统一标记为 dimension_summary
    pds.dimension,
    pds.summary_type,
    jsonb_build_object(
        'summary', pds.summary,
        'keyPoints', pds.key_points
    ) as insight_data,
    ...
FROM product_dimension_summaries pds
```

**设计意图**：将 `product_dimension_summaries` 的数据迁移到 `product_pivot_insights`，统一管理所有AI生成内容。

### 5.2 实际使用中的分离

**实际情况**：两个表**目前是分开使用的**，没有真正合并：

1. **数据生成服务分离**：
   - `PivotInsightService`: 生成数据透视洞察 → `product_pivot_insights`
   - `DimensionSummaryService`: 生成数据总览总结 → `product_dimension_summaries`

2. **前端使用分离**：
   - 数据透视Tab：只读取 `product_pivot_insights`
   - 数据总览Tab：只读取 `product_dimension_summaries`

3. **API端点分离**：
   - `/api/v1/share/{token}/pivot-insights` → 返回 `product_pivot_insights`
   - `/api/v1/share/{token}` → 返回 `product_dimension_summaries`（在 `dimension_summaries` 字段中）

### 5.3 潜在重叠场景

虽然两个表目前分离使用，但存在以下**潜在重叠**：

#### 场景1：维度总结的重叠
- `product_dimension_summaries` 有 `summary_type='dimension'`，总结某个产品维度
- `product_pivot_insights` 理论上也可以有 `insight_type='dimension_summary'`（虽然目前未使用）

**重叠点**：如果未来在数据透视中也需要展示单维度总结，可能会产生数据重复。

#### 场景2：消费者原型的重叠
- `product_dimension_summaries` 有 `summary_type='consumer_persona'`，存储消费者原型
- 数据透视的"人群洞察"模块也可能需要消费者画像信息

**重叠点**：消费者原型数据可能同时被两个板块使用。

#### 场景3：5W主题总结的重叠
- `product_dimension_summaries` 有 `summary_type='theme_buyer/user/where/when/why/what'`
- 数据透视的"人群洞察"和"场景洞察"模块也涉及5W主题

**重叠点**：5W主题的总结可能同时被两个板块引用。

---

## 六、业务逻辑建议

### 6.1 当前架构的合理性

**优点**：
1. **职责清晰**：数据透视专注于交叉关系洞察，数据总览专注于单维度总结
2. **数据分离**：避免数据冗余，每个表存储最适合的数据结构
3. **前端清晰**：前端组件职责明确，不会混淆

**缺点**：
1. **数据可能重复**：如果两个板块都需要同一类数据（如消费者原型），可能产生重复生成
2. **维护成本**：需要维护两套生成服务、两套数据表

### 6.2 优化建议

#### 方案1：保持现状（推荐）
**理由**：
- 两个表的数据结构和业务逻辑差异较大
- 数据透视需要的是交叉关系洞察，数据总览需要的是单维度总结
- 虽然存在潜在重叠，但实际使用中分离清晰

**注意事项**：
- 明确两个表的职责边界
- 避免在数据透视中重复生成单维度总结
- 如果数据总览的总结需要在数据透视中使用，可以考虑引用而非重复生成

#### 方案2：统一到 `product_pivot_insights`
**前提**：如果未来希望统一管理所有AI生成内容

**实施步骤**：
1. 将 `product_dimension_summaries` 的数据迁移到 `product_pivot_insights`
2. 使用 `insight_type='dimension_summary'` 标记数据总览类型的数据
3. 前端统一从 `product_pivot_insights` 读取数据
4. 废弃 `product_dimension_summaries` 表

**风险**：
- 需要大量前端和后端代码修改
- 数据迁移可能影响现有功能
- 表结构需要扩展以兼容两种数据格式

#### 方案3：明确引用关系
**前提**：保持两个表分离，但建立引用关系

**实施步骤**：
1. 在 `product_pivot_insights` 中增加 `references_summary_id` 字段，引用 `product_dimension_summaries`
2. 如果数据透视需要消费者原型，直接引用数据总览的 `consumer_persona` 记录
3. 避免重复生成相同内容

**优点**：
- 保持现有架构
- 减少数据重复
- 建立清晰的数据关系

---

## 七、数据生成流程

### 7.1 `product_pivot_insights` 生成流程

**触发时机**：
- 用户点击"生成数据透视洞察"按钮
- 后端API: `/api/v1/share/{token}/generate-pivot-insights`

**生成服务**：`PivotInsightService.generate_all_insights()`

**生成步骤**：
1. 获取产品所有评论
2. 计算预聚合矩阵（`pivot_matrices`）
3. 对每个子模块调用AI生成洞察：
   - 人群洞察（3个子模块）
   - 需求洞察（4个子模块）
   - 产品洞察（6个子模块）
   - 场景洞察（4个子模块）
   - 品牌洞察（3个子模块）
4. 保存到 `product_pivot_insights` 表

**生成内容**：
- `insight_type`: 5大模块类型
- `sub_type`: 具体子模块标识
- `insight_data`: AI生成的解读（keyFindings, dataSupport, recommendations, severity）

---

### 7.2 `product_dimension_summaries` 生成流程

**触发时机**：
- 用户点击"生成AI分析"按钮（数据总览Tab）
- 后端API: `/api/v1/share/{token}/generate-summaries`

**生成服务**：`DimensionSummaryService.generate_all_summaries()`

**生成步骤**：
1. 获取产品所有评论
2. 聚合统计数据：
   - 5W主题统计（`aggregated_themes`）
   - 洞察统计（`aggregated_insights`）
3. 对每个维度调用AI生成总结：
   - 5W主题总结（6个）
   - 产品维度总结（N个，根据实际维度数）
   - 情感维度总结（N个，根据实际情感类型数）
   - 场景维度总结（N个，根据实际场景类型数）
   - 消费者原型（1个）
   - 整体数据总结（1个）
4. 保存到 `product_dimension_summaries` 表

**生成内容**：
- `summary_type`: 总结类型（theme_*, dimension, emotion, scenario, consumer_persona, overall）
- `category`: 具体分类名称
- `summary`: AI生成的总结文本
- `key_points`: 核心要点列表

---

## 八、前端使用映射

### 8.1 数据透视Tab使用 `product_pivot_insights`

**组件路径**：
```
SharedReviewReader.tsx (activeTab === 'pivot')
  ↓
PivotInsightReport.tsx
  ↓
5大洞察模块组件:
  - AudienceInsight.tsx
  - DemandInsight.tsx
  - ProductInsight.tsx
  - ScenarioInsight.tsx
  - BrandInsight.tsx
```

**数据获取**：
```typescript
// API调用
const response = await fetch(`/api/v1/share/${token}/pivot-insights`);
const { insights } = await response.json();

// 数据结构
{
  audience: [...],  // insight_type='audience' 的记录
  demand: [...],    // insight_type='demand' 的记录
  product: [...],  // insight_type='product' 的记录
  scenario: [...], // insight_type='scenario' 的记录
  brand: [...]     // insight_type='brand' 的记录
}
```

**使用示例**：
```typescript
// AudienceInsight.tsx
const aiDecision = aiInsights?.find(
  (insight: any) => insight.insight_type === 'decision_flow'
);
// 使用 aiDecision.interpretation 显示AI解读
```

---

### 8.2 数据总览Tab使用 `product_dimension_summaries`

**组件路径**：
```
SharedReviewReader.tsx (activeTab === 'overview')
  ↓
Overview Tab 内容渲染
```

**数据获取**：
```typescript
// 从主API返回
const { dimension_summaries } = data;

// 数据结构
[
  { summary_type: 'theme_buyer', category: null, summary: '...', ... },
  { summary_type: 'dimension', category: '电池续航', summary: '...', ... },
  { summary_type: 'consumer_persona', category: null, persona_data: {...}, ... },
  { summary_type: 'overall', category: null, summary: '...', ... },
  ...
]
```

**使用示例**：
```typescript
// SharedReviewReader.tsx
const personas = (data.dimension_summaries || []).filter(
  (s: any) => s.summary_type === 'consumer_persona'
);
const overallSummary = (data.dimension_summaries || []).find(
  (s: any) => s.summary_type === 'overall'
);
```

---

## 九、总结

### 9.1 核心结论

1. **两个表职责清晰**：
   - `product_pivot_insights`: 数据透视的交叉关系洞察
   - `product_dimension_summaries`: 数据总览的单维度总结

2. **存在潜在重叠**：
   - 消费者原型可能被两个板块使用
   - 5W主题总结可能被两个板块引用
   - 但实际使用中分离清晰，未产生明显冲突

3. **建议保持现状**：
   - 两个表的数据结构和业务逻辑差异较大
   - 统一管理可能增加复杂度
   - 当前架构清晰，维护成本可控

### 9.2 注意事项

1. **避免重复生成**：
   - 如果数据透视需要消费者原型，考虑引用数据总览的记录，而非重新生成

2. **明确职责边界**：
   - 数据透视：专注于交叉关系洞察（2D/3D组合）
   - 数据总览：专注于单维度总结（5W主题、维度、情感、场景）

3. **数据一致性**：
   - 确保两个表的数据来源一致（都基于同一批评论数据）
   - 如果评论数据更新，两个表都需要重新生成

---

## 十、附录

### 10.1 相关文件清单

**后端文件**：
- `backend/app/models/product_pivot_insight.py` - 数据透视洞察模型
- `backend/app/models/product_dimension_summary.py` - 维度总结模型
- `backend/app/services/pivot_insight_service.py` - 数据透视洞察生成服务
- `backend/app/services/dimension_summary_service.py` - 维度总结生成服务
- `backend/app/api/share.py` - 分享API端点
- `db/migrate_pivot_insights.sql` - 数据透视洞察表迁移脚本
- `db/migrate_dimension_summaries.sql` - 维度总结表迁移脚本

**前端文件**：
- `frontend/src/app/components/share/review-reader/SharedReviewReader.tsx` - 分享页主组件
- `frontend/src/app/components/share/review-reader/pivot/PivotInsightReport.tsx` - 数据透视报告组件
- `frontend/src/app/components/share/review-reader/pivot/insights/modules/*.tsx` - 5大洞察模块组件

### 10.2 API端点清单

**数据透视相关**：
- `GET /api/v1/share/{token}/pivot-insights` - 获取数据透视洞察
- `POST /api/v1/share/{token}/generate-pivot-insights` - 生成数据透视洞察（如果存在）

**数据总览相关**：
- `GET /api/v1/share/{token}` - 获取分享数据（包含 `dimension_summaries`）
- `POST /api/v1/share/{token}/generate-summaries` - 生成维度总结
- `GET /api/v1/share/{token}/check-data-changes` - 检查数据变化（用于判断是否需要重新生成）

---

**文档版本**：v1.0  
**创建时间**：2026-01-25  
**最后更新**：2026-01-25
