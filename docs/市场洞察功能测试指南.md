# 市场洞察功能测试指南

## 一、后端API测试

### 1. 运行后端测试脚本

```bash
cd /Users/lingtengjiao/AI项目/amz_comment_translate
python scripts/test_market_insight_api.py
```

测试脚本会验证：
- ✅ 创建市场洞察项目
- ✅ 创建对比分析项目
- ✅ 产品数量验证（对比分析2-5个，市场洞察2-10个）
- ✅ 分析类型路由

### 2. 手动API测试（使用curl）

#### 测试创建市场洞察项目

```bash
curl -X POST "http://localhost:8000/api/analysis/projects?auto_run=false" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "减压玩具市场洞察分析",
    "description": "分析减压玩具细分市场的用户需求和趋势",
    "analysis_type": "market_insight",
    "products": [
      {"product_id": "产品UUID1", "role_label": "产品1"},
      {"product_id": "产品UUID2", "role_label": "产品2"},
      {"product_id": "产品UUID3", "role_label": "产品3"}
    ]
  }'
```

#### 测试创建对比分析项目

```bash
curl -X POST "http://localhost:8000/api/analysis/projects?auto_run=false" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "产品对比分析",
    "description": "对比两款产品的差异",
    "analysis_type": "comparison",
    "products": [
      {"product_id": "产品UUID1", "role_label": "target"},
      {"product_id": "产品UUID2", "role_label": "competitor"}
    ]
  }'
```

#### 验证响应格式

响应应包含：
```json
{
  "success": true,
  "message": "市场洞察项目已创建，分析任务已在后台启动",
  "project": {
    "id": "项目UUID",
    "title": "项目标题",
    "analysis_type": "market_insight",
    "status": "pending",
    "items": [...]
  }
}
```

## 二、前端功能测试

### 1. 测试分析类型选择

**测试步骤：**
1. 打开前端应用
2. 进入"AI 竞品对比"或"工作台"页面
3. 选择2-10个产品
4. 点击"开始分析"按钮
5. 在弹窗中：
   - ✅ 应该看到两个分析类型选项：**对比分析** 和 **市场洞察**
   - ✅ 选择"市场洞察"时，按钮文字应变为"开始市场洞察"
   - ✅ 选择"对比分析"时，按钮文字应变为"开始对比分析"
   - ✅ 占位符文本应根据选择的类型变化

**预期结果：**
- 分析类型选择器正常显示
- UI样式根据选择的类型变化（蓝色 vs 玫瑰色）
- 提交时正确传递 `analysis_type` 参数

### 2. 测试创建市场洞察项目

**测试步骤：**
1. 选择3-5个产品
2. 选择"市场洞察"分析类型
3. 输入项目名称（如："减压玩具市场洞察"）
4. 点击"开始市场洞察"

**预期结果：**
- ✅ 成功创建项目
- ✅ 显示成功提示："市场洞察已启动"
- ✅ 项目列表中显示新项目，带有"市场洞察"标签
- ✅ 项目卡片显示蓝色图标和"市场洞察"标签

### 3. 测试项目列表显示

**测试步骤：**
1. 查看"AI 竞品对比"页面
2. 查看项目列表

**预期结果：**
- ✅ 市场洞察项目显示蓝色图标（TrendingUp）
- ✅ 对比分析项目显示玫瑰色图标（BarChart3）
- ✅ 每个项目卡片显示对应的分析类型标签

### 4. 测试结果页面渲染

**测试步骤：**
1. 等待分析完成（或使用已完成的项目）
2. 点击进入结果页面

**预期结果：**
- ✅ 市场洞察结果页面显示：
  - 市场概览（产品数量、总评论数、市场成熟度等）
  - 市场共性需求和痛点
  - 市场用户画像
  - 市场机会挖掘
  - 市场趋势分析
  - 产品市场定位
- ✅ 页面标题显示"市场洞察"相关文字
- ✅ 页面头部显示蓝色主题

### 5. 测试产品数量限制

**测试步骤：**

**对比分析：**
1. 选择6个产品
2. 选择"对比分析"
3. 尝试创建项目

**预期结果：**
- ✅ 应该显示错误："对比分析最多支持 5 个产品"

**市场洞察：**
1. 选择11个产品
2. 选择"市场洞察"
3. 尝试创建项目

**预期结果：**
- ✅ 应该显示错误："市场洞察最多支持 10 个产品"

## 三、完整流程测试

### 测试场景：创建并查看市场洞察报告

1. **准备数据**
   - 确保数据库中有至少3个产品
   - 确保这些产品有评论数据（已翻译）

2. **创建项目**
   - 选择3个产品
   - 选择"市场洞察"类型
   - 创建项目

3. **等待分析**
   - 监控项目状态（pending → processing → completed）
   - 预计需要1-2分钟

4. **查看结果**
   - 进入结果页面
   - 验证所有模块正常显示：
     - 市场概览卡片
     - 共性需求和痛点
     - 用户画像
     - 市场机会
     - 市场趋势
     - 产品定位

## 四、常见问题排查

### 问题1：API返回400错误

**可能原因：**
- 产品ID格式不正确（应该是UUID）
- 产品数量超出限制
- 缺少必需字段

**解决方法：**
- 检查产品ID是否正确
- 检查产品数量是否符合限制
- 查看后端日志获取详细错误信息

### 问题2：前端显示"未知的报告格式"

**可能原因：**
- 结果数据结构不正确
- `analysis_type` 字段缺失

**解决方法：**
- 检查后端返回的 `result_content` 结构
- 确保包含 `analysis_type: "market_insight"` 字段

### 问题3：分析类型选择器不显示

**可能原因：**
- 前端代码未更新
- 组件导入错误

**解决方法：**
- 检查 `AnalysisModal.tsx` 是否正确更新
- 清除浏览器缓存
- 重新构建前端

### 问题4：市场洞察结果页面空白

**可能原因：**
- `MarketInsightRenderer` 组件未正确导入
- 数据格式不匹配

**解决方法：**
- 检查 `AnalysisResultPage.tsx` 中的导入
- 检查浏览器控制台是否有错误
- 验证后端返回的数据结构

## 五、性能测试

### 测试大量产品场景

1. **测试10个产品的市场洞察**
   - 选择10个产品
   - 创建市场洞察项目
   - 验证分析时间在合理范围内（<5分钟）

2. **测试并发创建**
   - 同时创建多个项目
   - 验证系统稳定性

## 六、数据验证

### 验证市场洞察结果数据完整性

检查返回的 `result_content` 应包含：

```json
{
  "analysis_type": "market_insight",
  "market_name": "项目标题",
  "product_count": 3,
  "total_reviews": 1000,
  "market_overview": {
    "summary": "...",
    "common_needs": {...},
    "common_pain_points": {...}
  },
  "market_persona": {...},
  "market_opportunities": {...},
  "market_trends": {...},
  "product_profiles": [...]
}
```

## 七、测试检查清单

- [ ] 后端API测试脚本全部通过
- [ ] 可以创建市场洞察项目
- [ ] 可以创建对比分析项目
- [ ] 产品数量限制正确
- [ ] 前端分析类型选择器正常
- [ ] 项目列表正确显示分析类型
- [ ] 市场洞察结果页面正常渲染
- [ ] 所有数据模块正常显示
- [ ] 错误提示正确显示
- [ ] 页面样式正确（颜色、图标）

## 八、下一步优化建议

1. **性能优化**
   - 大数据量场景下的聚合性能
   - AI调用Token使用优化

2. **用户体验**
   - 添加加载进度提示
   - 优化结果页面布局
   - 添加数据导出功能

3. **功能增强**
   - 支持市场洞察结果对比
   - 添加趋势图表可视化
   - 支持自定义分析维度
