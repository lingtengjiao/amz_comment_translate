# 🎯 智能分类批量翻译 - 使用说明

## 一、核心思想

**根据评论长度和质量，采用差异化翻译策略：**

- 🌟 **VIP 评论**（长评论/极端星级）→ 单独翻译，保证质量
- 📝 **标准评论**（中等长度）→ 5 条一批，平衡质量和效率
- 💬 **短评论**（简短表达）→ 20 条一批，最大化效率

---

## 二、分类标准

### 评论分类逻辑（ReviewClassifier）

```python
class ReviewClassifier:
    # 配置参数（可调整）
    VIP_LENGTH_THRESHOLD = 200        # VIP 评论最低字数
    VIP_EXTREME_RATING_LENGTH = 100   # 极端星级评论的字数阈值
    EXTREME_RATINGS = [1, 5]          # 极端星级（差评/好评）
    
    STANDARD_MIN_LENGTH = 50          # 标准评论最低字数
    STANDARD_MAX_LENGTH = 200         # 标准评论最高字数
    
    SHORT_MAX_LENGTH = 50             # 短评论最高字数
    
    # 批量大小
    BATCH_SIZE_VIP = 1       # VIP：单独翻译
    BATCH_SIZE_STANDARD = 5  # 标准：5 条一批
    BATCH_SIZE_SHORT = 20    # 短评：20 条一批
```

### 分类规则

| 分类 | 条件 | 批量大小 | 示例 |
|------|------|----------|------|
| **VIP 评论** | • 字数 > 200<br>• 或（星级 1/5 且字数 > 100） | 1 条/批 | "This product exceeded all my expectations. I've been using it for 3 months and here's my detailed review..." (300+ 字) |
| **标准评论** | • 50 < 字数 ≤ 200 | 5 条/批 | "Good quality for the price. Easy to install and works as expected. Would recommend." (80 字) |
| **短评论** | • 字数 ≤ 50 | 20 条/批 | "Love it!"<br>"Not worth the money"<br>"Great!" |

---

## 三、效率对比

### 假设场景：100 条评论

**评论分布：**
- 10% VIP（10条，>200字）
- 30% 标准（30条，50-200字）
- 60% 短评（60条，≤50字）

### 性能对比表

| 指标 | 单条模式 | 固定批量（10条） | **智能分类** | 提升 |
|------|---------|----------------|------------|------|
| **API 调用次数** | 100 次 | 10 次 | **19 次**<br>(10+6+3) | **5.3x** |
| **QPS 消耗** | 100 QPS | 10 QPS | **19 QPS** | **5.3x** |
| **翻译时间** | ~5 分钟 | ~1 分钟 | **~1.2 分钟** | **4x** |
| **VIP 评论质量** | ⭐⭐⭐ | ⭐⭐ | **⭐⭐⭐** | ✅ 质量保证 |
| **短评论效率** | 低 | 中 | **极高** | ✅ 20倍加速 |

### API 调用详解

```
VIP 评论：  10 条 ÷ 1 条/批 = 10 次 API
标准评论：  30 条 ÷ 5 条/批 = 6 次 API
短评论：    60 条 ÷ 20 条/批 = 3 次 API
-------------------------------------------
总计：19 次 API（vs 原来 100 次）
```

---

## 四、翻译质量策略

### 1. VIP 评论（单独翻译）

**特点：**
- 使用完整的 Few-Shot System Prompt
- `temperature=0.3`（更稳定）
- `max_tokens=2000`（允许更详细的翻译）
- 保留所有情感细节和产品信息

**示例：**

```
原文：
"I've been using this product for 3 months now and I must say it's been a game changer for my morning routine. The build quality is excellent, much better than my previous purchase from another brand. The only minor issue is that the instruction manual could be more detailed, but overall I'm extremely satisfied with this purchase and would definitely recommend it to anyone looking for a reliable product in this price range."

译文：
"我已经用这个产品 3 个月了，必须说它彻底改变了我的早晨习惯。做工质量非常好，比我之前买的其他品牌好太多。唯一的小问题是说明书可以再详细一点，但总体来说我对这次购买非常满意，肯定会推荐给任何在这个价位寻找可靠产品的人。"
```

### 2. 标准评论（5条一批）

**特点：**
- 使用批量翻译 Prompt
- `temperature=0.3`
- `max_tokens=4000`
- 平衡质量和效率

**示例：**

```
批量输入：
{
  "r1": "Good quality for the price. Works as expected.",
  "r2": "Easy to install. No complaints so far.",
  "r3": "Exactly what I needed. Fast shipping.",
  "r4": "Decent product but could be better.",
  "r5": "Happy with my purchase. Would buy again."
}

批量输出：
{
  "r1": "性价比不错。符合预期。",
  "r2": "安装简单。目前没什么可抱怨的。",
  "r3": "正是我需要的。发货快。",
  "r4": "产品还行，但还有改进空间。",
  "r5": "对这次购买很满意。会再买。"
}
```

### 3. 短评论（20条一批）

**特点：**
- 使用简化的批量 Prompt
- `temperature=0.2`（更一致）
- `max_tokens=2000`
- 强调简洁自然的表达

**示例：**

```
批量输入：
{
  "r1": "Love it!",
  "r2": "Great!",
  "r3": "Not worth the money",
  "r4": "Perfect",
  "r5": "Waste of money",
  ... (最多20条)
}

批量输出：
{
  "r1": "太爱了！",
  "r2": "很棒！",
  "r3": "不值这个价",
  "r4": "完美",
  "r5": "浪费钱",
  ...
}
```

---

## 五、实时监控

### 在 Flower 中查看执行情况

**访问：** `http://localhost:5555`

#### 1. Tasks 页面

搜索 `task_ingest_translation_only`，查看日志：

```log
[智能翻译] 📊 评论分类: VIP=8 | 标准=32 | 短评=60

[智能翻译] 🚀 处理 short 类评论: 60 条，批量大小=20
[智能翻译] short 批次翻译完成: 20/20 条
[智能翻译] short 批次翻译完成: 20/20 条
[智能翻译] short 批次翻译完成: 20/20 条

[智能翻译] 🚀 处理 standard 类评论: 32 条，批量大小=5
[智能翻译] standard 批次翻译完成: 5/5 条
[智能翻译] standard 批次翻译完成: 5/5 条
... (共6批)

[智能翻译] 🚀 处理 vip 类评论: 8 条，批量大小=1
[智能翻译] vip 批次翻译完成: 1/1 条
... (共8批)

[智能翻译] ✅ 完成: 总计 100 条成功, 0 条失败
  📊 VIP 评论: 8/8 条
  📊 标准评论: 32/32 条
  📊 短评论: 60/60 条
```

#### 2. Workers 页面

观察 Worker 负载：

```
worker-learning:  Active Tasks: 15
worker-heavy-1:   Active Tasks: 35
worker-heavy-2:   Active Tasks: 40
```

---

## 六、配置调优

### 调整分类阈值

编辑 `backend/app/worker.py`：

```python
class ReviewClassifier:
    # 场景1：更严格的 VIP 标准（提升短评论效率）
    VIP_LENGTH_THRESHOLD = 250        # 从 200 提高到 250
    VIP_EXTREME_RATING_LENGTH = 120   # 从 100 提高到 120
    
    # 场景2：更激进的批量处理
    BATCH_SIZE_SHORT = 30             # 从 20 提高到 30
    
    # 场景3：更保守的质量控制
    BATCH_SIZE_STANDARD = 3           # 从 5 降低到 3
```

### 重启 Workers

```bash
docker-compose restart worker-learning worker-heavy-1 worker-heavy-2
```

---

## 七、最佳实践

### 1. 根据产品类型调整

**简单产品（如配件、日用品）：**
```python
VIP_LENGTH_THRESHOLD = 250          # 提高阈值
BATCH_SIZE_SHORT = 30               # 更大批量
```
- 评论通常较短
- 短评论占比高
- 可以更激进地批量处理

**复杂产品（如电子产品、专业工具）：**
```python
VIP_LENGTH_THRESHOLD = 150          # 降低阈值
VIP_EXTREME_RATING_LENGTH = 80      # 降低阈值
BATCH_SIZE_STANDARD = 3             # 更小批量
```
- 评论通常较长且详细
- VIP 评论占比高
- 需要更高的翻译质量

### 2. 根据 API QPS 限制调整

**QPS 限制较低（如 10 QPS）：**
```python
BATCH_SIZE_SHORT = 30               # 更大批量
BATCH_SIZE_STANDARD = 7             # 更大批量
```
- 减少 API 调用次数
- 优先批量处理

**QPS 充足（如 50 QPS）：**
```python
BATCH_SIZE_SHORT = 10               # 更小批量
BATCH_SIZE_STANDARD = 3             # 更小批量
```
- 提升翻译质量
- 减少单次调用的复杂度

### 3. 根据翻译质量要求调整

**质量优先：**
```python
VIP_LENGTH_THRESHOLD = 100          # 更多评论进入 VIP
BATCH_SIZE_STANDARD = 3             # 更小批量
```

**效率优先：**
```python
VIP_LENGTH_THRESHOLD = 300          # 更少评论进入 VIP
BATCH_SIZE_SHORT = 50               # 更大批量
```

---

## 八、常见问题

### Q1: 为什么 VIP 评论要单独翻译？

**A:** 长评论包含丰富的产品细节、使用场景、问题描述，批量翻译容易：
- 丢失细节
- 情感表达不准确
- 上下文理解偏差

单独翻译可以保证翻译质量，确保重要信息不丢失。

### Q2: 短评论批量翻译会不会降低质量？

**A:** 不会，因为：
1. 短评论信息量少（如 "Love it!", "Great!"）
2. 翻译难度低，不需要复杂的上下文理解
3. 批量翻译反而能保持一致性

### Q3: 如何判断分类效果？

**A:** 查看 Flower 日志中的分类统计：

```
[智能翻译] 📊 评论分类: VIP=8 | 标准=32 | 短评=60
```

**理想比例：**
- VIP: 5-15%（太高说明阈值过低）
- 标准: 25-40%
- 短评: 50-70%（太低说明阈值过高）

### Q4: 翻译失败率高怎么办？

**检查：**
1. API QPS 是否超限
2. 批量大小是否过大（导致超时）
3. JSON 解析是否失败

**解决方案：**
```python
# 减小批量大小
BATCH_SIZE_SHORT = 10  # 从 20 降到 10
BATCH_SIZE_STANDARD = 3  # 从 5 降到 3
```

---

## 九、技术细节

### 批量翻译 Prompt

```python
BATCH_TRANSLATION_SYSTEM_PROMPT = """你是一位精通中美文化差异的资深亚马逊跨境电商翻译专家。

## 任务
将多条亚马逊英文评论批量翻译成中文。

## 翻译原则
1. **拒绝翻译腔**: 使用自然流畅的中文表达
2. **情感对齐**: 保持原文的语气和情绪
3. **电商风格**: 使用符合中国电商的文案风格

## 输入/输出格式
- 输入: JSON 字典，键为评论 ID，值为英文原文
- 输出: JSON 字典，键与输入一致，值为中文译文
- **严格要求**: 只返回 JSON，不要添加任何解释、Markdown 标记或其他文字

## 示例
输入: {"r1": "Total lemon. Don't waste your money.", "r2": "Game changer for my morning routine."}
输出: {"r1": "简直是个次品！别浪费钱了。", "r2": "彻底改变了我每天早上的习惯，真香！"}"""
```

### JSON 解析容错

```python
def _parse_batch_translation_result(self, result_text: str, input_dict: dict) -> dict:
    """
    解析批量翻译结果，带容错处理
    
    处理常见的 LLM 输出问题：
    1. 多余的 Markdown 代码块标记
    2. 前后有解释文字
    3. JSON 格式错误
    """
    # 1. 清理 Markdown
    if "```json" in result_text:
        match = re.search(r'```json\s*(.*?)\s*```', result_text, re.DOTALL)
        if match:
            result_text = match.group(1)
    
    # 2. 尝试解析
    try:
        result_dict = json.loads(result_text)
        return result_dict
    except:
        # 3. 使用 json_repair 修复
        import json_repair
        return json_repair.loads(result_text)
```

---

## 十、总结

### ✅ 优势

1. **质量保证**: VIP 评论单独翻译，不降低质量
2. **效率最大化**: 短评论 20 条一批，QPS 消耗降低 20 倍
3. **灵活平衡**: 标准评论 5 条一批，兼顾质量和效率
4. **自适应**: 根据评论实际分布动态调整
5. **可配置**: 阈值和批量大小可灵活调整

### 📊 效果

- API 调用减少 **5-10 倍**
- 翻译时间减少 **4-5 倍**
- 重要评论质量 **完全保证**
- 短评论处理效率 **提升 20 倍**

---

🎉 现在你可以采集新产品测试智能分类批量翻译效果了！
