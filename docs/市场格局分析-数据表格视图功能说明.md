# 市场格局分析 - 数据表格视图功能说明

## 功能概述

为市场格局分析详情页新增「数据表格视图」，提供专业的数据管理和编辑界面，支持月度销量数据和自定义标签管理。

---

## 核心设计理念

将原有的「画板视图」与新增的「表格视图」作为同一数据的两种展现形式：

- **表格视图** 📊：数据管理、编辑、标签管理（数据操作层）
- **画板视图** 🎨：数据可视化、透视分析（数据展示层）

---

## 一、数据模型升级

### 1. CollectionProduct 表新增字段

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `monthly_sales` | JSONB | 月度销量数据 | `{"2023-05": 300, "2023-06": 1200, ...}` |
| `custom_tags` | JSONB | 自定义标签数据 | `{"product_type": "TSA-Clear", "product_series": "常规款"}` |

### 2. KeywordCollection 表新增字段

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `custom_fields` | JSONB | 自定义字段定义 | `[{"id": "field_1", "name": "产品类型", "type": "select", "options": [...]}]` |

---

## 二、功能特性

### 1. 表格视图基础功能

- ✅ 全屏表格界面，清晰展示所有产品数据
- ✅ 支持搜索（ASIN、标题、品牌）
- ✅ 支持列排序（点击列头）
- ✅ 可编辑单元格（双击编辑）
- ✅ 实时统计（显示产品数、列数）

### 2. 固定列（基础产品信息）

| 列名 | 说明 | 可编辑 |
|------|------|--------|
| 序号 | 行号 | ❌ |
| 图片 | 产品缩略图 | ❌ |
| ASIN | 产品标识（带链接） | ❌ |
| 标题 | 产品标题 | ❌ |
| 价格 | 产品价格 | ❌ |
| 评分 | 用户评分 | ❌ |
| 评论数 | 评论总数 | ❌ |
| 销量 | 月销量 | ✅ |
| 年份 | 上架年份 | ✅ |
| 品牌 | 产品品牌 | ✅ |
| 大类BSR | 大类排名 | ❌ |
| 小类BSR | 小类排名 | ❌ |

### 3. 月度销量列（动态）

- 📅 根据上传的数据自动生成月份列
- ✅ 支持编辑每个月的销量数据
- 🎨 蓝色背景标识，便于区分
- 📊 可用于趋势分析和对比

**数据格式示例**：

```json
{
  "2023-05": 300,
  "2023-06": 1200,
  "2023-07": 1800,
  "2023-08": 2100
}
```

### 4. 自定义标签列（用户创建）

- ➕ 用户可以动态添加自定义列
- 🏷️ 支持三种列类型：
  - **文本**：自由输入文本
  - **数字**：输入数字
  - **下拉选择**：从预定义选项中选择
- 🗑️ 可删除不需要的列
- 🎨 紫色背景标识，便于区分

**字段定义示例**：

```json
[
  {
    "id": "field_1",
    "name": "产品类型",
    "type": "select",
    "options": ["TSA-Clear", "TSA-Lock", "其他"]
  },
  {
    "id": "field_2",
    "name": "产品系列",
    "type": "select",
    "options": ["TSA-Clear-常规款", "TSA-Clear-手提带", "TSA-Clear-加固边框"]
  },
  {
    "id": "field_3",
    "name": "备注",
    "type": "text"
  }
]
```

---

## 三、使用流程

### 1. 打开表格视图

在市场格局分析详情页，点击工具栏的「数据表格」按钮（蓝色按钮）。

### 2. 添加自定义列

1. 点击右上角的「添加列」按钮
2. 输入列名称（例如：产品类型）
3. 选择列类型（文本/数字/下拉选择）
4. 如果是下拉选择，输入选项（用逗号分隔）
5. 点击「添加」

### 3. 编辑数据

- **单元格编辑**：双击可编辑的单元格，输入数据，按 Enter 或点击其他地方保存
- **下拉选择**：直接点击下拉框选择选项

### 4. 保存更改

- 编辑后，右上角会显示待保存的更改数量
- 点击「保存更改」按钮批量保存所有修改
- 系统会自动同步到数据库

### 5. 搜索和排序

- **搜索**：在搜索框输入关键词，支持搜索 ASIN、标题、品牌
- **排序**：点击列头进行升序/降序排序

---

## 四、数据导入升级

### 支持的数据格式

现有的「补充数据」功能已扩展，支持导入：

1. **月度销量数据**：
   - 列名格式：`2023-05`, `2023-06`, `2023-07`, ...
   - 或：`求和项:2023-05`, `求和项:2023-06`, ...

2. **自定义标签数据**：
   - 列名：与自定义字段名称一致
   - 例如：`产品类型`, `产品系列`, `备注`

### Excel/CSV 导入示例

| ASIN | 品牌 | 上架时间 | 月销量 | 2023-05 | 2023-06 | 2023-07 | 产品类型 | 产品系列 |
|------|------|----------|--------|---------|---------|---------|----------|----------|
| B07KC1PTPF | TSA-Clear | 2024 | 1308 | 300 | 1200 | 1800 | TSA-Clear | 常规款 |
| B07JM2F2AR | TSA-Clear | 2023 | 1692 | 2000 | 2000 | 1000 | TSA-Clear | 手提带 |

---

## 五、技术实现

### 后端 API

#### 新增端点

1. **管理自定义字段定义**
   ```
   PUT /api/v1/keyword-collections/{id}/custom-fields
   ```

2. **更新产品标签**
   ```
   PUT /api/v1/keyword-collections/{id}/products/{product_id}/tags
   ```

3. **更新月度销量**
   ```
   PUT /api/v1/keyword-collections/{id}/products/{product_id}/monthly-sales
   ```

4. **批量更新标签**
   ```
   POST /api/v1/keyword-collections/{id}/products/batch-update-tags
   ```

### 前端组件

- **ProductDataTable.tsx**：主表格组件
- **AddColumnModal**：添加自定义列弹窗
- **EditableCell**：可编辑单元格组件

### 数据存储

- 使用 PostgreSQL JSONB 类型
- 创建 GIN 索引支持高效查询
- 支持灵活的数据结构

---

## 六、未来扩展方向

### 1. 自定义标签透视（待实现）

- 自定义标签可以作为新的透视维度
- 例如按「产品类型」分组显示画板
- 类似现有的年份、品牌、排名透视

### 2. 数据导出

- 导出为 Excel/CSV
- 包含所有自定义列和月度销量

### 3. 批量操作

- 支持从 Excel 复制粘贴多行数据
- 批量填充某列的值

### 4. 数据验证

- 字段类型验证
- 必填字段检查
- 数据范围限制

---

## 七、使用场景

### 场景 1：月度销量趋势分析

1. 上传包含月度销量的 Excel 文件
2. 在表格视图中查看各产品的月度销量变化
3. 排序找出销量增长最快的产品
4. 结合画板视图进行可视化分析

### 场景 2：产品分类管理

1. 创建「产品类型」自定义列（下拉选择）
2. 为每个产品选择类型（TSA-Clear、TSA-Lock 等）
3. 创建「产品系列」自定义列
4. 细分产品系列（常规款、手提带、加固边框等）
5. 未来可以按产品类型进行透视分析

### 场景 3：竞品对比标记

1. 创建「竞品等级」自定义列
2. 标记核心竞品、次要竞品、潜在威胁
3. 创建「关注度」列
4. 记录重点关注的产品

---

## 八、注意事项

1. **数据同步**：表格视图和画板视图共享同一份数据，修改会实时同步
2. **自动保存**：编辑后需要点击「保存更改」按钮才会持久化到数据库
3. **列管理**：删除自定义列会同时删除所有产品该列的数据
4. **搜索过滤**：搜索不会影响保存，只是临时过滤显示

---

## 九、迁移说明

### 数据库迁移已完成 ✅

执行时间：2026-01-26

迁移文件：`db/migrate_data_table_view.sql`

新增字段已成功创建，包含：
- `collection_products.monthly_sales` (JSONB)
- `collection_products.custom_tags` (JSONB)
- `keyword_collections.custom_fields` (JSONB)

### 后端服务已重启 ✅

所有新的 API 端点已生效。

---

## 十、开发者指南

### 添加新的列类型

如果需要添加新的列类型（例如日期、多选等），需要：

1. 在 `CustomFieldDefinition` 中添加新类型
2. 在 `EditableCell` 组件中实现对应的编辑器
3. 在 `updateProduct` 函数中处理数据转换

### 扩展透视功能

要将自定义标签作为透视维度：

1. 在 `ProductBoardSection` 中添加新的视图模式
2. 实现标签值分组逻辑
3. 动态生成画板

---

## 相关文件

### 后端
- `backend/app/models/collection_product.py` - 产品模型
- `backend/app/models/keyword_collection.py` - 产品库模型
- `backend/app/api/keyword_collections.py` - API 端点
- `db/migrate_data_table_view.sql` - 数据库迁移脚本

### 前端
- `frontend/src/app/components/product-board/ProductDataTable.tsx` - 表格视图组件
- `frontend/src/app/components/product-board/ProductBoardSection.tsx` - 主页面组件
- `frontend/src/api/service.ts` - API 服务

---

## 更新日志

### v1.0.0 (2026-01-26)

- ✅ 新增月度销量数据字段
- ✅ 新增自定义标签系统
- ✅ 实现表格视图组件
- ✅ 集成到市场格局分析详情页
- ✅ 支持自定义列管理
- ✅ 支持批量数据编辑和保存
