/**
 * JsonReportRenderer - JSON ç»“æ„åŒ–æŠ¥å‘Šæ¸²æŸ“ç»„ä»¶
 * 
 * æ”¯æŒå››ç§æŠ¥å‘Šç±»å‹çš„æ¸²æŸ“ï¼š
 * 1. comprehensive: CEO/ç»¼åˆæˆ˜ç•¥ç‰ˆ
 * 2. operations: CMO/è¿è¥å¸‚åœºç‰ˆ
 * 3. product: CPO/äº§å“ç ”å‘ç‰ˆ
 * 4. supply_chain: ä¾›åº”é“¾/è´¨æ£€ç‰ˆ
 * 
 * æ”¯æŒè¯æ®æº¯æº (Traceability):
 * - ç‚¹å‡»å¸¦ source_tag çš„è§‚ç‚¹ï¼Œå¯æŸ¥çœ‹åŸå§‹è¯„è®ºè¯æ®
 */
import { memo, useMemo, useState, useCallback, useRef, useEffect, createContext, useContext } from 'react';
import {
  Target,
  TrendingUp,
  TrendingDown,
  AlertTriangle,
  CheckCircle2,
  Lightbulb,
  Users,
  Megaphone,
  Wrench,
  Package,
  AlertCircle,
  ChevronRight,
  Star,
  ThumbsUp,
  ThumbsDown,
  MessageSquare,
  Zap,
  Shield,
  Clock,
  FileText,
  Search,
  Copy,
  Check
} from 'lucide-react';
import type { 
  ReportType,
  ComprehensiveReportContent,
  OperationsReportContent,
  ProductReportContent,
  SupplyChainReportContent,
  ReportStats,
  ChartDataItem,
  EvidenceSample
} from '@/api/types';
import { REPORT_TYPE_CONFIG, getStatsItems } from '@/api/types';
import { EvidenceDrawer } from './EvidenceDrawer';
import { StatsDashboard } from './StatsDashboard';
import { CompareReviewSidebar } from './CompareReviewSidebar';

// è¯æ®ä¸Šä¸‹æ–‡ - ç”¨äºåœ¨å­ç»„ä»¶ä¸­è®¿é—® analysisData
interface EvidenceContextType {
  analysisData: ReportStats | null;
  asin?: string;
  openEvidence: (title: string, sourceTag: string, sourceType: 'context' | 'insight', category: string) => void;
}

const EvidenceContext = createContext<EvidenceContextType>({
  analysisData: null,
  openEvidence: () => {}
});

// å¤§çº²ä¸Šä¸‹æ–‡ - ç”¨äºæ”¶é›†æ‰€æœ‰æ¿å—æ ‡é¢˜
interface TocContextType {
  registerSection: (id: string, title: string, level?: number) => void;
}

export const TocContext = createContext<TocContextType>({
  registerSection: () => {}
});

interface JsonReportRendererProps {
  content: string;
  reportType: ReportType;
  analysisData?: ReportStats | null;  // åŸå§‹ç»Ÿè®¡æ•°æ®ï¼Œç”¨äºæº¯æº
  asin?: string;  // äº§å“ ASINï¼Œç”¨äºè·³è½¬
  onSectionsChange?: (sections: Array<{ id: string; title: string; level?: number }>) => void;  // å¤§çº²å˜åŒ–å›è°ƒ
  onDrawerStateChange?: (isOpen: boolean) => void;  // è¯æ®æŠ½å±‰çŠ¶æ€å˜åŒ–å›è°ƒ
}

// å®‰å…¨è§£æ JSON
function safeParseJson(content: string): unknown {
  try {
    return JSON.parse(content);
  } catch {
    return null;
  }
}

// å®‰å…¨æ¸²æŸ“å€¼ - ç¡®ä¿å¯¹è±¡ä¸ä¼šè¢«ç›´æ¥æ¸²æŸ“
function safeRender(value: unknown): string {
  if (value === null || value === undefined) {
    return '';
  }
  if (typeof value === 'string') {
    return value;
  }
  if (typeof value === 'number' || typeof value === 'boolean') {
    return String(value);
  }
  if (typeof value === 'object') {
    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•æå–å¸¸è§å­—æ®µ
    const obj = value as Record<string, unknown>;
    if (obj.point) return String(obj.point);
    if (obj.risk) return String(obj.risk);
    if (obj.title) return String(obj.title);
    if (obj.issue) return String(obj.issue);
    if (obj.feature) return String(obj.feature);
    if (obj.part) return String(obj.part);
    if (obj.item) return String(obj.item);
    // å¦åˆ™è¿”å› JSON å­—ç¬¦ä¸²
    return JSON.stringify(value);
  }
  return String(value);
}

// å¯æº¯æºæ ‡ç­¾ç»„ä»¶ - ç‚¹å‡»å¯æŸ¥çœ‹è¯æ®
const TraceableTag = memo(function TraceableTag({
  sourceTag,
  sourceType,
  category,
  children,
  variant = 'default'
}: {
  sourceTag?: string;
  sourceType: 'context' | 'insight';
  category: string;
  children: React.ReactNode;
  variant?: 'default' | 'danger' | 'warning' | 'success';
}) {
  const { analysisData, openEvidence } = useContext(EvidenceContext);
  
  // æ£€æŸ¥æ˜¯å¦æœ‰è¯æ®å¯æº¯æº
  const hasEvidence = sourceTag && analysisData;
  
  if (!hasEvidence) {
    return <>{children}</>;
  }
  
  const variantStyles = {
    default: 'hover:bg-blue-100 dark:hover:bg-blue-900/30',
    danger: 'hover:bg-red-100 dark:hover:bg-red-900/30',
    warning: 'hover:bg-amber-100 dark:hover:bg-amber-900/30',
    success: 'hover:bg-emerald-100 dark:hover:bg-emerald-900/30'
  };
  
  return (
    <button
      onClick={() => openEvidence(`å…³äº"${sourceTag}"çš„åé¦ˆ`, sourceTag, sourceType, category)}
      className={`inline-flex items-center gap-1 cursor-pointer transition-colors rounded px-1 -mx-1 ${variantStyles[variant]}`}
      title="ç‚¹å‡»æŸ¥çœ‹è¯æ®"
    >
      {children}
      <Search className="size-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" />
    </button>
  );
});

// é€šç”¨å¡ç‰‡ç»„ä»¶
const Card = memo(function Card({ 
  title, 
  icon: Icon, 
  children, 
  className = '',
  variant = 'default',
  id,
  level = 0
}: { 
  title: string; 
  icon?: typeof Target; 
  children: React.ReactNode;
  className?: string;
  variant?: 'default' | 'success' | 'danger' | 'warning' | 'info';
  id?: string;
  level?: number;
}) {
  const [copied, setCopied] = useState(false);
  const cardRef = useRef<HTMLDivElement>(null);
  const { registerSection } = useContext(TocContext);

  const variantStyles = {
    default: 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700',
    success: 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800',
    danger: 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800',
    warning: 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800',
    info: 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800'
  };

  // ç§»é™¤ title ä¸­çš„ emojiï¼Œåªä¿ç•™æ–‡å­—
  const cleanTitle = title.replace(/^[\u{1F300}-\u{1F9FF}]+\s*/u, '').trim() || title;
  
  // ç”Ÿæˆ IDï¼ˆå¦‚æœæ²¡æœ‰æä¾›ï¼‰
  const cardId = useMemo(() => {
    if (id) return id;
    const baseId = cleanTitle.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
    // ç¡®ä¿ ID ä¸ä¸ºç©ºä¸”æœ‰æ•ˆ
    return baseId ? `section-${baseId}` : `section-${Math.random().toString(36).substr(2, 9)}`;
  }, [id, cleanTitle]);
  
  // æ³¨å†Œåˆ°å¤§çº²ï¼ˆå»¶è¿Ÿæ³¨å†Œï¼Œç¡®ä¿ DOM å·²æ¸²æŸ“ï¼‰
  useEffect(() => {
    if (registerSection && cardRef.current) {
      // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM å·²æ¸²æŸ“
      const timer = requestAnimationFrame(() => {
        registerSection(cardId, cleanTitle, level);
      });
      return () => cancelAnimationFrame(timer);
    }
  }, [cardId, cleanTitle, level, registerSection]);

  const handleCopy = useCallback(async () => {
    if (!cardRef.current) return;
    
    // è·å–å¡ç‰‡çš„æ–‡æœ¬å†…å®¹
    const textContent = cardRef.current.innerText || '';
    
    try {
      await navigator.clipboard.writeText(textContent);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  }, []);

  return (
    <div 
      id={cardId}
      ref={cardRef} 
      className={`rounded-lg border p-4 ${variantStyles[variant]} ${className} relative scroll-mt-24`}
    >
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          {Icon && <Icon className="size-5 text-gray-600 dark:text-gray-400" />}
          <h3 className="font-semibold text-gray-900 dark:text-white">{cleanTitle}</h3>
        </div>
        <button
          onClick={handleCopy}
          className="flex items-center justify-center w-7 h-7 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
          title="å¤åˆ¶å†…å®¹"
        >
          {copied ? (
            <Check className="size-4 text-emerald-600 dark:text-emerald-400" />
          ) : (
            <Copy className="size-4" />
          )}
        </button>
      </div>
      {children}
    </div>
  );
});

// åˆ—è¡¨é¡¹ç»„ä»¶
const ListItem = memo(function ListItem({ 
  children, 
  icon: Icon,
  variant = 'default'
}: { 
  children: React.ReactNode; 
  icon?: typeof ChevronRight;
  variant?: 'default' | 'success' | 'danger' | 'warning';
}) {
  const iconColors = {
    default: 'text-gray-400',
    success: 'text-emerald-500',
    danger: 'text-red-500',
    warning: 'text-amber-500'
  };

  return (
    <li className="flex items-start gap-2 py-1">
      {Icon ? (
        <Icon className={`size-4 mt-0.5 flex-shrink-0 ${iconColors[variant]}`} />
      ) : (
        <ChevronRight className={`size-4 mt-0.5 flex-shrink-0 ${iconColors[variant]}`} />
      )}
      <span className="text-sm text-gray-700 dark:text-gray-300">{children}</span>
    </li>
  );
});

// é£é™©ç­‰çº§å¾½ç« 
const RiskBadge = memo(function RiskBadge({ level }: { level: string }) {
  const config: Record<string, { bg: string; text: string; label: string }> = {
    low: { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-400', label: 'ä½é£é™©' },
    medium: { bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-700 dark:text-yellow-400', label: 'ä¸­ç­‰é£é™©' },
    high: { bg: 'bg-orange-100 dark:bg-orange-900/30', text: 'text-orange-700 dark:text-orange-400', label: 'é«˜é£é™©' },
    critical: { bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-700 dark:text-red-400', label: 'ä¸¥é‡é£é™©' }
  };
  const c = config[level] || config.medium;
  
  return (
    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${c.bg} ${c.text}`}>
      <AlertTriangle className="size-3 mr-1" />
      {c.label}
    </span>
  );
});

// ä¸¥é‡ç¨‹åº¦å¾½ç« 
const SeverityBadge = memo(function SeverityBadge({ severity }: { severity: string }) {
  const config: Record<string, { bg: string; text: string }> = {
    High: { bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-700 dark:text-red-400' },
    Medium: { bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-700 dark:text-yellow-400' },
    Low: { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-400' }
  };
  const c = config[severity] || config.Medium;
  
  return (
    <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${c.bg} ${c.text}`}>
      {severity}
    </span>
  );
});

// ç½®ä¿¡åº¦å¾½ç« ç»„ä»¶
const ConfidenceBadge = memo(function ConfidenceBadge({ 
  confidence,
  showLabel = true 
}: { 
  confidence?: string;
  showLabel?: boolean;
}) {
  if (!confidence) return null;
  
  const config: Record<string, { bg: string; text: string; label: string; icon: string }> = {
    high: { 
      bg: 'bg-emerald-100 dark:bg-emerald-900/30', 
      text: 'text-emerald-700 dark:text-emerald-400', 
      label: 'é«˜ç½®ä¿¡',
      icon: 'âœ“'
    },
    medium: { 
      bg: 'bg-amber-100 dark:bg-amber-900/30', 
      text: 'text-amber-700 dark:text-amber-400', 
      label: 'ä¸­ç½®ä¿¡',
      icon: '~'
    },
    low: { 
      bg: 'bg-gray-100 dark:bg-gray-700', 
      text: 'text-gray-600 dark:text-gray-400', 
      label: 'ä½ç½®ä¿¡',
      icon: '?'
    }
  };
  const c = config[confidence.toLowerCase()] || config.medium;
  
  return (
    <span 
      className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium ${c.bg} ${c.text}`}
      title={`ç½®ä¿¡åº¦: ${c.label}`}
    >
      <span>{c.icon}</span>
      {showLabel && <span>{c.label}</span>}
    </span>
  );
});

// è§£æ evidence å­—ç¬¦ä¸²ä¸ºå¯¹è±¡
function parseEvidenceString(evidence: unknown): { count?: number; percentage?: string; quotes?: string[] } | null {
  if (!evidence) return null;
  
  // å¦‚æœå·²ç»æ˜¯å¯¹è±¡
  if (typeof evidence === 'object' && evidence !== null) {
    const obj = evidence as Record<string, unknown>;
    return {
      count: typeof obj.count === 'number' ? obj.count : undefined,
      percentage: typeof obj.percentage === 'string' ? obj.percentage : undefined,
      quotes: Array.isArray(obj.sample_quotes) ? obj.sample_quotes as string[] : undefined
    };
  }
  
  // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
  if (typeof evidence === 'string') {
    const result: { count?: number; percentage?: string; quotes?: string[] } = {};
    
    // æå– count
    const countMatch = evidence.match(/count:\s*(\d+)/);
    if (countMatch) result.count = parseInt(countMatch[1]);
    
    // æå– percentage
    const percentMatch = evidence.match(/percentage:\s*([\d.]+%)/);
    if (percentMatch) result.percentage = percentMatch[1];
    
    // æå– quotes
    const quotesMatch = evidence.match(/sample_quotes:\s*\[([^\]]+)\]/);
    if (quotesMatch) {
      const quotesStr = quotesMatch[1];
      result.quotes = quotesStr.split(/['"]\s*,\s*['"]/).map(q => q.replace(/^['"]|['"]$/g, '').trim()).filter(q => q.length > 0);
    }
    
    return result;
  }
  
  return null;
}

// è¯æ®å¼•ç”¨ç»„ä»¶ - æ˜¾ç¤ºè¯æ®è®¡æ•°å’Œå¼•ç”¨
const EvidenceBlock = memo(function EvidenceBlock({
  evidence,
  sourceTag
}: {
  evidence?: unknown;
  sourceTag?: string;
}) {
  const parsed = parseEvidenceString(evidence);
  
  if (!parsed || (!parsed.count && !parsed.quotes?.length)) {
    return null;
  }
  
  return (
    <div className="mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800">
      <div className="flex items-center gap-2 text-xs text-blue-600 dark:text-blue-400 mb-1">
        <Search className="size-3" />
        <span className="font-medium">
          ğŸ“Š è¯æ®æ”¯æŒ: {parsed.count || 0}æ¡ 
          {parsed.percentage && <span className="ml-1">({parsed.percentage})</span>}
        </span>
        {sourceTag && (
          <span className="text-gray-500 dark:text-gray-400">Â· æ¥æº: {sourceTag}</span>
        )}
      </div>
      {parsed.quotes && parsed.quotes.length > 0 && (
        <div className="space-y-1 mt-1">
          <div className="text-xs text-gray-500 dark:text-gray-400">ğŸ’¬ ç”¨æˆ·åŸè¯:</div>
          {parsed.quotes.slice(0, 2).map((quote, i) => (
            <div key={i} className="text-xs text-gray-600 dark:text-gray-400 italic pl-2 border-l-2 border-blue-200 dark:border-blue-700">
              "{quote.length > 60 ? quote.slice(0, 60) + '...' : quote}"
            </div>
          ))}
        </div>
      )}
    </div>
  );
});

// ç®€åŒ–ç‰ˆè¯æ®æ˜¾ç¤ºï¼ˆç”¨äºè¡¨æ ¼ç­‰ç´§å‡‘åœºæ™¯ï¼‰
const EvidenceInline = memo(function EvidenceInline({ evidence }: { evidence?: unknown }) {
  const parsed = parseEvidenceString(evidence);
  
  if (!parsed || !parsed.count) return null;
  
  return (
    <div className="mt-2 text-xs text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 p-2 rounded">
      <div className="flex items-center gap-1 mb-1">
        <Search className="size-3" />
        <span className="font-medium">ğŸ“Š {parsed.count}æ¡è¯æ® ({parsed.percentage || 'N/A'})</span>
      </div>
      {parsed.quotes && parsed.quotes.length > 0 && (
        <div className="text-gray-600 dark:text-gray-400 italic">
          ğŸ’¬ "{parsed.quotes[0].length > 50 ? parsed.quotes[0].slice(0, 50) + '...' : parsed.quotes[0]}"
        </div>
      )}
    </div>
  );
});

// è¾…åŠ©å‡½æ•°ï¼šä»æ–°æ ¼å¼ä¸­æå–æè¿°ï¼ˆæ™ºèƒ½å¤„ç†å¤šç§å­—æ®µï¼‰
function extractDescription(value: unknown): string {
  if (!value) return '';
  if (typeof value === 'string') return value;
  if (Array.isArray(value)) return value.map(v => typeof v === 'string' ? v : safeRender(v)).join('ã€');
  if (typeof value === 'object' && value !== null) {
    const obj = value as Record<string, unknown>;
    // ä¼˜å…ˆæå–å¸¸è§æè¿°å­—æ®µ
    if (obj.description) return String(obj.description);
    if (obj.point) return String(obj.point);
    if (obj.summary) return String(obj.summary);
    if (obj.content) return String(obj.content);
    // ä¾›åº”é“¾ç‰ˆç‰¹æ®Šå­—æ®µ
    if (obj.environments) {
      const parts: string[] = [];
      if (obj.environments) parts.push(`ç¯å¢ƒ: ${Array.isArray(obj.environments) ? (obj.environments as string[]).join('ã€') : obj.environments}`);
      if (obj.environmental_stress_factors) parts.push(`å‹åŠ›å› ç´ : ${Array.isArray(obj.environmental_stress_factors) ? (obj.environmental_stress_factors as string[]).join('ã€') : obj.environmental_stress_factors}`);
      if (obj.quality_implications) parts.push(`è´¨é‡è¦æ±‚: ${obj.quality_implications}`);
      return parts.join(' | ');
    }
    // ç”¨æˆ·ç¾¤ä½“ç‰¹æ®Šå­—æ®µ
    if (obj.quality_expectations) {
      const parts: string[] = [];
      if (obj.description) parts.push(String(obj.description));
      if (obj.quality_expectations) parts.push(`è´¨é‡æœŸæœ›: ${Array.isArray(obj.quality_expectations) ? (obj.quality_expectations as string[]).join('ã€') : obj.quality_expectations}`);
      return parts.join(' | ');
    }
    if (obj.special_requirements) {
      const parts: string[] = [];
      if (obj.description) parts.push(String(obj.description));
      if (obj.special_requirements) parts.push(`ç‰¹æ®Šéœ€æ±‚: ${Array.isArray(obj.special_requirements) ? (obj.special_requirements as string[]).join('ã€') : obj.special_requirements}`);
      return parts.join(' | ');
    }
    // ä½¿ç”¨å¼ºåº¦
    if (obj.frequency) {
      const parts: string[] = [];
      if (obj.frequency) parts.push(`é¢‘ç‡: ${obj.frequency}`);
      if (obj.duration) parts.push(`æ—¶é•¿: ${obj.duration}`);
      if (obj.durability_requirements) parts.push(`è€ä¹…è¦æ±‚: ${Array.isArray(obj.durability_requirements) ? (obj.durability_requirements as string[]).join('ã€') : obj.durability_requirements}`);
      return parts.join(' | ');
    }
  }
  return safeRender(value);
}

// è¾…åŠ©å‡½æ•°ï¼šä»æ–°æ ¼å¼ä¸­æå–ç½®ä¿¡åº¦
function extractConfidence(value: unknown): string | undefined {
  if (!value || typeof value !== 'object') return undefined;
  const obj = value as Record<string, unknown>;
  return obj.confidence ? String(obj.confidence) : undefined;
}

// è¾…åŠ©å‡½æ•°ï¼šä»æ–°æ ¼å¼ä¸­æå–è¯æ®
function extractEvidence(value: unknown): { count?: number; percentage?: string; sample_ids?: string[]; sample_quotes?: string[] } | undefined {
  if (!value || typeof value !== 'object') return undefined;
  const obj = value as Record<string, unknown>;
  if (!obj.evidence) return undefined;
  return obj.evidence as { count?: number; percentage?: string; sample_ids?: string[]; sample_quotes?: string[] };
}

// ========== ç”¨æˆ·ç”»åƒå¡ç‰‡ç»„ä»¶ (å…±ç”¨) ==========
const UserProfileCard = memo(function UserProfileCard({ 
  profile,
  variant = 'comprehensive'
}: { 
  profile: Record<string, unknown>;
  variant?: 'comprehensive' | 'operations' | 'product' | 'supply_chain';
}) {
  if (!profile) return null;
  
  // æ ¹æ®ä¸åŒæŠ¥å‘Šç±»å‹ï¼Œå­—æ®µåå¯èƒ½ä¸åŒï¼ˆ2026-01-14: åŒºåˆ† buyer å’Œ userï¼‰
  const coreBuyers = profile.core_buyers || profile.primary_buyers || profile.target_buyers || profile.buyer_groups;
  const coreUsers = profile.core_users || profile.primary_users || profile.primary_audience || profile.target_users || profile.user_groups;
  const scenarios = profile.usage_scenarios || profile.usage_context || profile.real_usage_environments || profile.usage_environments;
  const motivation = profile.purchase_motivation || profile.buying_triggers;
  const jtbd = profile.jobs_to_be_done || profile.use_cases || profile.user_goals;
  const summary = profile.persona_insight || profile.unmet_expectations || profile.environmental_requirements;
  
  return (
    <Card title="ğŸ‘¤ ç”¨æˆ·ç”»åƒ5wæ¦‚å†µ" icon={Users} variant="info">
      <div className="space-y-4">
        {/* è´­ä¹°è€… - æ”¯æŒæ–°æ ¼å¼ï¼ˆå¸¦ç½®ä¿¡åº¦å’Œè¯æ®ï¼‰ */}
        {coreBuyers && (
          <div className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div className="flex items-center gap-2 mb-1">
              <span className="text-xs font-semibold text-blue-700 dark:text-blue-400">Buyer - è´­ä¹°è€…ç¾¤ä½“</span>
              <ConfidenceBadge confidence={extractConfidence(coreBuyers)} />
            </div>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              {Array.isArray(coreBuyers) ? coreBuyers.map(safeRender).join('ã€') : extractDescription(coreBuyers)}
            </p>
            <EvidenceBlock evidence={extractEvidence(coreBuyers)} />
          </div>
        )}
        
        {/* ä½¿ç”¨è€… - æ”¯æŒæ–°æ ¼å¼ï¼ˆå¸¦ç½®ä¿¡åº¦å’Œè¯æ®ï¼‰ */}
        {coreUsers && (
          <div className="p-3 bg-cyan-50 dark:bg-cyan-900/20 rounded-lg">
            <div className="flex items-center gap-2 mb-1">
              <span className="text-xs font-semibold text-cyan-700 dark:text-cyan-400">User - ä½¿ç”¨è€…ç¾¤ä½“</span>
              <ConfidenceBadge confidence={extractConfidence(coreUsers)} />
            </div>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              {Array.isArray(coreUsers) ? coreUsers.map(safeRender).join('ã€') : extractDescription(coreUsers)}
            </p>
            <EvidenceBlock evidence={extractEvidence(coreUsers)} />
          </div>
        )}
        
        {/* å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰ buyer/userï¼Œæ˜¾ç¤ºæ—§çš„ who */}
        {!coreBuyers && !coreUsers && (profile.core_users || profile.primary_audience || profile.target_users || profile.user_groups) && (
          <div className="p-3 bg-slate-50 dark:bg-slate-900/20 rounded-lg">
            <div className="text-xs font-semibold text-slate-700 dark:text-slate-400 mb-1">Who - æ ¸å¿ƒç”¨æˆ·ç¾¤ä½“ï¼ˆæ—§æ•°æ®ï¼‰</div>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              {Array.isArray(coreUsers) ? coreUsers.map(safeRender).join('ã€') : safeRender(coreUsers)}
            </p>
          </div>
        )}
        
        {/* ç”¨æˆ·ç‰¹å¾æ ‡ç­¾ */}
        {profile.user_characteristics && Array.isArray(profile.user_characteristics) && (
          <div className="flex flex-wrap gap-2">
            {(profile.user_characteristics as string[]).map((tag, i) => (
              <span key={i} className="px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded text-xs">
                {safeRender(tag)}
              </span>
            ))}
          </div>
        )}
        
        {/* ä½¿ç”¨åœºæ™¯ - æ”¯æŒæ–°æ ¼å¼ */}
        {scenarios && (
          <div className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
            <div className="flex items-center gap-2 mb-1">
              <span className="text-xs font-semibold text-purple-700 dark:text-purple-400">Where/When - ä½¿ç”¨åœºæ™¯</span>
              <ConfidenceBadge confidence={extractConfidence(scenarios)} />
            </div>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              {Array.isArray(scenarios) ? scenarios.map(safeRender).join('ã€') : extractDescription(scenarios)}
            </p>
            <EvidenceBlock evidence={extractEvidence(scenarios)} />
          </div>
        )}
        
        {/* è´­ä¹°åŠ¨æœº - æ”¯æŒæ–°æ ¼å¼ */}
        {motivation && (
          <div className="p-3 bg-pink-50 dark:bg-pink-900/20 rounded-lg">
            <div className="flex items-center gap-2 mb-1">
              <span className="text-xs font-semibold text-pink-700 dark:text-pink-400">Why - è´­ä¹°åŠ¨æœº</span>
              <ConfidenceBadge confidence={extractConfidence(motivation)} />
            </div>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              {Array.isArray(motivation) ? motivation.map(safeRender).join('ã€') : extractDescription(motivation)}
            </p>
            <EvidenceBlock evidence={extractEvidence(motivation)} />
          </div>
        )}
        
        {/* ç”¨æˆ·ä»»åŠ¡/JTBD - æ”¯æŒæ–°æ ¼å¼ */}
        {jtbd && (
          <div className="p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
            <div className="flex items-center gap-2 mb-1">
              <span className="text-xs font-semibold text-orange-700 dark:text-orange-400">What - ç”¨æˆ·ä»»åŠ¡ (JTBD)</span>
              <ConfidenceBadge confidence={extractConfidence(jtbd)} />
            </div>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              {Array.isArray(jtbd) ? jtbd.map(safeRender).join('ã€') : extractDescription(jtbd)}
            </p>
            <EvidenceBlock evidence={extractEvidence(jtbd)} />
          </div>
        )}
        
        {/* å¹¿å‘Šå…³é”®è¯ (è¿è¥ç‰ˆ) */}
        {profile.ad_targeting_keywords && Array.isArray(profile.ad_targeting_keywords) && (
          <div>
            <div className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">å¹¿å‘ŠæŠ•æ”¾å…³é”®è¯</div>
            <div className="flex flex-wrap gap-2">
              {(profile.ad_targeting_keywords as string[]).map((kw, i) => (
                <span key={i} className="px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded text-xs font-medium">
                  {kw}
                </span>
              ))}
            </div>
          </div>
        )}
        
        {/* ç”¨æˆ·ç—›ç‚¹åˆ†ç±» (äº§å“ç‰ˆ) */}
        {profile.user_pain_points && Array.isArray(profile.user_pain_points) && (
          <div className="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
            <div className="text-xs font-semibold text-red-700 dark:text-red-400 mb-2">æŒ‰ç”¨æˆ·åˆ†ç±»çš„ç—›ç‚¹</div>
            <ul className="space-y-1">
              {(profile.user_pain_points as string[]).map((pain, i) => (
                <li key={i} className="text-sm text-gray-700 dark:text-gray-300 flex items-start gap-2">
                  <span className="text-red-500">â€¢</span>
                  {pain}
                </li>
              ))}
            </ul>
          </div>
        )}
        
        {/* è€ä¹…æ€§å…³æ³¨ç‚¹ (ä¾›åº”é“¾ç‰ˆ) */}
        {profile.durability_focus && Array.isArray(profile.durability_focus) && (
          <div>
            <div className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">é‡ç‚¹è€ä¹…æ€§å…³æ³¨</div>
            <div className="flex flex-wrap gap-2">
              {(profile.durability_focus as string[]).map((item, i) => (
                <span key={i} className="px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded text-xs">
                  {item}
                </span>
              ))}
            </div>
          </div>
        )}
        
        {/* æ€»ç»“æ´å¯Ÿ */}
        {summary && (
          <div className="p-3 bg-gradient-to-r from-emerald-50 to-blue-50 dark:from-emerald-900/20 dark:to-blue-900/20 rounded-lg border border-emerald-200 dark:border-emerald-800">
            <div className="text-xs font-semibold text-emerald-700 dark:text-emerald-400 mb-1">ğŸ’¡ ç”»åƒæ´å¯Ÿ</div>
            <p className="text-sm text-gray-700 dark:text-gray-300 font-medium">{summary as string}</p>
          </div>
        )}
      </div>
    </Card>
  );
});

// ========== ç»¼åˆæˆ˜ç•¥ç‰ˆæ¸²æŸ“å™¨ ==========
const ComprehensiveRenderer = memo(function ComprehensiveRenderer({ 
  data 
}: { 
  data: ComprehensiveReportContent 
}) {
  // é€šç”¨æ¸²æŸ“æ•°ç»„é¡¹çš„è¾…åŠ©å‡½æ•°
  const renderArrayItems = (items: unknown[], renderItem: (item: Record<string, unknown>, i: number) => React.ReactNode) => {
    if (!Array.isArray(items)) return null;
    return items.map((item, i) => {
      if (typeof item === 'object' && item !== null) {
        return renderItem(item as Record<string, unknown>, i);
      }
      return <p key={i} className="text-gray-700 dark:text-gray-300">{String(item)}</p>;
    });
  };

  return (
    <div className="space-y-6">
      {/* ç”¨æˆ·ç”»åƒåˆ†æ - æ–°æ ¼å¼ï¼šæ•°ç»„ [{aspect, insight, evidence, confidence}] */}
      {data.user_profile && Array.isArray(data.user_profile) && data.user_profile.length > 0 && (
        <Card title="ğŸ‘¥ ç”¨æˆ·ç”»åƒåˆ†æ" icon={Users} variant="info">
          <div className="space-y-4">
            {renderArrayItems(data.user_profile, (item, i) => (
              <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-800">
                <div className="flex items-center gap-2 mb-2">
                  {item.aspect && (
                    <span className="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded text-xs font-medium">
                      {String(item.aspect)}
                    </span>
                  )}
                  {item.confidence && <ConfidenceBadge confidence={String(item.confidence)} />}
                </div>
                <p className="text-sm text-gray-700 dark:text-gray-300 mb-2">{String(item.insight || '')}</p>
                {item.evidence && Array.isArray(item.evidence) && item.evidence.length > 0 && (
                  <EvidenceInline evidence={item.evidence} />
                )}
              </div>
            ))}
          </div>
        </Card>
      )}
      
      {/* æ—§æ ¼å¼å…¼å®¹ */}
      {data.user_profile && !Array.isArray(data.user_profile) && typeof data.user_profile === 'object' && (
        <UserProfileCard profile={data.user_profile as unknown as Record<string, unknown>} variant="comprehensive" />
      )}
      
      {/* æˆ˜ç•¥å®šè°ƒ */}
      <Card title="ğŸ¯ æˆ˜ç•¥å®šè°ƒ" icon={Target} variant="info">
        {typeof data.strategic_verdict === 'string' ? (
          <p className="text-gray-700 dark:text-gray-300 leading-relaxed">{data.strategic_verdict}</p>
        ) : Array.isArray(data.strategic_verdict) ? (
          <div className="space-y-3">
            {renderArrayItems(data.strategic_verdict, (item, i) => (
              <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                <div className="flex items-start gap-2">
                  <p className="flex-1 text-gray-700 dark:text-gray-300">{String(item.verdict || item.insight || '')}</p>
                  {item.confidence && <ConfidenceBadge confidence={String(item.confidence)} />}
                </div>
                {item.evidence && Array.isArray(item.evidence) && <EvidenceInline evidence={item.evidence} />}
              </div>
            ))}
          </div>
        ) : (
          <p className="text-gray-700 dark:text-gray-300">{JSON.stringify(data.strategic_verdict)}</p>
        )}
        {data.risk_level && (
          <div className="mt-3">
            <RiskBadge level={typeof data.risk_level === 'string' ? data.risk_level : 'medium'} />
          </div>
        )}
      </Card>

      {/* å¸‚åœºåŒ¹é…åº¦åˆ†æ - æ–°æ ¼å¼ï¼šæ•°ç»„ [{insight, evidence, confidence, analysis}] */}
      {data.market_fit_analysis && (
        <Card title="ğŸ“Š å¸‚åœºåŒ¹é…åº¦åˆ†æ" icon={TrendingUp}>
          {typeof data.market_fit_analysis === 'string' ? (
            <p className="text-gray-700 dark:text-gray-300 leading-relaxed">{data.market_fit_analysis}</p>
          ) : Array.isArray(data.market_fit_analysis) ? (
            <div className="space-y-4">
              {renderArrayItems(data.market_fit_analysis, (item, i) => (
                <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                  <div className="flex items-start gap-2 mb-2">
                    <p className="flex-1 font-medium text-gray-900 dark:text-white">{String(item.insight || '')}</p>
                    {item.confidence && <ConfidenceBadge confidence={String(item.confidence)} />}
                  </div>
                  {item.analysis && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">{String(item.analysis)}</p>
                  )}
                  {item.evidence && Array.isArray(item.evidence) && item.evidence.length > 0 && (
                    <EvidenceInline evidence={item.evidence} />
                  )}
                </div>
              ))}
            </div>
          ) : (
            <p className="text-gray-700 dark:text-gray-300">{JSON.stringify(data.market_fit_analysis)}</p>
          )}
        </Card>
      )}

      {/* SWOT åˆ†æ - å…¼å®¹ä¸­è‹±æ–‡é”®å */}
      {data.core_swot && (() => {
        // å…¼å®¹ä¸­è‹±æ–‡é”®å
        const swot = data.core_swot as Record<string, unknown>;
        const strengths = (swot.strengths || swot['ä¼˜åŠ¿'] || []) as unknown[];
        const weaknesses = (swot.weaknesses || swot['åŠ£åŠ¿'] || []) as unknown[];
        const opportunities = (swot.opportunities || swot['æœºä¼š'] || []) as unknown[];
        const threats = (swot.threats || swot['å¨èƒ'] || []) as unknown[];
        
        // æ¸²æŸ“å•ä¸ª SWOT é¡¹
        const renderSwotItem = (item: unknown, variant: 'success' | 'danger' | 'info' | 'warning', icon: string, key: number) => {
          const bgColors = {
            success: 'bg-emerald-50 dark:bg-emerald-900/20',
            danger: 'bg-red-50 dark:bg-red-900/20',
            info: 'bg-blue-50 dark:bg-blue-900/20',
            warning: 'bg-amber-50 dark:bg-amber-900/20'
          };
          
          if (typeof item === 'object' && item !== null) {
            const obj = item as Record<string, unknown>;
            // ğŸ”§ [FIX] å…¼å®¹å¤šç§å­—æ®µåï¼špoint, dimension, name, insight, description, item, æè¿°
            const text = String(
              obj.point || 
              obj.dimension || 
              obj.name || 
              obj.insight || 
              obj.description || 
              obj.item ||
              obj['æè¿°'] || 
              obj['ç»´åº¦'] ||
              ''
            );
            const confidence = String(obj.confidence || obj['ç½®ä¿¡åº¦'] || '');
            const evidence = (obj.evidence || obj['è¯æ®'] || []) as unknown[];
            
            return (
              <li key={key} className={`p-2 ${bgColors[variant]} rounded`}>
                <div className="flex items-center gap-2">
                  <span>{icon}</span>
                  <span className="flex-1 text-sm font-medium">{text}</span>
                  {confidence && <ConfidenceBadge confidence={confidence} />}
                </div>
                {evidence.length > 0 && <EvidenceInline evidence={evidence} />}
              </li>
            );
          }
          return <li key={key} className="p-2 text-sm">{String(item)}</li>;
        };
        
        return (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <Card title="ä¼˜åŠ¿ (Strengths)" icon={ThumbsUp} variant="success">
              <ul className="space-y-2">
                {strengths.map((s, i) => renderSwotItem(s, 'success', 'âœ“', i))}
                {strengths.length === 0 && <li className="text-sm text-gray-500">æš‚æ— æ•°æ®</li>}
              </ul>
            </Card>
            <Card title="åŠ£åŠ¿ (Weaknesses)" icon={ThumbsDown} variant="danger">
              <ul className="space-y-2">
                {weaknesses.map((w, i) => renderSwotItem(w, 'danger', 'âœ—', i))}
                {weaknesses.length === 0 && <li className="text-sm text-gray-500">æš‚æ— æ•°æ®</li>}
              </ul>
            </Card>
            <Card title="æœºä¼š (Opportunities)" icon={Lightbulb} variant="info">
              <ul className="space-y-2">
                {opportunities.map((o, i) => renderSwotItem(o, 'info', 'ğŸ’¡', i))}
                {opportunities.length === 0 && <li className="text-sm text-gray-500">æš‚æ— æ•°æ®</li>}
              </ul>
            </Card>
            <Card title="å¨èƒ (Threats)" icon={AlertTriangle} variant="warning">
              <ul className="space-y-2">
                {threats.map((t, i) => renderSwotItem(t, 'warning', 'âš ', i))}
                {threats.length === 0 && <li className="text-sm text-gray-500">æš‚æ— æ•°æ®</li>}
              </ul>
            </Card>
          </div>
        );
      })()}

      {/* éƒ¨é—¨æŒ‡ä»¤ - æ–°æ ¼å¼ï¼šå¯èƒ½æ˜¯æ•°ç»„ */}
      {data.department_directives && (
        <Card title="ğŸ“‹ å„éƒ¨é—¨æŒ‡ä»¤" icon={Users}>
          {Array.isArray(data.department_directives) ? (
            <div className="space-y-3">
              {renderArrayItems(data.department_directives, (item, i) => (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="font-medium text-gray-900 dark:text-white">
                      {String(item.department || item.to || `æŒ‡ä»¤ ${i + 1}`)}
                    </span>
                    {item.confidence && <ConfidenceBadge confidence={String(item.confidence)} />}
                  </div>
                  <p className="text-sm text-gray-700 dark:text-gray-300">{String(item.directive || item.action || '')}</p>
                  {item.evidence && Array.isArray(item.evidence) && <EvidenceInline evidence={item.evidence} />}
                </div>
              ))}
            </div>
          ) : typeof data.department_directives === 'object' ? (
            <div className="space-y-3">
              {(data.department_directives as { to_marketing?: string }).to_marketing && (
                <div className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                  <div className="flex items-center gap-2 text-purple-700 dark:text-purple-400 text-sm font-medium mb-1">
                    <Megaphone className="size-4" />
                    To å¸‚åœºè¥é”€
                  </div>
                  <p className="text-sm text-gray-700 dark:text-gray-300">{(data.department_directives as { to_marketing?: string }).to_marketing}</p>
                </div>
              )}
              {(data.department_directives as { to_product?: string }).to_product && (
                <div className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                  <div className="flex items-center gap-2 text-blue-700 dark:text-blue-400 text-sm font-medium mb-1">
                    <Wrench className="size-4" />
                    To äº§å“ç ”å‘
                  </div>
                  <p className="text-sm text-gray-700 dark:text-gray-300">{(data.department_directives as { to_product?: string }).to_product}</p>
                </div>
              )}
              {(data.department_directives as { to_supply_chain?: string }).to_supply_chain && (
                <div className="p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                  <div className="flex items-center gap-2 text-orange-700 dark:text-orange-400 text-sm font-medium mb-1">
                    <Package className="size-4" />
                    To ä¾›åº”é“¾
                  </div>
                  <p className="text-sm text-gray-700 dark:text-gray-300">{(data.department_directives as { to_supply_chain?: string }).to_supply_chain}</p>
                </div>
              )}
            </div>
          ) : null}
        </Card>
      )}

      {/* ä¼˜å…ˆè¡ŒåŠ¨é¡¹ - æ–°æ ¼å¼ */}
      {data.priority_actions && data.priority_actions.length > 0 && (
        <Card title="âš¡ ä¼˜å…ˆè¡ŒåŠ¨é¡¹" icon={Zap}>
          <div className="space-y-3">
            {data.priority_actions.map((action, i) => {
              const actionText = typeof action === 'object' && action !== null
                ? (action as { action?: string }).action || (action as { task?: string }).task || JSON.stringify(action)
                : String(action);
              const owner = typeof action === 'object' ? (action as { owner?: string }).owner || '' : '';
              const deadline = typeof action === 'object' ? (action as { deadline?: string }).deadline || '' : '';
              const priority = typeof action === 'object' ? (action as { priority?: string }).priority || '' : '';
              const confidence = typeof action === 'object' ? (action as { confidence?: string }).confidence || '' : '';
              const evidence = typeof action === 'object' ? (action as { evidence?: unknown[] }).evidence || [] : [];
              
              return (
                <div key={i} className="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <span className={`flex items-center justify-center w-6 h-6 rounded-full text-white text-xs font-bold ${
                    priority === 'P0' ? 'bg-red-500' : priority === 'P1' ? 'bg-orange-500' : 'bg-emerald-500'
                  }`}>
                    {priority || (i + 1)}
                  </span>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <p className="font-medium text-gray-900 dark:text-white">{actionText}</p>
                      {confidence && <ConfidenceBadge confidence={confidence} />}
                    </div>
                    {(owner || deadline) && (
                      <div className="flex items-center gap-4 mt-1 text-xs text-gray-500">
                        {owner && <span>è´Ÿè´£äºº: {owner}</span>}
                        {deadline && <span>æˆªæ­¢: {deadline}</span>}
                      </div>
                    )}
                    {evidence.length > 0 && <EvidenceInline evidence={evidence} />}
                  </div>
                </div>
              );
            })}
          </div>
        </Card>
      )}
    </div>
  );
});

// ========== è¿è¥å¸‚åœºç‰ˆæ¸²æŸ“å™¨ ==========
const OperationsRenderer = memo(function OperationsRenderer({ 
  data 
}: { 
  data: OperationsReportContent 
}) {
  // é€šç”¨æ¸²æŸ“æ•°ç»„é¡¹çš„è¾…åŠ©å‡½æ•°
  const renderArrayItems = (items: unknown[], renderItem: (item: Record<string, unknown>, i: number) => React.ReactNode) => {
    if (!Array.isArray(items)) return null;
    return items.map((item, i) => {
      if (typeof item === 'object' && item !== null) {
        return renderItem(item as Record<string, unknown>, i);
      }
      return <p key={i} className="text-gray-700 dark:text-gray-300">{String(item)}</p>;
    });
  };

  return (
    <div className="space-y-6">
      {/* ç”¨æˆ·ç”»åƒ - æ–°æ ¼å¼ï¼šæ•°ç»„ [{tag, description, evidence, confidence}] */}
      {data.user_profile && Array.isArray(data.user_profile) && data.user_profile.length > 0 && (
        <Card title="ğŸ‘¥ ç”¨æˆ·ç”»åƒä¸å¸‚åœºå®šä½" icon={Users} variant="info">
          <div className="space-y-4">
            {renderArrayItems(data.user_profile, (item, i) => (
              <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-800">
                <div className="flex items-center gap-2 mb-2">
                  <h4 className="font-semibold text-gray-900 dark:text-white">{String(item.tag || '')}</h4>
                  {item.confidence && <ConfidenceBadge confidence={String(item.confidence)} />}
                </div>
                <p className="text-sm text-gray-700 dark:text-gray-300 mb-2">{String(item.description || '')}</p>
                {item.evidence && Array.isArray(item.evidence) && item.evidence.length > 0 && (
                  <EvidenceInline evidence={item.evidence} />
                )}
              </div>
            ))}
          </div>
        </Card>
      )}
      
      {/* æ—§æ ¼å¼å…¼å®¹ */}
      {data.user_profile && !Array.isArray(data.user_profile) && typeof data.user_profile === 'object' && (
        <UserProfileCard profile={data.user_profile as unknown as Record<string, unknown>} variant="operations" />
      )}
      
      {/* æ‰§è¡Œæ‘˜è¦ - æ–°æ ¼å¼ï¼šæ•°ç»„ [{insight, evidence, confidence}] */}
      {data.executive_summary && (
        <Card title="ğŸ“¢ å¸‚åœºç°çŠ¶" icon={Megaphone} variant="info">
          {typeof data.executive_summary === 'string' ? (
            <p className="text-gray-700 dark:text-gray-300 leading-relaxed">{data.executive_summary}</p>
          ) : Array.isArray(data.executive_summary) ? (
            <div className="space-y-4">
              {renderArrayItems(data.executive_summary, (item, i) => (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <div className="flex items-start gap-2">
                    <p className="flex-1 text-gray-700 dark:text-gray-300">{String(item.insight || item.summary || '')}</p>
                    {item.confidence && <ConfidenceBadge confidence={String(item.confidence)} />}
                  </div>
                  {item.evidence && Array.isArray(item.evidence) && item.evidence.length > 0 && (
                    <div className="mt-2"><EvidenceInline evidence={item.evidence} /></div>
                  )}
                </div>
              ))}
            </div>
          ) : (
            <p className="text-gray-700 dark:text-gray-300">{JSON.stringify(data.executive_summary)}</p>
          )}
        </Card>
      )}

      {/* æ ¸å¿ƒå–ç‚¹ - æ–°æ ¼å¼ï¼šæ•°ç»„ [{point, evidence, confidence}] */}
      {data.selling_points && data.selling_points.length > 0 && (
        <Card title="ğŸ’ æ ¸å¿ƒå–ç‚¹" icon={Star} variant="success">
          <div className="space-y-4">
            {renderArrayItems(data.selling_points, (sp, i) => (
              <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-emerald-200 dark:border-emerald-800">
                <div className="flex items-start gap-2 mb-2">
                  <span className="text-lg">âœ¨</span>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <p className="font-medium text-gray-900 dark:text-white">
                        {String(sp.point || sp.title || sp.copywriting || '')}
                      </p>
                      {sp.confidence && <ConfidenceBadge confidence={String(sp.confidence)} />}
                    </div>
                  </div>
                </div>
                {sp.evidence && Array.isArray(sp.evidence) && sp.evidence.length > 0 && (
                  <EvidenceInline evidence={sp.evidence} />
                )}
              </div>
            ))}
          </div>
        </Card>
      )}

      {/* è¥é”€é£é™© - æ–°æ ¼å¼ */}
      {data.marketing_risks && data.marketing_risks.length > 0 && (
        <Card title="âš ï¸ å®¢æœé¢„è­¦ (éœ€å‡†å¤‡è¯æœ¯)" icon={AlertCircle} variant="danger">
          <div className="space-y-3">
            {renderArrayItems(data.marketing_risks, (risk, i) => (
              <div key={i} className="p-3 bg-white dark:bg-gray-800 rounded-lg border border-red-200 dark:border-red-800">
                <div className="flex items-center gap-2 mb-2">
                  <AlertTriangle className="size-4 text-red-500" />
                  <span className="font-medium text-gray-900 dark:text-white">
                    {String(risk.risk || risk.issue || '')}
                  </span>
                  {risk.confidence && <ConfidenceBadge confidence={String(risk.confidence)} />}
                </div>
                {risk.talking_points && (
                  <p className="text-sm text-gray-600 dark:text-gray-400 ml-6 mb-2">
                    <span className="font-medium">åº”å¯¹è¯æœ¯:</span> {String(risk.talking_points)}
                  </p>
                )}
                {risk.evidence && Array.isArray(risk.evidence) && risk.evidence.length > 0 && (
                  <div className="ml-6"><EvidenceInline evidence={risk.evidence} /></div>
                )}
              </div>
            ))}
          </div>
        </Card>
      )}

      {/* ç›®æ ‡å—ä¼— - æ–°æ ¼å¼ï¼šå¯èƒ½æ˜¯æ•°ç»„ */}
      {data.target_audience && (
        <Card title="ğŸ¯ å¹¿å‘ŠæŠ•æ”¾å»ºè®®" icon={Target}>
          {Array.isArray(data.target_audience) ? (
            <div className="space-y-3">
              {renderArrayItems(data.target_audience, (item, i) => (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <div className="flex items-center gap-2 mb-1">
                    <p className="font-medium text-gray-900 dark:text-white">
                      {String(item.segment || item.audience || item.who || '')}
                    </p>
                    {item.confidence && <ConfidenceBadge confidence={String(item.confidence)} />}
                  </div>
                  {item.strategy && <p className="text-sm text-gray-600 dark:text-gray-400">{String(item.strategy)}</p>}
                  {item.evidence && Array.isArray(item.evidence) && <EvidenceInline evidence={item.evidence} />}
                </div>
              ))}
            </div>
          ) : typeof data.target_audience === 'object' ? (
            <>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <h4 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">ç›®æ ‡äººç¾¤</h4>
                  <div className="flex flex-wrap gap-2">
                    {(data.target_audience as { who?: string[] }).who?.map((w: string, i: number) => (
                      <span key={i} className="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded text-xs">
                        {w}
                      </span>
                    ))}
                  </div>
                </div>
                <div>
                  <h4 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">æŠ•æ”¾åœºæ™¯</h4>
                  <div className="flex flex-wrap gap-2">
                    {(data.target_audience as { scenario?: string[] }).scenario?.map((s: string, i: number) => (
                      <span key={i} className="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded text-xs">
                        {s}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
              {(data.target_audience as { strategy?: string }).strategy && (
                <div className="mt-4 p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <h4 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">æŠ•æ”¾ç­–ç•¥</h4>
                  <p className="text-sm text-gray-700 dark:text-gray-300">{(data.target_audience as { strategy?: string }).strategy}</p>
                </div>
              )}
            </>
          ) : (
            <p className="text-gray-700 dark:text-gray-300">{String(data.target_audience)}</p>
          )}
        </Card>
      )}

      {/* ç«å“åˆ†æ - æ–°æ ¼å¼ï¼šå¯èƒ½æ˜¯æ•°ç»„ */}
      {data.competitor_analysis && (
        <Card title="ğŸ” ç«å“åˆ†æ" icon={TrendingUp}>
          {typeof data.competitor_analysis === 'string' ? (
            <p className="text-gray-700 dark:text-gray-300">{data.competitor_analysis}</p>
          ) : Array.isArray(data.competitor_analysis) ? (
            <div className="space-y-3">
              {renderArrayItems(data.competitor_analysis, (item, i) => (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <div className="flex items-center gap-2 mb-1">
                    <p className="text-gray-700 dark:text-gray-300">{String(item.analysis || item.insight || item.point || '')}</p>
                    {item.confidence && <ConfidenceBadge confidence={String(item.confidence)} />}
                  </div>
                  {item.evidence && Array.isArray(item.evidence) && <EvidenceInline evidence={item.evidence} />}
                </div>
              ))}
            </div>
          ) : (
            <p className="text-gray-700 dark:text-gray-300">{JSON.stringify(data.competitor_analysis)}</p>
          )}
        </Card>
      )}

      {/* Listing ä¼˜åŒ–å»ºè®® - æ–°æ ¼å¼ */}
      {data.listing_optimization && data.listing_optimization.length > 0 && (
        <Card title="ğŸ“ Listing ä¼˜åŒ–å»ºè®®" icon={FileText}>
          <div className="space-y-3">
            {renderArrayItems(data.listing_optimization, (opt, i) => {
              // å…¼å®¹å¤šç§å­—æ®µå
              const tag = String(opt.tag || opt.element || '');
              const content = String(opt.content || opt.suggestion || opt.optimization || '');
              const confidence = String(opt.confidence || '');
              const evidence = (opt.evidence || []) as unknown[];
              
              return (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <div className="flex items-center gap-2 mb-2">
                    {tag && (
                      <span className="inline-block px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded text-xs font-medium">
                        {tag}
                      </span>
                    )}
                    {confidence && <ConfidenceBadge confidence={confidence} />}
                  </div>
                  <p className="text-sm text-gray-700 dark:text-gray-300">{content}</p>
                  {evidence.length > 0 && <EvidenceInline evidence={evidence} />}
                </div>
              );
            })}
          </div>
        </Card>
      )}

      {/* å·®è¯„å›å¤æ¨¡æ¿ - æ–°æ ¼å¼ */}
      {data.review_response_templates && data.review_response_templates.length > 0 && (
        <Card title="ğŸ’¬ å·®è¯„å›å¤æ¨¡æ¿" icon={MessageSquare}>
          <div className="space-y-3">
            {renderArrayItems(data.review_response_templates, (tpl, i) => (
              <div key={i} className="p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-xs text-red-600 dark:text-red-400 font-medium">
                    ç—›ç‚¹: {String(tpl.pain_point || tpl.issue || '')}
                  </span>
                  {tpl.confidence && <ConfidenceBadge confidence={String(tpl.confidence)} />}
                </div>
                <p className="text-sm text-gray-700 dark:text-gray-300 italic mb-2">
                  "{String(tpl.response || tpl.template || '')}"
                </p>
                {tpl.evidence && Array.isArray(tpl.evidence) && <EvidenceInline evidence={tpl.evidence} />}
              </div>
            ))}
          </div>
        </Card>
      )}
    </div>
  );
});

// ========== äº§å“ç ”å‘ç‰ˆæ¸²æŸ“å™¨ ==========
const ProductRenderer = memo(function ProductRenderer({ 
  data 
}: { 
  data: ProductReportContent 
}) {
  // å¤„ç† quality_score - å¯èƒ½æ˜¯æ•°å­—æˆ–å¯¹è±¡
  const qualityScore = typeof data.quality_score === 'object' && data.quality_score !== null
    ? (data.quality_score as { score?: number }).score || 0
    : (typeof data.quality_score === 'number' ? data.quality_score : 0);
  
  // è½¬æ¢ä¸ºç™¾åˆ†æ¯”ï¼ˆå¦‚æœæ˜¯10åˆ†åˆ¶ï¼‰
  const scorePercent = qualityScore <= 10 ? qualityScore * 10 : qualityScore;
  
  // è´¨é‡åŸå› 
  const qualityReasons = typeof data.quality_score === 'object' && data.quality_score !== null
    ? (data.quality_score as { reasons?: Array<{ issue?: string; evidence?: unknown[]; confidence?: string }> }).reasons || []
    : [];

  return (
    <div className="space-y-6">
      {/* ç”¨æˆ·ç ”ç©¶æ´å¯Ÿ - æ–°æ ¼å¼ï¼šæ•°ç»„ */}
      {data.user_research && Array.isArray(data.user_research) && data.user_research.length > 0 && (
        <Card title="ğŸ”¬ ç”¨æˆ·ç ”ç©¶æ´å¯Ÿ" icon={Users} variant="info">
          <div className="space-y-4">
            {data.user_research.map((item: { insight?: string; evidence?: unknown[]; confidence?: string }, i: number) => (
              <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-800">
                <div className="flex items-start gap-3">
                  <div className="flex-1">
                    <p className="text-gray-700 dark:text-gray-300 leading-relaxed">
                      {item.insight || ''}
                    </p>
                    <div className="flex items-center gap-2 mt-2">
                      {item.confidence && <ConfidenceBadge confidence={item.confidence} />}
                      {item.evidence && Array.isArray(item.evidence) && item.evidence.length > 0 && (
                        <span className="text-xs text-gray-500">
                          ğŸ“ {item.evidence.length} æ¡è¯æ®
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </Card>
      )}
      
      {/* æ—§æ ¼å¼å…¼å®¹ï¼šuser_research ä¸ºå¯¹è±¡ */}
      {data.user_research && !Array.isArray(data.user_research) && typeof data.user_research === 'object' && (
        <UserProfileCard profile={data.user_research as unknown as Record<string, unknown>} variant="product" />
      )}
      
      {/* è´¨é‡è¯„åˆ† */}
      <Card title="ğŸ“Š äº§å“è´¨é‡è¯„åˆ†" icon={TrendingUp} variant="info">
        <div className="flex items-center gap-4 mb-4">
          <div className="text-4xl font-bold text-emerald-600 dark:text-emerald-400">
            {qualityScore.toFixed(1)}
          </div>
          <div className="flex-1">
            <div className="h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
              <div 
                className={`h-full rounded-full ${
                  scorePercent >= 80 ? 'bg-emerald-500' :
                  scorePercent >= 60 ? 'bg-yellow-500' :
                  scorePercent >= 40 ? 'bg-orange-500' : 'bg-red-500'
                }`}
                style={{ width: `${scorePercent}%` }}
              />
            </div>
            <p className="text-xs text-gray-500 mt-1">
              {scorePercent >= 80 ? 'ä¼˜ç§€' :
               scorePercent >= 60 ? 'è‰¯å¥½' :
               scorePercent >= 40 ? 'éœ€æ”¹è¿›' : 'ä¸¥é‡é—®é¢˜'}
            </p>
          </div>
        </div>
        {/* è´¨é‡é—®é¢˜åŸå›  */}
        {qualityReasons.length > 0 && (
          <div className="space-y-2 pt-3 border-t border-gray-200 dark:border-gray-700">
            <h5 className="text-sm font-medium text-gray-600 dark:text-gray-400">æ‰£åˆ†åŸå› ï¼š</h5>
            {qualityReasons.map((reason, i) => (
              <div key={i} className="flex items-start gap-2 text-sm">
                <span className="text-red-500">â€¢</span>
                <div className="flex-1">
                  <span className="text-gray-700 dark:text-gray-300">{reason.issue || ''}</span>
                  {reason.confidence && <ConfidenceBadge confidence={reason.confidence} />}
                </div>
              </div>
            ))}
          </div>
        )}
      </Card>

      {/* è‡´å‘½ç¼ºé™· - æ–°æ ¼å¼ */}
      {data.critical_bugs && data.critical_bugs.length > 0 && (
        <Card title="ğŸ› è‡´å‘½ç¼ºé™·" icon={AlertTriangle} variant="danger">
          <div className="space-y-4">
            {data.critical_bugs.map((bug, i) => {
              // å…¼å®¹æ–°æ—§æ ¼å¼
              const bugText = (bug as { bug?: string }).bug || (bug as { issue?: string }).issue || '';
              const impactText = (bug as { impact?: string }).impact || '';
              const relatedJtbd = (bug as { related_jtbd?: string }).related_jtbd || '';
              const userSegments = (bug as { user_segments?: string[] }).user_segments || [];
              const usageScenarios = (bug as { usage_scenarios?: string[] }).usage_scenarios || [];
              const evidence = (bug as { evidence?: unknown[] }).evidence || [];
              const confidence = (bug as { confidence?: string }).confidence || '';
              const severity = (bug as { severity?: string }).severity || '';
              const suggestion = (bug as { suggestion?: string }).suggestion || '';
              const rootCause = (bug as { root_cause_guess?: string }).root_cause_guess || '';
              
              return (
                <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-red-200 dark:border-red-800">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="font-semibold text-gray-900 dark:text-white">{bugText}</h4>
                    <div className="flex items-center gap-2">
                      {confidence && <ConfidenceBadge confidence={confidence} />}
                      {severity && <SeverityBadge severity={severity} />}
                    </div>
                  </div>
                  {impactText && (
                    <p className="text-sm text-red-600 dark:text-red-400 mb-2">
                      <span className="font-medium">å½±å“:</span> {impactText}
                    </p>
                  )}
                  {relatedJtbd && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">
                      <span className="font-medium">ç›¸å…³JTBD:</span> {relatedJtbd}
                    </p>
                  )}
                  {userSegments.length > 0 && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">
                      <span className="font-medium">å½±å“äººç¾¤:</span> {userSegments.join('ã€')}
                    </p>
                  )}
                  {usageScenarios.length > 0 && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">
                      <span className="font-medium">ä½¿ç”¨åœºæ™¯:</span> {usageScenarios.join('ã€')}
                    </p>
                  )}
                  {rootCause && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                      <span className="font-medium">å¯èƒ½åŸå› :</span> {rootCause}
                    </p>
                  )}
                  {suggestion && (
                    <p className="text-sm text-emerald-700 dark:text-emerald-400 mb-2">
                      <span className="font-medium">å»ºè®®:</span> {suggestion}
                    </p>
                  )}
                  {evidence.length > 0 && (
                    <EvidenceInline evidence={evidence} />
                  )}
                </div>
              );
            })}
          </div>
        </Card>
      )}

      {/* æœªæ»¡è¶³éœ€æ±‚ - æ–°æ ¼å¼ */}
      {data.unmet_needs && data.unmet_needs.length > 0 && (
        <Card title="ğŸ’¡ æœªæ»¡è¶³éœ€æ±‚ä¸è¿­ä»£æ–¹å‘" icon={Lightbulb} variant="warning">
          <div className="space-y-3">
            {data.unmet_needs.map((need, i) => {
              // å…¼å®¹æ–°æ—§æ ¼å¼
              if (typeof need === 'object' && need !== null) {
                const needText = (need as { need?: string }).need || (need as { feature?: string }).feature || '';
                const reasonText = (need as { rationale?: string }).rationale || (need as { reason?: string }).reason || '';
                const evidence = (need as { evidence?: unknown[] }).evidence || [];
                const confidence = (need as { confidence?: string }).confidence || '';
                
                return (
                  <div key={i} className="p-3 bg-white dark:bg-gray-800 rounded-lg border border-amber-200 dark:border-amber-800">
                    <div className="flex items-center gap-2 mb-1">
                      <Star className="size-4 text-amber-500" />
                      <span className="font-medium text-gray-900 dark:text-white">{needText}</span>
                      {confidence && <ConfidenceBadge confidence={confidence} />}
                    </div>
                    {reasonText && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 ml-6 mb-2">{reasonText}</p>
                    )}
                    {evidence.length > 0 && (
                      <div className="ml-6">
                        <EvidenceInline evidence={evidence} />
                      </div>
                    )}
                  </div>
                );
              }
              return <ListItem key={i} icon={Star} variant="warning">{String(need)}</ListItem>;
            })}
          </div>
        </Card>
      )}

      {/* åœºæ™¯å·®å¼‚ */}
      {data.usage_context_gap && (
        <Card title="ğŸ” ä½¿ç”¨åœºæ™¯å·®å¼‚åˆ†æ" icon={Target}>
          {typeof data.usage_context_gap === 'string' ? (
            <p className="text-gray-700 dark:text-gray-300 leading-relaxed">
              {data.usage_context_gap}
            </p>
          ) : Array.isArray(data.usage_context_gap) ? (
            <div className="space-y-3">
              {data.usage_context_gap.map((gap: { gap?: string; evidence?: unknown[]; confidence?: string }, i: number) => (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <p className="text-gray-700 dark:text-gray-300">{gap.gap || JSON.stringify(gap)}</p>
                  {gap.confidence && <ConfidenceBadge confidence={gap.confidence} />}
                </div>
              ))}
            </div>
          ) : (
            <p className="text-gray-700 dark:text-gray-300 leading-relaxed">
              {JSON.stringify(data.usage_context_gap)}
            </p>
          )}
        </Card>
      )}

      {/* è¿­ä»£å»ºè®® - æ–°æ ¼å¼ä¸ºæ•°ç»„ */}
      {data.roadmap_suggestion && (
        <Card title="ğŸš€ ä¸‹ç‰ˆæœ¬å‡çº§æ–¹å‘" icon={TrendingUp} variant="success">
          {typeof data.roadmap_suggestion === 'string' ? (
            <p className="text-gray-700 dark:text-gray-300 leading-relaxed font-medium">
              {data.roadmap_suggestion}
            </p>
          ) : Array.isArray(data.roadmap_suggestion) ? (
            <div className="space-y-4">
              {data.roadmap_suggestion.map((item: { suggestion?: string; impact?: string; evidence?: unknown[]; confidence?: string; priority?: string }, i: number) => (
                <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-emerald-200 dark:border-emerald-800">
                  <div className="flex items-start justify-between mb-2">
                    <p className="font-medium text-gray-900 dark:text-white">{item.suggestion || ''}</p>
                    <div className="flex items-center gap-2">
                      {item.priority && (
                        <span className={`px-2 py-0.5 text-xs font-medium rounded ${
                          item.priority === 'P0' ? 'bg-red-100 text-red-800' :
                          item.priority === 'P1' ? 'bg-orange-100 text-orange-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>{item.priority}</span>
                      )}
                      {item.confidence && <ConfidenceBadge confidence={item.confidence} />}
                    </div>
                  </div>
                  {item.impact && (
                    <p className="text-sm text-emerald-700 dark:text-emerald-400 mb-2">
                      <span className="font-medium">é¢„æœŸå½±å“:</span> {item.impact}
                    </p>
                  )}
                  {item.evidence && Array.isArray(item.evidence) && item.evidence.length > 0 && (
                    <EvidenceInline evidence={item.evidence} />
                  )}
                </div>
              ))}
            </div>
          ) : (
            <p className="text-gray-700 dark:text-gray-300 leading-relaxed font-medium">
              {JSON.stringify(data.roadmap_suggestion)}
            </p>
          )}
        </Card>
      )}

      {/* æ˜“ç”¨æ€§é—®é¢˜ - æ–°æ ¼å¼ */}
      {data.usability_issues && data.usability_issues.length > 0 && (
        <Card title="ğŸ‘¤ æ˜“ç”¨æ€§é—®é¢˜" icon={Users}>
          <div className="space-y-3">
            {data.usability_issues.map((issue, i) => {
              if (typeof issue === 'object' && issue !== null) {
                const issueText = (issue as { issue?: string }).issue || '';
                const userGroup = (issue as { user_group?: string }).user_group || '';
                const suggestion = (issue as { suggestion?: string }).suggestion || '';
                const evidence = (issue as { evidence?: unknown[] }).evidence || [];
                const confidence = (issue as { confidence?: string }).confidence || '';
                
                return (
                  <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                    <div className="flex items-center gap-2 mb-1">
                      <p className="font-medium text-gray-900 dark:text-white">{issueText}</p>
                      {confidence && <ConfidenceBadge confidence={confidence} />}
                    </div>
                    {userGroup && (
                      <p className="text-xs text-gray-500 mb-2">å½±å“äººç¾¤: {userGroup}</p>
                    )}
                    {suggestion && (
                      <p className="text-sm text-emerald-700 dark:text-emerald-400 mb-2">å»ºè®®: {suggestion}</p>
                    )}
                    {evidence.length > 0 && (
                      <EvidenceInline evidence={evidence} />
                    )}
                  </div>
                );
              }
              return (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <p className="text-sm text-gray-700 dark:text-gray-300">{safeRender(issue)}</p>
                </div>
              );
            })}
          </div>
        </Card>
      )}

      {/* è®¾è®¡å»ºè®® - æ–°æ ¼å¼ */}
      {data.design_recommendations && data.design_recommendations.length > 0 && (
        <Card title="ğŸ¨ è®¾è®¡æ”¹è¿›å»ºè®®" icon={Wrench}>
          <div className="space-y-3">
            {data.design_recommendations.map((rec, i) => {
              // å…¼å®¹æ–°æ ¼å¼
              const recText = (rec as { recommendation?: string }).recommendation || (rec as { area?: string }).area || '';
              const impact = (rec as { impact?: string }).impact || (rec as { suggestion?: string }).suggestion || '';
              const evidence = (rec as { evidence?: unknown[] }).evidence || [];
              const confidence = (rec as { confidence?: string }).confidence || '';
              
              return (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <div className="flex items-center gap-2 mb-1">
                    <p className="font-medium text-gray-900 dark:text-white">{recText || JSON.stringify(rec)}</p>
                    {confidence && <ConfidenceBadge confidence={confidence} />}
                  </div>
                  {impact && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">{impact}</p>
                  )}
                  {evidence.length > 0 && (
                    <EvidenceInline evidence={evidence} />
                  )}
                </div>
              );
            })}
          </div>
        </Card>
      )}
    </div>
  );
});

// ========== ä¾›åº”é“¾ç‰ˆæ¸²æŸ“å™¨ ==========
const SupplyChainRenderer = memo(function SupplyChainRenderer({ 
  data 
}: { 
  data: SupplyChainReportContent 
}) {
  return (
    <div className="space-y-6">
      {/* ä½¿ç”¨åœºæ™¯ä¸è´¨é‡éœ€æ±‚ - æ”¾åœ¨æœ€å‰é¢ */}
      {data.usage_context_analysis && (
        <UserProfileCard profile={data.usage_context_analysis as unknown as Record<string, unknown>} variant="supply_chain" />
      )}
      
      {/* è´¨é‡æ¦‚å†µ - æ–°å¢ */}
      {(data as any).quality_summary && (
        <Card title="ğŸ“Š è´¨é‡è¯„ä¼°æ¦‚å†µ" icon={TrendingUp} variant="info">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
              <div className="text-2xl font-bold text-emerald-600">{(data as any).quality_summary.overall_quality_score || 'N/A'}</div>
              <div className="text-xs text-gray-500">è´¨é‡è¯„åˆ†</div>
            </div>
            <div className="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
              <div className="text-2xl font-bold text-red-600">{(data as any).quality_summary.estimated_return_rate || 'N/A'}</div>
              <div className="text-xs text-gray-500">é¢„ä¼°é€€è´§ç‡</div>
            </div>
          </div>
          {(data as any).quality_summary.top_quality_issues && (
            <div className="mt-3">
              <div className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ä¸»è¦è´¨é‡é—®é¢˜:</div>
              <div className="flex flex-wrap gap-2">
                {(data as any).quality_summary.top_quality_issues.map((issue: string, i: number) => (
                  <span key={i} className="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded text-xs">
                    {issue}
                  </span>
                ))}
              </div>
            </div>
          )}
          {(data as any).quality_summary.improvement_priority && (
            <div className="mt-3 p-2 bg-emerald-50 dark:bg-emerald-900/20 rounded text-sm text-emerald-700 dark:text-emerald-400">
              ğŸ’¡ ä¼˜å…ˆæ”¹è¿›æ–¹å‘: {(data as any).quality_summary.improvement_priority}
            </div>
          )}
        </Card>
      )}

      {/* æè´¨ç¼ºé™· - å¢å¼ºç‰ˆ */}
      {data.material_defects && (
        <Card title="ğŸ”§ æè´¨åšå·¥é—®é¢˜" icon={Wrench} variant="danger">
          <div className="space-y-4">
            {(() => {
              // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šå¯¹è±¡æ ¼å¼ï¼ˆåŒ…å«issuesæ•°ç»„ï¼‰å’Œæ•°ç»„æ ¼å¼
              const defects = (data.material_defects as any).issues || 
                            (Array.isArray(data.material_defects) ? data.material_defects : []);
              
              if (defects.length === 0) return null;
              
              return defects.map((defect: any, i: number) => {
                if (typeof defect === 'object' && defect !== null) {
                  const defectObj = defect as any;
                  // æ”¯æŒæ–°æ ¼å¼ï¼ˆissue/impactï¼‰å’Œæ—§æ ¼å¼ï¼ˆpart/problemï¼‰
                  const issue = defectObj.issue || defectObj.problem || '';
                  const impact = defectObj.impact || defectObj.root_cause_hypothesis || '';
                  const frequency = safeRender(defectObj.frequency);
                  
                  return (
                    <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-red-200 dark:border-red-800">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2 flex-1">
                          <span className="font-semibold text-gray-900 dark:text-white">{issue || safeRender(defectObj.part)}</span>
                          {frequency && (
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              frequency === 'High' 
                                ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
                                : frequency === 'Medium'
                                ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400'
                                : 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400'
                            }`}>
                              {frequency}
                            </span>
                          )}
                          <ConfidenceBadge confidence={defectObj.confidence} />
                        </div>
                      </div>
                      {impact && (
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          <span className="font-medium">å½±å“åˆ†æ:</span> {impact}
                        </p>
                      )}
                      {defectObj.suggested_fix && (
                        <p className="text-sm text-emerald-600 dark:text-emerald-400 mb-1">
                          <span className="font-medium">å»ºè®®ä¿®å¤:</span> {defectObj.suggested_fix}
                        </p>
                      )}
                      {defectObj.supplier_action && (
                        <p className="text-sm text-blue-600 dark:text-blue-400">
                          <span className="font-medium">ä¾›åº”å•†æ•´æ”¹:</span> {defectObj.supplier_action}
                        </p>
                      )}
                      {defectObj.evidence && (
                        <div className="mt-2">
                          <EvidenceInline evidence={defectObj.evidence} />
                        </div>
                      )}
                    </div>
                  );
                }
                return (
                  <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                    <p className="text-sm text-gray-700 dark:text-gray-300">{safeRender(defect)}</p>
                  </div>
                );
              });
            })()}
          </div>
        </Card>
      )}

      {/* åŒ…è£…é—®é¢˜ - å…¼å®¹æ–°æ—§æ ¼å¼ */}
      {data.packaging_issues && (
        <Card 
          title="ğŸ“¦ åŒ…è£…ä¸ç‰©æµ" 
          icon={Package} 
          variant={(data.packaging_issues.is_damaged || (data.packaging_issues as any).has_damage_reports || ((data.packaging_issues as any).issues && (data.packaging_issues as any).issues.length > 0)) ? 'danger' : 'success'}
        >
          <div className="space-y-3">
            {/* æ–°æ ¼å¼ï¼šissues æ•°ç»„ */}
            {((data.packaging_issues as any).issues && Array.isArray((data.packaging_issues as any).issues)) ? (
              <div className="space-y-3">
                {(data.packaging_issues as any).issues.map((issueItem: any, idx: number) => (
                  <div key={idx} className="p-3 bg-white dark:bg-gray-800 rounded-lg border border-orange-200 dark:border-orange-800">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="font-medium text-gray-900 dark:text-white">{issueItem.issue}</span>
                      <ConfidenceBadge confidence={issueItem.confidence} />
                    </div>
                    {issueItem.impact && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <span className="font-medium">å½±å“åˆ†æ:</span> {issueItem.impact}
                      </p>
                    )}
                    {issueItem.evidence && (
                      <div className="mt-2">
                        <EvidenceInline evidence={issueItem.evidence} />
                      </div>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              /* æ—§æ ¼å¼ï¼šå•ä¸ªå¯¹è±¡ */
              <>
                <div className="flex items-center gap-2">
                  {(data.packaging_issues.is_damaged || (data.packaging_issues as any).has_damage_reports) ? (
                    <AlertCircle className="size-5 text-red-500" />
                  ) : (
                    <CheckCircle2 className="size-5 text-emerald-500" />
                  )}
                  <span className={(data.packaging_issues.is_damaged || (data.packaging_issues as any).has_damage_reports) ? 'text-red-700 dark:text-red-400' : 'text-emerald-700 dark:text-emerald-400'}>
                    {(data.packaging_issues.is_damaged || (data.packaging_issues as any).has_damage_reports) ? 'å­˜åœ¨åŒ…è£…ç ´æŸé—®é¢˜' : 'åŒ…è£…çŠ¶å†µè‰¯å¥½'}
                  </span>
                  <ConfidenceBadge confidence={(data.packaging_issues as any).confidence} />
                </div>
                {/* å…¼å®¹æ–°æ ¼å¼ damage_types */}
                {((data.packaging_issues as any).damage_types || data.packaging_issues.details) && (
                  <p className="text-sm text-gray-700 dark:text-gray-300">
                    <span className="font-medium">è¯¦æƒ…:</span> {
                      Array.isArray((data.packaging_issues as any).damage_types) 
                        ? (data.packaging_issues as any).damage_types.join('ã€') 
                        : data.packaging_issues.details
                    }
                  </p>
                )}
                {/* å…¼å®¹æ–°æ ¼å¼ improvement_suggestions */}
                {((data.packaging_issues as any).improvement_suggestions || data.packaging_issues.improvement) && (
                  <p className="text-sm text-emerald-700 dark:text-emerald-400">
                    <span className="font-medium">æ”¹è¿›å»ºè®®:</span> {
                      Array.isArray((data.packaging_issues as any).improvement_suggestions) 
                        ? (data.packaging_issues as any).improvement_suggestions.join('ã€') 
                        : data.packaging_issues.improvement
                    }
                  </p>
                )}
                {/* æ˜¾ç¤ºè¯æ® */}
                {(data.packaging_issues as any).evidence && (
                  <EvidenceInline evidence={(data.packaging_issues as any).evidence} />
                )}
              </>
            )}
          </div>
        </Card>
      )}

      {/* æ¼å‘é…ä»¶ */}
      {data.missing_parts && data.missing_parts.length > 0 && (
        <Card title="ğŸ“‹ å¸¸è§æ¼å‘é…ä»¶" icon={AlertCircle} variant="warning">
          <div className="space-y-3">
            {data.missing_parts.map((part, i) => {
              // å¤„ç†å¯¹è±¡æˆ–å­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼
              if (typeof part === 'object' && part !== null) {
                const partObj = part as any;
                const partText = partObj.part || JSON.stringify(part);
                return (
                  <div key={i} className="p-3 bg-white dark:bg-gray-800 rounded-lg border border-orange-200 dark:border-orange-800">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="font-medium text-gray-900 dark:text-white">{partText}</span>
                      <ConfidenceBadge confidence={partObj.confidence} />
                    </div>
                    {partObj.impact_analysis && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <span className="font-medium">å½±å“åˆ†æ:</span> {partObj.impact_analysis}
                      </p>
                    )}
                    {partObj.evidence && (
                      <div className="mt-2">
                        <EvidenceInline evidence={partObj.evidence} />
                      </div>
                    )}
                  </div>
                );
              }
              return (
                <div key={i} className="p-2 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                  <ListItem variant="warning">{String(part)}</ListItem>
                </div>
              );
            })}
          </div>
        </Card>
      )}

      {/* QC æ£€æŸ¥æ¸…å• - å¢å¼ºç‰ˆ */}
      {data.qc_checklist && data.qc_checklist.length > 0 && (
        <Card title="âœ… å‡ºè´§å‰ QC æ£€æŸ¥æ¸…å•" icon={Shield} variant="info">
          <div className="space-y-3">
            {data.qc_checklist.map((item, i) => {
              if (typeof item === 'object' && item !== null) {
                const itemObj = item as any;
                // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šæ–°æ ¼å¼ï¼ˆissue/suggestionï¼‰å’Œæ—§æ ¼å¼ï¼ˆitem/check_methodï¼‰
                const issue = itemObj.issue || itemObj.item || '';
                const suggestion = itemObj.suggestion || itemObj.acceptance_criteria || '';
                const priority = itemObj.priority || '';
                
                return (
                  <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-800">
                    <div className="flex items-start justify-between mb-2">
                      <div className="flex items-start gap-2 flex-1">
                        <span className="flex items-center justify-center w-6 h-6 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-xs font-bold flex-shrink-0 mt-0.5">
                          {i + 1}
                        </span>
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="font-medium text-gray-900 dark:text-white">{issue}</span>
                            {priority && (
                              <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                priority === 'Critical' || priority === 'High' 
                                  ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
                                  : priority === 'Medium'
                                  ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400'
                                  : 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400'
                              }`}>
                                {priority}
                              </span>
                            )}
                            <ConfidenceBadge confidence={itemObj.confidence} />
                          </div>
                          {suggestion && (
                            <p className="text-sm text-emerald-700 dark:text-emerald-400 mt-1">
                              <span className="font-medium">å»ºè®®:</span> {suggestion}
                            </p>
                          )}
                          {itemObj.check_method && !suggestion && (
                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                              <span className="font-medium">æ£€æŸ¥æ–¹æ³•:</span> {itemObj.check_method}
                            </p>
                          )}
                          {itemObj.related_complaints && (
                            <p className="text-xs text-gray-500 mt-1">
                              ç›¸å…³æŠ•è¯‰: {itemObj.related_complaints}æ¡
                            </p>
                          )}
                        </div>
                      </div>
                    </div>
                    {/* æ˜¾ç¤ºè¯æ® */}
                    {itemObj.evidence && (
                      <div className="mt-2">
                        <EvidenceInline evidence={itemObj.evidence} />
                      </div>
                    )}
                  </div>
                );
              }
              return (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <p className="text-sm text-gray-700 dark:text-gray-300">{safeRender(item)}</p>
                </div>
              );
            })}
          </div>
        </Card>
      )}

      {/* ä¾›åº”å•†é—®é¢˜ - å¢å¼ºç‰ˆ */}
      {data.supplier_issues && data.supplier_issues.length > 0 && (
        <Card title="ğŸ­ ä¾›åº”å•†é—®é¢˜" icon={Package}>
          <div className="space-y-3">
            {data.supplier_issues.map((issue, i) => {
              if (typeof issue === 'object' && issue !== null) {
                const issueObj = issue as any;
                return (
                  <div key={i} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2 flex-1">
                        <span className="font-medium text-gray-900 dark:text-white">
                          {safeRender(issueObj.issue || issueObj.component)}
                        </span>
                        {issueObj.severity && (
                          <SeverityBadge severity={issueObj.severity} />
                        )}
                        <ConfidenceBadge confidence={issueObj.confidence} />
                      </div>
                    </div>
                    {issueObj.impact_analysis && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <span className="font-medium">å½±å“åˆ†æ:</span> {issueObj.impact_analysis}
                      </p>
                    )}
                    {issueObj.action || issueObj.recommended_action ? (
                      <p className="text-sm text-emerald-700 dark:text-emerald-400 mb-1">
                        <span className="font-medium">å»ºè®®æªæ–½:</span> {safeRender(issueObj.action || issueObj.recommended_action)}
                      </p>
                    ) : null}
                    {issueObj.timeline && (
                      <p className="text-sm text-blue-600 dark:text-blue-400">
                        <span className="font-medium">æ•´æ”¹æ—¶é—´:</span> {issueObj.timeline}
                      </p>
                    )}
                    {issueObj.evidence && (
                      <div className="mt-2">
                        <EvidenceInline evidence={issueObj.evidence} />
                      </div>
                    )}
                  </div>
                );
              }
              return (
                <div key={i} className="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <p className="text-sm text-gray-700 dark:text-gray-300">{safeRender(issue)}</p>
                </div>
              );
            })}
          </div>
        </Card>
      )}

      {/* é€€è´§åŸå›  - å¢å¼ºç‰ˆ */}
      {data.return_rate_factors && data.return_rate_factors.length > 0 && (
        <Card title="ğŸ“‰ ä¸»è¦é€€è´§åŸå› " icon={TrendingDown}>
          <div className="space-y-3">
            {data.return_rate_factors.map((factor, i) => {
              if (typeof factor === 'object' && factor !== null) {
                const factorObj = factor as any;
                // æ”¯æŒæ–°æ ¼å¼ï¼ˆfactor/impact_analysisï¼‰å’Œæ—§æ ¼å¼ï¼ˆreason/percentageï¼‰
                const reason = factorObj.factor || factorObj.reason || '';
                return (
                  <div key={i} className="p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2 flex-1">
                        <span className="font-medium text-gray-900 dark:text-white">{safeRender(reason)}</span>
                        <ConfidenceBadge confidence={factorObj.confidence} />
                      </div>
                      {(factorObj.percentage || factorObj.estimated_percentage) && (
                        <span className="text-sm font-medium text-red-600 dark:text-red-400">
                          {safeRender(factorObj.percentage || factorObj.estimated_percentage)}
                        </span>
                      )}
                    </div>
                    {factorObj.impact_analysis && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <span className="font-medium">å½±å“åˆ†æ:</span> {factorObj.impact_analysis}
                      </p>
                    )}
                    {factorObj.preventable !== undefined && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">
                        <span className="font-medium">å¯é¢„é˜²:</span> {factorObj.preventable ? 'æ˜¯' : 'å¦'}
                      </p>
                    )}
                    {(factorObj.solution || factorObj.prevention_measure) && (
                      <p className="text-sm text-emerald-700 dark:text-emerald-400 mb-1">
                        <span className="font-medium">é¢„é˜²æªæ–½:</span> {safeRender(factorObj.solution || factorObj.prevention_measure)}
                      </p>
                    )}
                    {factorObj.cost_of_inaction && (
                      <p className="text-sm text-red-600 dark:text-red-400">
                        <span className="font-medium">ä¸è¡ŒåŠ¨çš„æˆæœ¬:</span> {factorObj.cost_of_inaction}
                      </p>
                    )}
                    {factorObj.evidence && (
                      <div className="mt-2">
                        <EvidenceInline evidence={factorObj.evidence} />
                      </div>
                    )}
                  </div>
                );
              }
              return (
                <div key={i} className="p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                  <p className="text-sm text-gray-700 dark:text-gray-300">{safeRender(factor)}</p>
                </div>
              );
            })}
          </div>
        </Card>
      )}

      {/* ç»„è£…ç¼ºé™· */}
      {data.assembly_defects && data.assembly_defects.length > 0 && (
        <Card title="ğŸ”© ç»„è£…é—®é¢˜" icon={Wrench}>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-gray-200 dark:border-gray-700">
                  <th className="text-left py-2 text-gray-600 dark:text-gray-400">ç¼ºé™·</th>
                  <th className="text-left py-2 text-gray-600 dark:text-gray-400">é¢‘ç‡</th>
                  <th className="text-left py-2 text-gray-600 dark:text-gray-400">å·¥ä½</th>
                </tr>
              </thead>
              <tbody>
                {data.assembly_defects.map((defect, i) => {
                  if (typeof defect === 'object' && defect !== null) {
                    const defectObj = defect as { defect?: string; frequency?: string; station?: string; source_tag?: string };
                    return (
                      <tr key={i} className="border-b border-gray-100 dark:border-gray-800">
                        <td className="py-2 text-gray-900 dark:text-white">{safeRender(defectObj.defect)}</td>
                        <td className="py-2 text-gray-700 dark:text-gray-300">{safeRender(defectObj.frequency)}</td>
                        <td className="py-2 text-gray-700 dark:text-gray-300">{safeRender(defectObj.station)}</td>
                      </tr>
                    );
                  }
                  return (
                    <tr key={i} className="border-b border-gray-100 dark:border-gray-800">
                      <td colSpan={3} className="py-2 text-gray-700 dark:text-gray-300">{safeRender(defect)}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}
    </div>
  );
});

// ========== ä¸»æ¸²æŸ“å™¨ ==========
export const JsonReportRenderer = memo(function JsonReportRenderer({
  content,
  reportType,
  analysisData,
  asin,
  onSectionsChange,
  onDrawerStateChange
}: JsonReportRendererProps) {
  const parsedContent = useMemo(() => safeParseJson(content), [content]);
  const config = REPORT_TYPE_CONFIG[reportType];
  
  // æ”¶é›†æ‰€æœ‰æ¿å—æ ‡é¢˜
  const [sections, setSections] = useState<Array<{ id: string; title: string; level: number }>>([]);
  
  // æ³¨å†Œæ¿å—çš„å‡½æ•°ï¼ˆä½¿ç”¨ ref é¿å…é‡å¤æ³¨å†Œï¼‰
  const sectionsRef = useRef<Map<string, { id: string; title: string; level: number }>>(new Map());
  const updateTimerRef = useRef<number | null>(null);
  
  const registerSection = useCallback((id: string, title: string, level: number = 0) => {
    const existing = sectionsRef.current.get(id);
    // å¦‚æœå†…å®¹ç›¸åŒï¼Œä¸æ›´æ–°
    if (existing && existing.title === title && existing.level === level) {
      return;
    }
    
    sectionsRef.current.set(id, { id, title, level });
    
    // é˜²æŠ–æ›´æ–°ï¼Œé¿å…é¢‘ç¹æ¸²æŸ“
    if (updateTimerRef.current) {
      clearTimeout(updateTimerRef.current);
    }
    
    updateTimerRef.current = window.setTimeout(() => {
      const sectionsArray = Array.from(sectionsRef.current.values());
      // ç¡®ä¿"æ•°æ®æ¦‚è§ˆ"å§‹ç»ˆæ’åœ¨ç¬¬ä¸€ä½
      const dataOverview = sectionsArray.find(s => s.id === 'data-overview');
      const otherSections = sectionsArray.filter(s => s.id !== 'data-overview');
      // å¦‚æœå­˜åœ¨"æ•°æ®æ¦‚è§ˆ"ï¼Œæ”¾åœ¨ç¬¬ä¸€ä½ï¼›å…¶ä»–é¡¹ä¿æŒåŸé¡ºåº
      const sortedSections = dataOverview 
        ? [dataOverview, ...otherSections]
        : sectionsArray;
      setSections(sortedSections);
      updateTimerRef.current = null;
    }, 100);
  }, []);
  
  // å½“å†…å®¹å˜åŒ–æ—¶ï¼Œæ¸…ç©º sections
  useEffect(() => {
    sectionsRef.current.clear();
    setSections([]);
    if (updateTimerRef.current) {
      clearTimeout(updateTimerRef.current);
      updateTimerRef.current = null;
    }
  }, [content]);
  
  // å½“ sections å˜åŒ–æ—¶ï¼Œé€šçŸ¥çˆ¶ç»„ä»¶
  useEffect(() => {
    if (onSectionsChange && sections.length > 0) {
      onSectionsChange(sections);
    }
  }, [sections, onSectionsChange]);
  
  // æ¸…ç†å®šæ—¶å™¨
  useEffect(() => {
    return () => {
      if (updateTimerRef.current) {
        clearTimeout(updateTimerRef.current);
      }
    };
  }, []);
  
  // è¯æ®æŠ½å±‰çŠ¶æ€
  const [evidenceDrawer, setEvidenceDrawer] = useState<{
    isOpen: boolean;
    title: string;
    evidence: EvidenceSample[];
    totalCount: number;
    sourceType: 'context' | 'insight';
    category: string;
  }>({
    isOpen: false,
    title: '',
    evidence: [],
    totalCount: 0,
    sourceType: 'insight',
    category: ''
  });
  
  // è¯„è®ºä¾§è¾¹æ çŠ¶æ€
  const [reviewSidebar, setReviewSidebar] = useState<{
    isOpen: boolean;
    dimensionKey: string;
    dimensionLabel: string;
    tagLabel: string;
    totalCount: number;
  }>({
    isOpen: false,
    dimensionKey: '',
    dimensionLabel: '',
    tagLabel: '',
    totalCount: 0
  });
  
  // æ‰“å¼€è¯æ®æŠ½å±‰çš„å‡½æ•°
  const openEvidence = useCallback((title: string, sourceTag: string, sourceType: 'context' | 'insight', category: string) => {
    if (!analysisData) return;
    
    // æ ¹æ® sourceType å’Œ category æŸ¥æ‰¾å¯¹åº”çš„æ•°æ®
    let dataArray: ChartDataItem[] = [];
    
    if (sourceType === 'context' && analysisData.context) {
      dataArray = (analysisData.context as unknown as Record<string, ChartDataItem[]>)[category] || [];
    } else if (sourceType === 'insight' && analysisData.insight) {
      dataArray = (analysisData.insight as unknown as Record<string, ChartDataItem[]>)[category] || [];
    }
    
    // æŸ¥æ‰¾åŒ¹é… sourceTag çš„æ•°æ®é¡¹
    const matchedItem = dataArray.find(item => item.name === sourceTag);
    
    if (matchedItem) {
      setEvidenceDrawer({
        isOpen: true,
        title,
        evidence: matchedItem.evidence || [],
        totalCount: matchedItem.value,
        sourceType,
        category
      });
    }
  }, [analysisData]);
  
  // å…³é—­è¯æ®æŠ½å±‰
  const closeEvidence = useCallback(() => {
    setEvidenceDrawer(prev => ({ ...prev, isOpen: false }));
  }, []);
  
  // æ‰“å¼€è¯„è®ºä¾§è¾¹æ 
  const openReviewSidebar = useCallback((dimensionKey: string, dimensionLabel: string, tagLabel: string, totalCount: number) => {
    setReviewSidebar({
      isOpen: true,
      dimensionKey,
      dimensionLabel,
      tagLabel,
      totalCount
    });
  }, []);
  
  // å…³é—­è¯„è®ºä¾§è¾¹æ 
  const closeReviewSidebar = useCallback(() => {
    setReviewSidebar(prev => ({ ...prev, isOpen: false }));
  }, []);
  
  // å½“æŠ½å±‰çŠ¶æ€å˜åŒ–æ—¶ï¼Œé€šçŸ¥çˆ¶ç»„ä»¶
  useEffect(() => {
    if (onDrawerStateChange) {
      onDrawerStateChange(evidenceDrawer.isOpen || reviewSidebar.isOpen);
    }
  }, [evidenceDrawer.isOpen, reviewSidebar.isOpen, onDrawerStateChange]);

  if (!parsedContent) {
    return (
      <div className="p-6 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
        <div className="flex items-center gap-2 text-amber-700 dark:text-amber-400 mb-2">
          <AlertCircle className="size-5" />
          <span className="font-medium">æŠ¥å‘Šè§£æå¤±è´¥</span>
        </div>
        <p className="text-sm text-gray-700 dark:text-gray-300">
          æ— æ³•è§£ææŠ¥å‘Šå†…å®¹ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬:
        </p>
        <pre className="mt-3 p-3 bg-gray-100 dark:bg-gray-800 rounded text-xs overflow-auto max-h-96">
          {content}
        </pre>
      </div>
    );
  }

  // å¤„ç†ä» StatsDashboard æŸ¥çœ‹è¯æ®
  const handleViewEvidenceFromDashboard = useCallback((title: string, evidence: EvidenceSample[], totalCount: number) => {
    setEvidenceDrawer({
      isOpen: true,
      title,
      evidence,
      totalCount,
      sourceType: 'insight',
      category: ''
    });
  }, []);

  return (
    <TocContext.Provider value={{ registerSection }}>
      <EvidenceContext.Provider value={{ analysisData: analysisData || null, asin, openEvidence }}>
        <div className="json-report-container">
        {/* åŸºç¡€ç»Ÿè®¡çœ‹æ¿ï¼ˆç¡¬æ•°æ®ï¼‰- åœ¨ AI åˆ†æä¹‹å‰å±•ç¤º */}
        {analysisData && (
          <StatsDashboard 
            analysisData={analysisData}
            onViewEvidence={handleViewEvidenceFromDashboard}
            onViewReviews={asin ? openReviewSidebar : undefined}
          />
        )}
        
        {/* æŠ¥å‘Šç±»å‹æ ‡é¢˜ */}
        <div className="mb-6 p-4 bg-gradient-to-r from-emerald-50 to-blue-50 dark:from-emerald-900/20 dark:to-blue-900/20 rounded-lg border border-emerald-200 dark:border-emerald-800">
          <div className="flex items-center gap-3">
            <span className="text-3xl">{config.icon}</span>
            <div>
              <h2 className="text-lg font-bold text-gray-900 dark:text-white">{config.label}</h2>
              <p className="text-sm text-gray-600 dark:text-gray-400">{config.description}</p>
            </div>
          </div>
          {analysisData && (
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center gap-1">
              <Search className="size-3" />
              ç‚¹å‡»å¸¦æœ‰ ğŸ” çš„è§‚ç‚¹å¯æŸ¥çœ‹åŸå§‹è¯„è®ºè¯æ®
            </p>
          )}
        </div>

        {/* æ ¹æ®ç±»å‹æ¸²æŸ“ä¸åŒå†…å®¹ */}
        {reportType === 'comprehensive' && (
          <ComprehensiveRenderer data={parsedContent as ComprehensiveReportContent} />
        )}
        {reportType === 'operations' && (
          <OperationsRenderer data={parsedContent as OperationsReportContent} />
        )}
        {reportType === 'product' && (
          <ProductRenderer data={parsedContent as ProductReportContent} />
        )}
        {reportType === 'supply_chain' && (
          <SupplyChainRenderer data={parsedContent as SupplyChainReportContent} />
        )}
      </div>
      
      {/* è¯æ®æº¯æºæŠ½å±‰ */}
      <EvidenceDrawer
        isOpen={evidenceDrawer.isOpen}
        onClose={closeEvidence}
        title={evidenceDrawer.title}
        totalCount={evidenceDrawer.totalCount}
        evidence={evidenceDrawer.evidence}
        sourceType={evidenceDrawer.sourceType}
        sourceCategory={evidenceDrawer.category}
        asin={asin}
      />
      
      {/* è¯„è®ºä¾§è¾¹æ  - æ˜¾ç¤ºå®Œæ•´è¯„è®ºï¼ˆåŒ…å«åŸæ–‡å’Œè¯‘æ–‡ï¼‰ */}
      {asin && (
        <CompareReviewSidebar
          isOpen={reviewSidebar.isOpen}
          onClose={closeReviewSidebar}
          productAsin={asin}
          dimension={reviewSidebar.dimensionLabel}
          dimensionKey={reviewSidebar.dimensionKey}
          tagLabel={reviewSidebar.tagLabel}
          totalCount={reviewSidebar.totalCount}
        />
      )}
      </EvidenceContext.Provider>
    </TocContext.Provider>
  );
});

export default JsonReportRenderer;

